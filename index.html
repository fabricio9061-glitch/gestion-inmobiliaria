<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Clientes Inmobiliarios</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f2d26e 0%, #c2943b 100%);
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .agent-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .agent-info strong { display: block; }
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
            margin-left: 5px;
        }
        .sync-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
        }
        .sync-online { background: #28a745; }
        .sync-offline { background: #dc3545; }
        .sync-syncing { background: #ffc107; color: #333; }
        /* Menu Hamburguesa */
        .menu-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .hamburger-btn {
            background: white;
            color: #b6802d;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: transform 0.2s;
        }
        .hamburger-btn:hover { transform: scale(1.05); }
        .hamburger-btn span {
            display: block;
            width: 22px;
            height: 3px;
            background: #b6802d;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .hamburger-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hamburger-btn.active span:nth-child(2) { opacity: 0; }
        .hamburger-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 200px;
            overflow: hidden;
            z-index: 1001;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.95em;
            color: #333;
            transition: background 0.2s;
            border-bottom: 1px solid #eee;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f8f9fa; }
        .dropdown-item.danger { color: #dc3545; }
        .dropdown-item.danger:hover { background: #f8d7da; }
        .dropdown-item i { margin-right: 10px; }
        .content { display: grid; grid-template-columns: 1fr 380px; gap: 0; }
        .form-section { padding: 30px; border-right: 2px solid #e0e0e0; }
        .stats-section { padding: 30px; background: #f8f9fa; }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #d2a94d;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stats-card h3 {
            color: #c2943b;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #c2943b;
            padding-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: 500; color: #555; }
        .stat-value { font-weight: 700; color: #b6802d; font-size: 1.1em; }
        .clients-list { margin-top: 30px; }
        .client-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #d2a94d;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .client-card:hover { transform: translateX(5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .client-name { font-size: 1.2em; font-weight: 700; color: #333; }
        .client-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn-small {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-follow { background: #d2a94d; color: white; }
        .btn-call { background: #17a2b8; color: white; }
        .client-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }
        .info-item { color: #666; }
        .info-label { font-weight: 600; color: #333; }
        .stage-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }
        .type-badge, .agent-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 10px;
        }
        .type-venta { background: #4caf50; color: white; }
        .type-alquiler { background: #2196f3; color: white; }
        .agent-badge { background: #6c757d; color: white; font-size: 0.75em; }
        .stage-inicial { background: #f2d26e; color: #5a4a1f; }
        .stage-respuesta { background: #e2bd5d; color: #4a3d15; }
        .stage-pretasacion { background: #d2a94d; color: #3a2f0f; }
        .stage-tasacion { background: #c2943b; color: #2a2109; }
        .stage-exclusiva { background: #b6802d; color: #1f1805; }
        .stage-publicada { background: #9a6b24; color: #ffffff; }
        .stage-vendida { background: #7a5619; color: #ffffff; }
        .stage-archivada { background: #6c757d; color: #ffffff; }
        .stage-pendiente { background: #ffc107; color: #5a4a1f; }
        .stage-seguimiento { background: #17a2b8; color: #ffffff; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d2a94d;
        }
        .modal-header h2 { color: #b6802d; margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .stage-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .stage-title { font-size: 1.3em; font-weight: 700; color: #b6802d; margin-bottom: 15px; }
        .radio-group { display: flex; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; }
        .radio-item input[type="radio"] { width: 20px; height: 20px; margin-right: 8px; cursor: pointer; }
        .radio-item label { cursor: pointer; font-weight: 500; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 8px; cursor: pointer; }
        .checkbox-item label { cursor: pointer; font-weight: 500; }
        .total-calls {
            background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }
        .total-calls-number { font-size: 2.5em; font-weight: 700; margin: 5px 0; }
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 15px; font-weight: 600; }
        .alert-warning { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 2px solid #17a2b8; }
        .timestamp-display {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #1565c0;
        }
        .save-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            animation: fadeInOut 2s;
        }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }
        .call-history {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .call-history h4 { color: #1565c0; margin-bottom: 10px; }
        .call-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .call-item .delete-call {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        .login-box h2 {
            color: #b6802d;
            text-align: center;
            margin-bottom: 30px;
        }
        .login-box .btn {
            width: 100%;
            margin-top: 10px;
        }
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .login-tab.active {
            color: #b6802d;
            border-bottom-color: #b6802d;
        }
        .login-tab:hover { color: #b6802d; }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        .tab.active { background: #d2a94d; color: white; }
        .tab:hover { background: #c2943b; color: white; }
        .filter-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .filter-section select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .client-tabs {
            display: flex;
            gap: 10px;
        }
        .client-tab {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .client-tab.active {
            background: #d2a94d;
            color: white;
        }
        .client-tab:hover {
            background: #c2943b;
            color: white;
        }
        .archived-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .note-container {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .note-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .note-text.expanded {
            display: block;
            -webkit-line-clamp: unset;
        }
        .ver-mas-btn {
            background: none;
            border: none;
            color: #b6802d;
            cursor: pointer;
            font-weight: 600;
            padding: 5px 0;
            font-size: 0.85em;
        }
        .ver-mas-btn:hover {
            text-decoration: underline;
        }
        .btn-restore {
            background: #28a745;
            color: white;
        }
        .stats-filter-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stats-filter-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #d2a94d;
            background: white;
            color: #b6802d;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .stats-filter-btn.active {
            background: #d2a94d;
            color: white;
        }
        .stats-filter-btn:hover {
            background: #f2d26e;
        }
        .top-agent {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .top-agent.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%);
            font-weight: bold;
        }
        .top-agent.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            font-weight: bold;
        }
        .top-agent.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%);
            color: white;
            font-weight: bold;
        }
        .top-position {
            font-size: 1.5em;
            margin-right: 12px;
            min-width: 35px;
            text-align: center;
        }
        .top-info {
            flex: 1;
        }
        .top-name {
            font-weight: 600;
            color: #333;
        }
        .top-agent.bronze .top-name {
            color: white;
        }
        .top-stats {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
        }
        .top-agent.bronze .top-stats {
            color: #f0e6d3;
        }
        .top-score {
            font-size: 1.2em;
            font-weight: bold;
            color: #b6802d;
        }
        .top-agent.bronze .top-score {
            color: white;
        }
        /* Config Modal */
        .config-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .config-section h3 { color: #856404; margin-bottom: 15px; }
        .config-section code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e0e0e0;
            border-top-color: #b6802d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; color: #666; font-weight: 600; }
        @media (max-width: 1024px) {
            .content { grid-template-columns: 1fr; }
            .form-section { border-right: none; border-bottom: 2px solid #e0e0e0; }
            .agent-info { position: static; margin-bottom: 15px; text-align: center; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text"> Conectando con la base de datos...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-box">
            <h2> Gesti贸n de Clientes</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')">Iniciar Sesi贸n</div>
                <div class="login-tab" onclick="switchLoginTab('register')"> Registrarse</div>
            </div>

            <div id="errorMsg" class="error-msg"></div>
            <div id="successMsg" class="success-msg"></div>

            <!-- Login Form -->
            <div id="loginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginUsername">Usuario</label>
                    <input type="text" id="loginUsername" placeholder="Tu nombre de usuario...">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contrasena</label>
                    <input type="password" id="loginPassword" placeholder="Tu contrasena...">
                </div>
                <button class="btn btn-primary" onclick="login()">Iniciar Sesion</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="login-form">
                <div class="form-group">
                    <label for="regUsername">Nombre Completo</label>
                    <input type="text" id="regUsername" placeholder="Ej: Juan Perez...">
                </div>
                <div class="form-group">
                    <label for="regPassword">Contrasena</label>
                    <input type="password" id="regPassword" placeholder="Crea una contrasena...">
                </div>
                <div class="form-group">
                    <label for="regPasswordConfirm">Confirmar Contrasena</label>
                    <input type="password" id="regPasswordConfirm" placeholder="Confirma tu contrasena...">
                </div>
                <button class="btn btn-success" onclick="register()">Registrarse</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="agent-info">
                    <strong> Agente:</strong>
                    <span id="currentAgentDisplay"></span>
                    <span id="adminBadge" class="admin-badge" style="display: none;"> ADMIN</span>
                    <span id="syncStatus" class="sync-status sync-online"> En l铆nea</span>
                </div>
                <h1> Gesti贸n de Clientes Inmobiliarios</h1>
                <p> Sistema de registro y seguimiento por etapas</p>
                
                <!-- Menu Hamburguesa -->
                <div class="menu-container">
                    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <button class="dropdown-item" onclick="openChangePasswordModal(); closeMenu();">
                             Cambiar Contrase帽a
                        </button>
                        <button class="dropdown-item" onclick="downloadBackup(); closeMenu();">
                            Descargar Respaldo
                        </button>
                        <button class="dropdown-item" onclick="document.getElementById('fileInput').click(); closeMenu();">
                             Cargar Respaldo
                        </button>
                        <button class="dropdown-item" onclick="syncNow(); closeMenu();">
                             Sincronizar Ahora
                        </button>
                        <button class="dropdown-item danger" onclick="logout()">
                             Cerrar Sesi贸n
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="uploadBackup(event)">
                </div>
            </div>

            <div class="content">
                <div class="form-section">
                    <h2 style="margin-bottom: 25px; color: #333;"> Datos del Cliente</h2>
                    <form id="clientForm">
                        <div class="form-group">
                            <label for="nombre">Nombre del Cliente *</label>
                            <input type="text" id="nombre" required>
                        </div>
                        <div class="form-group">
                            <label for="telefono">Numero Telefonico *</label>
                            <input type="tel" id="telefono" required>
                        </div>
                        <div class="form-group">
                            <label for="tipoOperacion">Tipo de Operacion *</label>
                            <select id="tipoOperacion" required>
                                <option value="">Seleccionar...</option>
                                <option value="venta">Venta</option>
                                <option value="alquiler">Alquiler</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="direccion">Direccion de la Propiedad</label>
                            <input type="text" id="direccion">
                        </div>
                        <div class="form-group">
                            <label for="linkPropiedad">Link de la Propiedad</label>
                            <input type="text" id="linkPropiedad" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="fechaLlamada">Fecha de Primera Llamada</label>
                            <input type="date" id="fechaLlamada">
                        </div>
                        <div class="form-group">
                            <label for="nota">Notas</label>
                            <textarea id="nota"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Limpiar</button>
                        </div>
                    </form>

                    <div class="clients-list">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <h2 style="color: #333; margin: 0;">Clientes</h2>
                            <div class="client-tabs">
                                <button class="client-tab active" id="tabRegistrados" onclick="switchClientTab('registrados')">Registrados</button>
                                <button class="client-tab" id="tabArchivados" onclick="switchClientTab('archivados')">Archivados <span id="archivedCount" class="archived-count">0</span></button>
                            </div>
                        </div>
                        <div class="filter-section" id="filterSection" style="display: none;">
                            <select id="filterAgent" onchange="displayClients()">
                                <option value="mine">Mis clientes</option>
                                <option value="all">Todos los clientes</option>
                            </select>
                        </div>
                        <div id="clientsList"></div>
                    </div>
                </div>

                <div class="stats-section">
                    <div class="tabs" id="statsTabs">
                        <button class="tab active" onclick="switchStatsTab('general')">Mis Stats</button>
                        <button class="tab" id="tabAgents" onclick="switchStatsTab('agent')" style="display: none;">Por Agente</button>
                        <button class="tab" onclick="switchStatsTab('monthly')">Mensual</button>
                    </div>

                    <!-- Stats General -->
                    <div id="statsGeneral">
                        <div class="stats-card">
                            <h3 id="statsTitle">Mis Estadisticas</h3>
                            <div class="stats-filter-btns">
                                <button class="stats-filter-btn active" id="filterAll" onclick="filterStats('all')">Todos</button>
                                <button class="stats-filter-btn" id="filterVentas" onclick="filterStats('venta')">Ventas</button>
                                <button class="stats-filter-btn" id="filterAlquileres" onclick="filterStats('alquiler')">Alquileres</button>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Se llamo</span>
                                <span class="stat-value" id="statLlamado">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">Con respuesta</span>
                                <span class="stat-value" id="statRespuesta">0</span>
                            </div>
                            <div class="stat-row" id="rowPreTasacion">
                                <span class="stat-label">Pre-Tasacion</span>
                                <span class="stat-value" id="statPreTasacion">0</span>
                            </div>
                            <div class="stat-row" id="rowTasacionEntregada">
                                <span class="stat-label">Tasacion Entregada</span>
                                <span class="stat-value" id="statTasacionEntregada">0</span>
                            </div>
                            <div class="stat-row" id="rowAceptaTasacion">
                                <span class="stat-label">Acepta Tasacion</span>
                                <span class="stat-value" id="statAceptaTasacion">0</span>
                            </div>
                            <div class="stat-row" id="rowExclusiva">
                                <span class="stat-label">Con Exclusiva</span>
                                <span class="stat-value" id="statExclusiva">0</span>
                            </div>
                            <div class="stat-row" id="rowPublicadas">
                                <span class="stat-label">Publicadas</span>
                                <span class="stat-value" id="statPublicadas">0</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label" id="labelVendidas">Vendidas/Alquiladas</span>
                                <span class="stat-value" id="statVendidas">0</span>
                            </div>
                        </div>
                        <div class="total-calls">
                            <div style="font-size: 1em; font-weight: 600;">MIS LLAMADAS</div>
                            <div class="total-calls-number" id="totalLlamadas">0</div>
                        </div>
                        
                        <!-- TOP Agentes visible para todos -->
                        <div class="stats-card" style="margin-top: 15px;">
                            <h3> Top 10 Agentes</h3>
                            <div id="topAgentsGeneral"></div>
                        </div>
                    </div>

                    <!-- Stats por Agente -->
                    <div id="statsAgent" style="display: none;">
                        <div class="stats-card">
                            <h3>Estadisticas por Agente</h3>
                            <div class="form-group">
                                <select id="agentSelector" onchange="updateAgentStats()">
                                    <option value="">Seleccionar agente...</option>
                                </select>
                            </div>
                            <div class="stats-filter-btns" id="agentFilterBtns" style="display: none;">
                                <button class="stats-filter-btn active" id="agentFilterAll" onclick="filterAgentStats('all')">Todos</button>
                                <button class="stats-filter-btn" id="agentFilterVentas" onclick="filterAgentStats('venta')">Ventas</button>
                                <button class="stats-filter-btn" id="agentFilterAlquileres" onclick="filterAgentStats('alquiler')">Alquileres</button>
                            </div>
                            <div id="agentStatsContent" style="display: none;">
                                <div class="stat-row">
                                    <span class="stat-label">Clientes</span>
                                    <span class="stat-value" id="agentClientes">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Llamadas</span>
                                    <span class="stat-value" id="agentLlamadas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowTasaciones">
                                    <span class="stat-label">Tasaciones</span>
                                    <span class="stat-value" id="agentTasaciones">0</span>
                                </div>
                                <div class="stat-row" id="agentRowExclusivas">
                                    <span class="stat-label">Exclusivas</span>
                                    <span class="stat-value" id="agentExclusivas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowNoExclusivas">
                                    <span class="stat-label">No Exclusivas</span>
                                    <span class="stat-value" id="agentNoExclusivas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowPublicadas">
                                    <span class="stat-label">Publicadas</span>
                                    <span class="stat-value" id="agentPublicadas">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label" id="agentLabelVentas">Ventas/Alquileres</span>
                                    <span class="stat-value" id="agentVentas">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <h3>Resumen de Agentes</h3>
                            <div id="agentsSummary"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Ultima Sesi贸n de Agentes</h3>
                            <div id="agentsLastLogin"></div>
                        </div>
                    </div>

                    <!-- Stats Mensual -->
                    <div id="statsMonthly" style="display: none;">
                        <div class="stats-card">
                            <h3 id="monthlyTitle">Mis Estadisticas Mensuales</h3>
                            <div class="form-group" id="monthlyAgentFilter" style="display: none;">
                                <label style="font-size: 0.9em; color: #666;">Agente:</label>
                                <select id="monthlyAgentSelector" onchange="updateMonthlyStats()">
                                    <option value="all">Todos los agentes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.9em; color: #666;">Mes:</label>
                                <select id="mesSelector" onchange="updateMonthlyStats()">
                                    <option value="">Seleccionar mes...</option>
                                </select>
                            </div>
                            <div id="monthlyStats" style="display: none;">
                                <div class="stat-row">
                                    <span class="stat-label">Clientes nuevos</span>
                                    <span class="stat-value" id="monthlyNewClients">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Llamadas realizadas</span>
                                    <span class="stat-value" id="monthlyCallsMade">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Tasaciones entregadas</span>
                                    <span class="stat-value" id="monthlyTasaciones">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Ventas/Alquileres</span>
                                    <span class="stat-value" id="monthlySales">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Seguimiento -->
    <div id="followUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Seguimiento del Cliente</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Modal de Venta/Alquiler -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="saleModalTitle">Registro de Venta</h2>
                <span class="close" onclick="closeSaleModal()">&times;</span>
            </div>
            <form id="saleForm">
                <div class="form-group">
                    <label for="precioVenta" id="precioLabel">Precio de Venta *</label>
                    <input type="number" id="precioVenta" required>
                </div>
                <div class="form-group">
                    <label for="nombreComprador" id="compradorLabel">Nombre del Comprador *</label>
                    <input type="text" id="nombreComprador" required>
                </div>
                <div class="form-group">
                    <label for="telefonoComprador">Telefono</label>
                    <input type="tel" id="telefonoComprador">
                </div>
                <div class="form-group">
                    <label for="fechaVenta" id="fechaOperacionLabel">Fecha de Venta</label>
                    <input type="date" id="fechaVenta">
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success" id="submitSaleBtn">Registrar Venta</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSaleModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Agregar Llamada -->
    <div id="callModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Llamada</h2>
                <span class="close" onclick="closeCallModal()">&times;</span>
            </div>
            <div id="callModalBody">
                <div class="form-group">
                    <label for="callDate">Fecha de la Llamada</label>
                    <input type="date" id="callDate">
                </div>
                <div class="form-group">
                    <label for="callTime">Hora de la Llamada</label>
                    <input type="time" id="callTime">
                </div>
                <div class="form-group">
                    <label for="callNote">Nota de la Llamada</label>
                    <textarea id="callNote" placeholder="Descripcion de la llamada..."></textarea>
                </div>
                <div id="callHistoryContainer"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="addCall()">Agregar Llamada</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCallModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">Datos sincronizados</div>

    <!-- Modal Cambiar Contrasena -->
    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Cambiar Contrasena</h2>
                <span class="close" onclick="closePasswordModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="currentPassword">Contrasena Actual</label>
                <input type="password" id="currentPassword" placeholder="Tu contrasena actual...">
            </div>
            <div class="form-group">
                <label for="newPassword">Nueva Contrasena</label>
                <input type="password" id="newPassword" placeholder="Nueva contrasena...">
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirmar Nueva Contrasena</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirma la nueva contrasena...">
            </div>
            <div id="passwordError" class="error-msg"></div>
            <div id="passwordSuccess" class="success-msg"></div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="changePassword()">Cambiar</button>
                <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIG ============
        // IMPORTANTE: Reemplaza esta configuracion con la tuya de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyBFX3su6mj96li7YUo46yKjGpz2MFqd1nM",
            authDomain: "gestion-clientes-e7e9f.firebaseapp.com",
            databaseURL: "https://gestion-clientes-e7e9f-default-rtdb.firebaseio.com",
            projectId: "gestion-clientes-e7e9f",
            storageBucket: "gestion-clientes-e7e9f.firebasestorage.app",
            messagingSenderId: "137858869180",
            appId: "1:137858869180:web:a2e272640fc36755a6edb9"
        };

        var db = null;
        var firebaseInitialized = false;
        var SESSION_KEY = 'inmobiliaria_session';
        var ADMIN_USER = 'Diego Hernandez';
        
        var clients = [];
        var users = [];
        var editingIndex = -1;
        var currentClientIndex = -1;
        var currentAgent = '';
        var isAdmin = false;
        var showingArchived = false;
        var statsFilter = 'all';
        var agentStatsFilter = 'all';

        // ============ INICIALIZACION ============
        window.onload = function() {
            initializeApp();
        };

        function initializeApp() {
            try {
                // Intentar inicializar Firebase
                if (firebaseConfig.apiKey !== "TU_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    firebaseInitialized = true;
                    
                    // Escuchar cambios en tiempo real
                    setupRealtimeListeners();
                    
                    // Cargar datos desde Firebase
                    loadFromFirebase(function() {
                        hideLoading();
                        checkSession();
                    });
                } else {
                    // Usar localStorage si Firebase no esta configurado
                    console.log('Firebase no configurado, usando localStorage');
                    firebaseInitialized = false;
                    loadFromLocalStorage();
                    hideLoading();
                    checkSession();
                }
            } catch (e) {
                console.error('Error inicializando Firebase:', e);
                firebaseInitialized = false;
                loadFromLocalStorage();
                hideLoading();
                checkSession();
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateSyncStatus(status) {
            var el = document.getElementById('syncStatus');
            if (!el) return;
            el.className = 'sync-status';
            if (status === 'online') {
                el.classList.add('sync-online');
                el.textContent = ' En l铆nea';
            } else if (status === 'offline') {
                el.classList.add('sync-offline');
                el.textContent = ' Sin conexi贸n';
            } else if (status === 'syncing') {
                el.classList.add('sync-syncing');
                el.textContent = ' Sincronizando...';
            }
        }

        // ============ FIREBASE FUNCTIONS ============
        function setupRealtimeListeners() {
            if (!db) return;
            
            // Escuchar cambios en clientes
            db.ref('clients').on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    clients = Object.values(data);
                } else {
                    clients = [];
                }
                if (currentAgent) {
                    displayClients();
                    updateArchivedCount();
                    updateStats();
                    populateMonthSelector();
                    if (isAdmin) populateAgentSelector();
                }
                updateSyncStatus('online');
            }, function(error) {
                console.error('Error en listener de clientes:', error);
                updateSyncStatus('offline');
            });

            // Escuchar cambios en usuarios
            db.ref('users').on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    users = Object.values(data);
                } else {
                    users = [];
                }
            });

            // Estado de conexion
            db.ref('.info/connected').on('value', function(snapshot) {
                if (snapshot.val() === true) {
                    updateSyncStatus('online');
                } else {
                    updateSyncStatus('offline');
                }
            });
        }

        function loadFromFirebase(callback) {
            if (!db) {
                if (callback) callback();
                return;
            }

            var loaded = 0;
            var total = 2;

            db.ref('clients').once('value').then(function(snapshot) {
                var data = snapshot.val();
                if (data) clients = Object.values(data);
                loaded++;
                if (loaded === total && callback) callback();
            }).catch(function(e) {
                console.error('Error cargando clientes:', e);
                loaded++;
                if (loaded === total && callback) callback();
            });

            db.ref('users').once('value').then(function(snapshot) {
                var data = snapshot.val();
                if (data) users = Object.values(data);
                loaded++;
                if (loaded === total && callback) callback();
            }).catch(function(e) {
                console.error('Error cargando usuarios:', e);
                loaded++;
                if (loaded === total && callback) callback();
            });
        }

        function saveToFirebase() {
            if (!db) {
                saveToLocalStorage();
                return;
            }

            updateSyncStatus('syncing');

            var clientsObj = {};
            for (var i = 0; i < clients.length; i++) {
                clientsObj['client_' + i] = clients[i];
            }

            db.ref('clients').set(clientsObj).then(function() {
                updateSyncStatus('online');
                showSaveIndicator();
            }).catch(function(e) {
                console.error('Error guardando:', e);
                updateSyncStatus('offline');
                saveToLocalStorage(); // Fallback
            });
        }

        function saveUsersToFirebase() {
            if (!db) {
                localStorage.setItem('inmobiliaria_users', JSON.stringify(users));
                return;
            }

            var usersObj = {};
            for (var i = 0; i < users.length; i++) {
                var safeKey = users[i].username.replace(/[.#$\/\[\]]/g, '_');
                usersObj[safeKey] = users[i];
            }

            db.ref('users').set(usersObj).catch(function(e) {
                console.error('Error guardando usuarios:', e);
            });
        }

        function syncNow() {
            if (db) {
                updateSyncStatus('syncing');
                loadFromFirebase(function() {
                    displayClients();
                    updateStats();
                    alert(' Sincronizaci贸n completada');
                });
            } else {
                alert('锔 Firebase no est谩 configurado');
            }
        }

        // ============ LOCAL STORAGE FALLBACK ============
        function loadFromLocalStorage() {
            try {
                var savedClients = localStorage.getItem('inmobiliaria_clientes_data');
                if (savedClients) clients = JSON.parse(savedClients);
                var savedUsers = localStorage.getItem('inmobiliaria_users');
                if (savedUsers) users = JSON.parse(savedUsers);
            } catch (e) {
                console.error('Error cargando localStorage:', e);
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('inmobiliaria_clientes_data', JSON.stringify(clients));
            } catch (e) {
                console.error('Error guardando:', e);
            }
        }

        // ============ MENU HAMBURGUESA ============
        function toggleMenu() {
            var btn = document.getElementById('hamburgerBtn');
            var menu = document.getElementById('dropdownMenu');
            btn.classList.toggle('active');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            var btn = document.getElementById('hamburgerBtn');
            var menu = document.getElementById('dropdownMenu');
            btn.classList.remove('active');
            menu.classList.remove('show');
        }

        // Cerrar menu al hacer click fuera
        document.addEventListener('click', function(e) {
            var menu = document.getElementById('dropdownMenu');
            var btn = document.getElementById('hamburgerBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                closeMenu();
            }
        });

        // ============ AUTH SYSTEM ============
        function checkSession() {
            var session = localStorage.getItem(SESSION_KEY);
            if (session) {
                var sessionData = JSON.parse(session);
                var user = findUser(sessionData.username);
                if (user && user.password === sessionData.password) {
                    // Actualizar ultima sesion
                    user.lastLogin = new Date().toISOString();
                    saveUsersToFirebase();
                    
                    currentAgent = user.username;
                    isAdmin = (currentAgent === ADMIN_USER);
                    showMainApp();
                    return;
                }
            }
            showLoginScreen();
        }

        function findUser(username) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].username.toLowerCase() === username.toLowerCase()) {
                    return users[i];
                }
            }
            return null;
        }

        function switchLoginTab(tab) {
            var tabs = document.querySelectorAll('.login-tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            if (tab === 'login') document.getElementById('loginForm').classList.add('active');
            else document.getElementById('registerForm').classList.add('active');
            hideMessages();
        }

        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
        }

        function showSuccess(msg) {
            var el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
        }

        function register() {
            hideMessages();
            var username = document.getElementById('regUsername').value.trim();
            var password = document.getElementById('regPassword').value;
            var passwordConfirm = document.getElementById('regPasswordConfirm').value;

            if (!username || !password) { showError('Completa todos los campos'); return; }
            if (password !== passwordConfirm) { showError('Las contrasenas no coinciden'); return; }
            if (password.length < 4) { showError('Contrasena minimo 4 caracteres'); return; }
            if (findUser(username)) { showError('Este usuario ya existe'); return; }

            users.push({ username: username, password: password, createdAt: new Date().toISOString() });
            saveUsersToFirebase();
            showSuccess('Registro exitoso! Inicia sesion');
            document.getElementById('regUsername').value = '';
            document.getElementById('regPassword').value = '';
            document.getElementById('regPasswordConfirm').value = '';
            setTimeout(function() { switchLoginTab('login'); }, 1500);
        }

        function login() {
            hideMessages();
            var username = document.getElementById('loginUsername').value.trim();
            var password = document.getElementById('loginPassword').value;

            if (!username || !password) { showError('Completa todos los campos'); return; }
            var user = findUser(username);
            if (!user || user.password !== password) { showError('Usuario o contrasena incorrectos'); return; }

            // Guardar ultima sesion
            user.lastLogin = new Date().toISOString();
            saveUsersToFirebase();

            currentAgent = user.username;
            isAdmin = (currentAgent === ADMIN_USER);
            localStorage.setItem(SESSION_KEY, JSON.stringify({ username: user.username, password: user.password }));
            showMainApp();
        }

        function logout() {
            closeMenu();
            localStorage.removeItem(SESSION_KEY);
            currentAgent = '';
            isAdmin = false;
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            hideMessages();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentAgentDisplay').textContent = currentAgent;
            
            if (isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('tabAgents').style.display = 'inline-block';
                document.getElementById('filterSection').style.display = 'block';
                document.getElementById('statsTitle').textContent = ' Mis Estad铆sticas';
                document.getElementById('monthlyTitle').textContent = ' Estad铆sticas Mensuales';
                document.getElementById('monthlyAgentFilter').style.display = 'block';
                populateMonthlyAgentSelector();
            } else {
                document.getElementById('adminBadge').style.display = 'none';
                document.getElementById('tabAgents').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                document.getElementById('statsTitle').textContent = ' Mis Estad铆sticas';
                document.getElementById('monthlyTitle').textContent = ' Mis Estad铆sticas Mensuales';
                document.getElementById('monthlyAgentFilter').style.display = 'none';
            }
            
            migrateOldData();
            updateStats();
            displayClients();
            updateArchivedCount();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
        }

        // ============ CLIENT FORM ============
        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveClient();
        });

        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            registerSale();
        });

        function migrateOldData() {
            var needsSave = false;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (!client.historialLlamadas) {
                    client.historialLlamadas = [];
                    if (client.cantidadLlamadas > 0 && client.fechaLlamada) {
                        for (var j = 0; j < client.cantidadLlamadas; j++) {
                            client.historialLlamadas.push({ fecha: client.fechaLlamada, hora: '', nota: j === 0 ? 'Primera llamada' : 'Llamada ' + (j + 1) });
                        }
                    }
                    needsSave = true;
                }
                if (!client.agente) { client.agente = currentAgent; needsSave = true; }
            }
            if (needsSave) saveToFirebase();
        }

        function saveClient() {
            var clientData = {
                nombre: document.getElementById('nombre').value,
                telefono: document.getElementById('telefono').value,
                tipoOperacion: document.getElementById('tipoOperacion').value,
                direccion: document.getElementById('direccion').value,
                linkPropiedad: document.getElementById('linkPropiedad').value,
                fechaLlamada: document.getElementById('fechaLlamada').value,
                nota: document.getElementById('nota').value,
                cantidadLlamadas: 0,
                historialLlamadas: [],
                archivado: false,
                ultimoContacto: new Date().toISOString(),
                fechaCreacion: new Date().toISOString(),
                agente: currentAgent,
                seguimiento: createEmptySeguimiento(),
                venta: null
            };

            if (editingIndex === -1) {
                clients.push(clientData);
            } else {
                var existing = clients[editingIndex];
                clientData.seguimiento = existing.seguimiento;
                clientData.cantidadLlamadas = existing.cantidadLlamadas;
                clientData.historialLlamadas = existing.historialLlamadas || [];
                clientData.archivado = existing.archivado;
                clientData.venta = existing.venta;
                clientData.ultimoContacto = existing.ultimoContacto;
                clientData.fechaCreacion = existing.fechaCreacion;
                clientData.agente = existing.agente;
                clients[editingIndex] = clientData;
                editingIndex = -1;
            }

            saveToFirebase();
            displayClients();
            updateStats();
            resetForm();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
        }

        function createEmptySeguimiento() {
            return {
                seLlamo: null, huboRespuesta: null, esInmobiliaria: null, compartenPropiedad: null,
                notaInmobiliaria: '', fueVendido: null, esDueno: null, notaNoDueno: '', numeroNuevoDueno: '',
                aceptaPreTasacion: null, loAlquilamosNosotros: null, fechaEntrega: '', modalidadEntrega: '', personaEntrega: '',
                tasacionEntregada: null, aceptaTasacion: null, tipoExclusiva: '', publicaste: null,
                plataformasPublicacion: [], vendida: false
            };
        }

        function switchClientTab(tab) {
            showingArchived = (tab === 'archivados');
            document.getElementById('tabRegistrados').classList.toggle('active', !showingArchived);
            document.getElementById('tabArchivados').classList.toggle('active', showingArchived);
            displayClients();
        }

        function updateArchivedCount() {
            var count = 0;
            var filter = isAdmin ? document.getElementById('filterAgent').value : 'mine';
            for (var i = 0; i < clients.length; i++) {
                if (clients[i].archivado) {
                    if (filter === 'mine') {
                        if (clients[i].agente === currentAgent) count++;
                    } else {
                        count++;
                    }
                }
            }
            document.getElementById('archivedCount').textContent = count;
        }

        function toggleNote(index) {
            var noteEl = document.getElementById('note-' + index);
            var btnEl = document.getElementById('btn-note-' + index);
            if (noteEl.classList.contains('expanded')) {
                noteEl.classList.remove('expanded');
                btnEl.textContent = 'Ver m谩s...';
            } else {
                noteEl.classList.add('expanded');
                btnEl.textContent = 'Ver menos';
            }
        }

        function displayClients() {
            var list = document.getElementById('clientsList');
            list.innerHTML = '';
            var filter = isAdmin ? document.getElementById('filterAgent').value : 'mine';

            var filteredClients = [];
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (showingArchived) {
                    if (!client.archivado) continue;
                } else {
                    if (client.archivado) continue;
                }
                if (filter === 'mine' && client.agente !== currentAgent) continue;
                filteredClients.push({ client: client, originalIndex: i });
            }

            filteredClients.sort(function(a, b) { return new Date(b.client.ultimoContacto) - new Date(a.client.ultimoContacto); });

            if (filteredClients.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">' + (showingArchived ? ' No hay clientes archivados' : ' No hay clientes registrados') + '</p>';
                updateArchivedCount();
                return;
            }

            for (var j = 0; j < filteredClients.length; j++) {
                var item = filteredClients[j];
                var client = item.client;
                var index = item.originalIndex;
                var stage = getClientStage(client);
                var card = document.createElement('div');
                card.className = 'client-card';
                
                var linkHTML = client.linkPropiedad ? '<div class="info-item" style="grid-column: 1 / -1;"><span class="info-label">Link:</span> <a href="' + client.linkPropiedad + '" target="_blank" style="color: #b6802d;">' + client.linkPropiedad + '</a></div>' : '';
                var tipoText = client.tipoOperacion === 'venta' ? ' Venta' : ' Alquiler';
                var tipoClass = client.tipoOperacion === 'venta' ? 'type-venta' : 'type-alquiler';
                var fechaFormateada = new Date(client.ultimoContacto).toLocaleDateString('es-ES');
                var ventaHTML = '';
                if (client.venta) {
                    var tipoOp = client.tipoOperacion === 'venta' ? 'VENDIDA' : 'ALQUILADA';
                    var tipoPers = client.tipoOperacion === 'venta' ? 'Comprador' : 'Inquilino';
                    ventaHTML = '<div style="margin-top: 10px; padding: 10px; background: #c8e6c9; border-radius: 5px; color: #2e7d32;"><strong>' + tipoOp + '</strong> - $' + client.venta.precio + ' - ' + tipoPers + ': ' + client.venta.nombreComprador + '</div>';
                }
                var agentBadge = (isAdmin && filter === 'all') ? '<span class="agent-badge">' + (client.agente || 'Sin agente') + '</span>' : '';
                
                var notaHTML = '';
                if (client.nota) {
                    var notaCorta = client.nota.length > 100;
                    notaHTML = '<div class="note-container"><strong> Nota:</strong> <span id="note-' + index + '" class="note-text">' + client.nota + '</span>' + (notaCorta ? '<br><button class="ver-mas-btn" id="btn-note-' + index + '" onclick="toggleNote(' + index + ')">Ver m谩s...</button>' : '') + '</div>';
                }

                var actionsHTML = '';
                if (showingArchived) {
                    actionsHTML = '<button class="btn-small btn-restore" onclick="restaurarCliente(' + index + ')">伙 Restaurar</button><button class="btn-small btn-delete" onclick="deleteClient(' + index + ')">Eliminar</button>';
                } else {
                    actionsHTML = '<button class="btn-small btn-call" onclick="openCallModal(' + index + ')">+Llamada</button><button class="btn-small btn-follow" onclick="openFollowUp(' + index + ')">Seguimiento</button><button class="btn-small btn-edit" onclick="editClient(' + index + ')">Editar</button><button class="btn-small btn-delete" onclick="deleteClient(' + index + ')">Borrar</button>';
                }
                
                card.innerHTML = '<div class="client-header"><div><span class="client-name">' + client.nombre + '</span><span class="type-badge ' + tipoClass + '">' + tipoText + '</span>' + agentBadge + '</div><div class="client-actions">' + actionsHTML + '</div></div><div class="client-info"><div class="info-item"><span class="info-label">Tel茅fono:</span> ' + client.telefono + '</div><div class="info-item"><span class="info-label">Direcci贸n:</span> ' + (client.direccion || 'N/A') + '</div><div class="info-item"><span class="info-label">Llamadas:</span> ' + client.cantidadLlamadas + '</div><div class="info-item"><span class="info-label">ltimo contacto:</span> ' + fechaFormateada + '</div>' + linkHTML + '</div><span class="stage-badge ' + stage.class + '">' + stage.badge + '</span>' + notaHTML + ventaHTML;
                list.appendChild(card);
            }
            updateArchivedCount();
        }

        function restaurarCliente(index) {
            if (confirm('驴Restaurar este cliente?')) {
                clients[index].archivado = false;
                clients[index].ultimoContacto = new Date().toISOString();
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
            }
        }

        function getClientStage(client) {
            var s = client.seguimiento;
            if (client.archivado) return { badge: 'Archivado', class: 'stage-archivada' };
            if (s.vendida) return { badge: client.tipoOperacion === 'venta' ? 'VENDIDA' : 'ALQUILADA', class: 'stage-vendida' };
            if (s.publicaste === true) return { badge: 'Publicada', class: 'stage-publicada' };
            if (s.tipoExclusiva) return { badge: 'Exclusiva', class: 'stage-exclusiva' };
            if (s.aceptaTasacion === true) return { badge: 'Acepta Tasacion', class: 'stage-tasacion' };
            if (s.tasacionEntregada === true) return { badge: 'Tasacion Entregada', class: 'stage-tasacion' };
            if (s.aceptaPreTasacion === true) return { badge: 'Hacer Seguimiento', class: 'stage-seguimiento' };
            if (s.aceptaPreTasacion === false) return { badge: 'Seguir o Archivar', class: 'stage-seguimiento' };
            if (s.esDueno === false) return { badge: 'Nota/Nuevo Tel', class: 'stage-seguimiento' };
            if (s.fueVendido === true) return { badge: 'Para Archivar', class: 'stage-archivada' };
            if (s.esInmobiliaria === true) return { badge: 'Inmobiliaria', class: 'stage-respuesta' };
            if (s.huboRespuesta === false) return { badge: 'Llamar de Nuevo', class: 'stage-pendiente' };
            if (s.huboRespuesta === true) return { badge: 'Respondio', class: 'stage-respuesta' };
            if (s.seLlamo === false) return { badge: 'Pendiente Llamar', class: 'stage-pendiente' };
            if (s.seLlamo === true) return { badge: 'Llamado', class: 'stage-inicial' };
            return { badge: 'Pendiente', class: 'stage-inicial' };
        }

        // ============ CALL MODAL ============
        function openCallModal(index) {
            currentClientIndex = index;
            var client = clients[index];
            var now = new Date();
            document.getElementById('callDate').value = now.toISOString().split('T')[0];
            document.getElementById('callTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('callNote').value = '';
            renderCallHistory(client);
            document.getElementById('callModal').style.display = 'block';
        }

        function closeCallModal() { document.getElementById('callModal').style.display = 'none'; currentClientIndex = -1; }

        function renderCallHistory(client) {
            var container = document.getElementById('callHistoryContainer');
            var historial = client.historialLlamadas || [];
            if (historial.length === 0) { container.innerHTML = '<p style="color: #666; font-style: italic;">No hay llamadas registradas.</p>'; return; }
            var html = '<div class="call-history"><h4>Historial (' + historial.length + ')</h4>';
            for (var i = historial.length - 1; i >= 0; i--) {
                var call = historial[i];
                html += '<div class="call-item"><div><span>' + (call.fecha || 'Sin fecha') + ' ' + (call.hora || '') + '</span>' + (call.nota ? '<br><small>' + call.nota + '</small>' : '') + '</div><button class="delete-call" onclick="deleteCall(' + i + ')">X</button></div>';
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function addCall() {
            var client = clients[currentClientIndex];
            client.historialLlamadas = client.historialLlamadas || [];
            client.historialLlamadas.push({ fecha: document.getElementById('callDate').value, hora: document.getElementById('callTime').value, nota: document.getElementById('callNote').value });
            client.cantidadLlamadas = client.historialLlamadas.length;
            client.ultimoContacto = new Date().toISOString();
            if (client.seguimiento.seLlamo !== true) client.seguimiento.seLlamo = true;
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            renderCallHistory(client);
            document.getElementById('callNote').value = '';
            var now = new Date();
            document.getElementById('callDate').value = now.toISOString().split('T')[0];
            document.getElementById('callTime').value = now.toTimeString().slice(0, 5);
        }

        function deleteCall(callIndex) {
            if (!confirm('驴Eliminar esta llamada?')) return;
            var client = clients[currentClientIndex];
            client.historialLlamadas.splice(callIndex, 1);
            client.cantidadLlamadas = client.historialLlamadas.length;
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            renderCallHistory(client);
        }

        // ============ FOLLOW UP ============
        function openFollowUp(index) {
            currentClientIndex = index;
            var client = clients[index];
            var s = client.seguimiento;
            var esAlquiler = client.tipoOperacion === 'alquiler';
            var html = buildFollowUpHTML(client, s, esAlquiler);
            html += '<div class="btn-group"><button type="button" class="btn btn-primary" onclick="saveFollowUp()">Guardar</button><button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button></div>';
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('followUpModal').style.display = 'block';
        }

        function buildFollowUpHTML(client, s, esAlquiler) {
            var html = '';
            html += '<div class="stage-section"><div class="stage-title">1. Se realizo la llamada?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="seLlamoSi" name="seLlamo" value="si" ' + (s.seLlamo === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="seLlamoSi">Si</label></div><div class="radio-item"><input type="radio" id="seLlamoNo" name="seLlamo" value="no" ' + (s.seLlamo === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="seLlamoNo">No</label></div></div>' + (s.seLlamo === false ? '<div class="alert-box alert-warning">Pendiente por llamar</div>' : '') + '</div>';
            if (s.seLlamo !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">2. Hubo respuesta?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="respuestaSi" name="huboRespuesta" value="si" ' + (s.huboRespuesta === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="respuestaSi">Si</label></div><div class="radio-item"><input type="radio" id="respuestaNo" name="huboRespuesta" value="no" ' + (s.huboRespuesta === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="respuestaNo">No</label></div></div>' + (s.huboRespuesta === false ? '<div class="alert-box alert-warning">Llamar de nuevo</div>' : '') + '</div>';
            if (s.huboRespuesta !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">3. Es inmobiliaria?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="inmobiliariaSi" name="esInmobiliaria" value="si" ' + (s.esInmobiliaria === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="inmobiliariaSi">Si</label></div><div class="radio-item"><input type="radio" id="inmobiliariaNo" name="esInmobiliaria" value="no" ' + (s.esInmobiliaria === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="inmobiliariaNo">No</label></div></div>';
            if (s.esInmobiliaria === true) {
                html += '<div class="form-group" style="margin-top:15px"><label>Comparten?</label><div class="radio-group"><div class="radio-item"><input type="radio" id="compartenSi" name="compartenPropiedad" value="si" ' + (s.compartenPropiedad === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="compartenSi">Si</label></div><div class="radio-item"><input type="radio" id="compartenNo" name="compartenPropiedad" value="no" ' + (s.compartenPropiedad === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="compartenNo">No</label></div></div></div><div class="form-group"><label>Nota:</label><textarea id="notaInmobiliaria">' + (s.notaInmobiliaria || '') + '</textarea></div>';
            }
            html += '</div>';
            if (s.esInmobiliaria !== false) return html;

            html += '<div class="stage-section"><div class="stage-title">4. Ya fue ' + (esAlquiler ? 'alquilada' : 'vendida') + '?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="vendidoSi" name="fueVendido" value="si" ' + (s.fueVendido === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="vendidoSi">Si</label></div><div class="radio-item"><input type="radio" id="vendidoNo" name="fueVendido" value="no" ' + (s.fueVendido === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="vendidoNo">No</label></div></div>';
            if (s.fueVendido === true) html += '<div class="alert-box alert-warning">Puede archivarse</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
            html += '</div>';
            if (s.fueVendido !== false) return html;

            html += '<div class="stage-section"><div class="stage-title">5. Es el dueno?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="duenoSi" name="esDueno" value="si" ' + (s.esDueno === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="duenoSi">Si</label></div><div class="radio-item"><input type="radio" id="duenoNo" name="esDueno" value="no" ' + (s.esDueno === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="duenoNo">No</label></div></div>';
            if (s.esDueno === false) html += '<div class="form-group" style="margin-top:15px"><label>Nota:</label><textarea id="notaNoDueno">' + (s.notaNoDueno || '') + '</textarea></div><div class="form-group"><label>Tel dueno:</label><input type="tel" id="numeroNuevoDueno" value="' + (s.numeroNuevoDueno || '') + '"></div>';
            html += '</div>';
            if (s.esDueno !== true && s.esDueno !== false) return html;

            if (esAlquiler) {
                html += '<div class="stage-section"><div class="stage-title">6. Acepta alquiler con nosotros?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="preTasacionSi" name="aceptaPreTasacion" value="si" ' + (s.aceptaPreTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionSi">Si</label></div><div class="radio-item"><input type="radio" id="preTasacionNo" name="aceptaPreTasacion" value="no" ' + (s.aceptaPreTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionNo">No</label></div></div>';
                if (s.aceptaPreTasacion === false) html += '<div class="alert-box alert-warning">Seguimiento o archivar</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
                html += '</div>';
                
                if (s.aceptaPreTasacion === true) {
                    html += '<div class="stage-section"><div class="stage-title">7. Lo alquilamos nosotros?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="loAlquilamosSi" name="loAlquilamosNosotros" value="si" ' + (s.loAlquilamosNosotros === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="loAlquilamosSi">Si</label></div><div class="radio-item"><input type="radio" id="loAlquilamosNo" name="loAlquilamosNosotros" value="no" ' + (s.loAlquilamosNosotros === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="loAlquilamosNo">No</label></div></div>';
                    if (s.loAlquilamosNosotros === true && !s.vendida) html += '<button type="button" class="btn btn-success" style="width:100%;margin-top:15px" onclick="openSaleModal()">Registrar Alquiler</button>';
                    if (s.loAlquilamosNosotros === false) html += '<div class="alert-box alert-warning">Archivar cliente</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
                    html += '</div>';
                }
                return html;
            } else {
                html += '<div class="stage-section"><div class="stage-title">6. Acepta pre-tasacion?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="preTasacionSi" name="aceptaPreTasacion" value="si" ' + (s.aceptaPreTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionSi">Si</label></div><div class="radio-item"><input type="radio" id="preTasacionNo" name="aceptaPreTasacion" value="no" ' + (s.aceptaPreTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionNo">No</label></div></div>';
                if (s.aceptaPreTasacion === false) html += '<div class="alert-box alert-warning">Seguimiento o archivar</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
                html += '</div>';
            }

            if (s.aceptaPreTasacion !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">7. Entrega de Tasacion</div><div class="form-group"><label>Fecha entrega</label><input type="date" id="fechaEntrega" value="' + (s.fechaEntrega || '') + '" onchange="updateFollowUp()"></div><div class="form-group"><label>Modalidad</label><select id="modalidadEntrega" onchange="updateFollowUp()"><option value="">Seleccionar...</option><option value="Presencial" ' + (s.modalidadEntrega === 'Presencial' ? 'selected' : '') + '>Presencial</option><option value="Email" ' + (s.modalidadEntrega === 'Email' ? 'selected' : '') + '>Email</option><option value="WhatsApp" ' + (s.modalidadEntrega === 'WhatsApp' ? 'selected' : '') + '>WhatsApp</option><option value="Correo" ' + (s.modalidadEntrega === 'Correo' ? 'selected' : '') + '>Correo postal</option></select></div><div class="form-group"><label>Agente que entrego</label><input type="text" id="personaEntrega" value="' + (s.personaEntrega || currentAgent) + '" readonly style="background:#f0f0f0"></div>' + (s.fechaEntrega ? '<div class="timestamp-display">Fecha: ' + s.fechaEntrega + '</div>' : '') + '<div class="radio-group" style="margin-top:15px"><div class="radio-item"><input type="radio" id="entregadaSi" name="tasacionEntregada" value="si" ' + (s.tasacionEntregada === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="entregadaSi">Entregada</label></div><div class="radio-item"><input type="radio" id="entregadaNo" name="tasacionEntregada" value="no" ' + (s.tasacionEntregada === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="entregadaNo">No</label></div></div></div>';
            if (s.tasacionEntregada !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">8. Acepta la tasacion?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="aceptaTasacionSi" name="aceptaTasacion" value="si" ' + (s.aceptaTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="aceptaTasacionSi">Si</label></div><div class="radio-item"><input type="radio" id="aceptaTasacionNo" name="aceptaTasacion" value="no" ' + (s.aceptaTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="aceptaTasacionNo">No</label></div></div></div>';
            if (s.aceptaTasacion !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">9. Tipo de Exclusiva</div><div class="form-group"><select id="tipoExclusiva" onchange="updateFollowUp()"><option value="">Seleccionar...</option><option value="Exclusiva" ' + (s.tipoExclusiva === 'Exclusiva' ? 'selected' : '') + '>Exclusiva</option><option value="No Exclusiva" ' + (s.tipoExclusiva === 'No Exclusiva' ? 'selected' : '') + '>No Exclusiva</option><option value="Otra Modalidad" ' + (s.tipoExclusiva === 'Otra Modalidad' ? 'selected' : '') + '>Otra Modalidad</option></select></div></div>';
            if (!s.tipoExclusiva) return html;

            html += '<div class="stage-section"><div class="stage-title">10. Publicaste?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="publicasteSi" name="publicaste" value="si" ' + (s.publicaste === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteSi">Si</label></div><div class="radio-item"><input type="radio" id="publicasteNo" name="publicaste" value="no" ' + (s.publicaste === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteNo">No</label></div></div>';
            if (s.publicaste === true) {
                var plataformas = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
                html += '<div class="form-group" style="margin-top:15px"><label>Donde?</label><div class="checkbox-group">';
                for (var i = 0; i < plataformas.length; i++) {
                    var plat = plataformas[i];
                    var isChecked = s.plataformasPublicacion && s.plataformasPublicacion.indexOf(plat) !== -1;
                    html += '<div class="checkbox-item"><input type="checkbox" id="plat_' + plat.replace(/\s/g, '') + '" value="' + plat + '" ' + (isChecked ? 'checked' : '') + '><label for="plat_' + plat.replace(/\s/g, '') + '">' + plat + '</label></div>';
                }
                html += '</div></div>';
                if (!s.vendida) html += '<div class="stage-section" style="background:#e8f5e9;margin-top:15px"><div class="stage-title">11. Venta</div><button type="button" class="btn btn-success" style="width:100%" onclick="openSaleModal()">Registrar Venta</button></div>';
            }
            html += '</div>';
            return html;
        }

        function updateFollowUp() {
            var client = clients[currentClientIndex];
            var s = client.seguimiento;
            var getValue = function(name) { var el = document.querySelector('input[name="' + name + '"]:checked'); return el ? el.value === 'si' : null; };
            var getVal = function(id) { var el = document.getElementById(id); return el ? el.value : null; };

            var oldSeLlamo = s.seLlamo;
            s.seLlamo = getValue('seLlamo');
            if (s.seLlamo === true && oldSeLlamo !== true) {
                client.historialLlamadas = client.historialLlamadas || [];
                client.historialLlamadas.push({ fecha: new Date().toISOString().split('T')[0], hora: new Date().toTimeString().slice(0, 5), nota: 'Desde seguimiento' });
                client.cantidadLlamadas = client.historialLlamadas.length;
                client.ultimoContacto = new Date().toISOString();
            }

            s.huboRespuesta = getValue('huboRespuesta');
            if (s.huboRespuesta) client.ultimoContacto = new Date().toISOString();
            s.esInmobiliaria = getValue('esInmobiliaria');
            s.compartenPropiedad = getValue('compartenPropiedad');
            s.fueVendido = getValue('fueVendido');
            s.esDueno = getValue('esDueno');
            s.aceptaPreTasacion = getValue('aceptaPreTasacion');
            s.loAlquilamosNosotros = getValue('loAlquilamosNosotros');
            s.tasacionEntregada = getValue('tasacionEntregada');
            if (s.tasacionEntregada) client.ultimoContacto = new Date().toISOString();
            s.aceptaTasacion = getValue('aceptaTasacion');
            s.publicaste = getValue('publicaste');

            var fields = ['notaInmobiliaria', 'notaNoDueno', 'numeroNuevoDueno'];
            for (var i = 0; i < fields.length; i++) { var v = getVal(fields[i]); if (v !== null) s[fields[i]] = v; }
            var fe = getVal('fechaEntrega'); if (fe !== null) s.fechaEntrega = fe;
            var me = getVal('modalidadEntrega'); if (me !== null) s.modalidadEntrega = me;
            s.personaEntrega = currentAgent;
            var te = getVal('tipoExclusiva'); if (te !== null) s.tipoExclusiva = te;

            var plataformas = [];
            var platNames = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
            for (var j = 0; j < platNames.length; j++) {
                var cb = document.getElementById('plat_' + platNames[j].replace(/\s/g, ''));
                if (cb && cb.checked) plataformas.push(platNames[j]);
            }
            if (plataformas.length > 0 || s.publicaste === true) s.plataformasPublicacion = plataformas;
            openFollowUp(currentClientIndex);
        }

        function saveFollowUp() {
            var client = clients[currentClientIndex];
            var s = client.seguimiento;
            var ni = document.getElementById('notaInmobiliaria'); if (ni) s.notaInmobiliaria = ni.value;
            var nd = document.getElementById('notaNoDueno'); if (nd) s.notaNoDueno = nd.value;
            var nn = document.getElementById('numeroNuevoDueno'); if (nn) s.numeroNuevoDueno = nn.value;
            client.ultimoContacto = new Date().toISOString();
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            closeModal();
        }

        function archivarCliente() {
            if (confirm('驴Archivar este cliente?')) {
                clients[currentClientIndex].archivado = true;
                clients[currentClientIndex].ultimoContacto = new Date().toISOString();
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                closeModal();
            }
        }

        function closeModal() { document.getElementById('followUpModal').style.display = 'none'; currentClientIndex = -1; }

        // ============ CHANGE PASSWORD ============
        function openChangePasswordModal() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function changePassword() {
            var currentPass = document.getElementById('currentPassword').value;
            var newPass = document.getElementById('newPassword').value;
            var confirmPass = document.getElementById('confirmNewPassword').value;
            var errorEl = document.getElementById('passwordError');
            var successEl = document.getElementById('passwordSuccess');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            // Buscar usuario actual
            var userIndex = -1;
            for (var i = 0; i < users.length; i++) {
                if (users[i].username.toLowerCase() === currentAgent.toLowerCase()) {
                    userIndex = i;
                    break;
                }
            }

            if (userIndex === -1) {
                errorEl.textContent = 'Error: Usuario no encontrado';
                errorEl.style.display = 'block';
                return;
            }

            // Validar contrasena actual
            if (users[userIndex].password !== currentPass) {
                errorEl.textContent = 'La contrasena actual es incorrecta';
                errorEl.style.display = 'block';
                return;
            }

            // Validar nueva contrasena
            if (newPass.length < 4) {
                errorEl.textContent = 'La nueva contrasena debe tener al menos 4 caracteres';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'Las contrasenas nuevas no coinciden';
                errorEl.style.display = 'block';
                return;
            }

            // Cambiar contrasena
            users[userIndex].password = newPass;
            saveUsersToFirebase();

            // Actualizar sesion
            localStorage.setItem(SESSION_KEY, JSON.stringify({
                username: users[userIndex].username,
                password: newPass
            }));

            successEl.textContent = 'Contrasena cambiada exitosamente!';
            successEl.style.display = 'block';

            setTimeout(function() {
                closePasswordModal();
            }, 1500);
        }

        // ============ SALE MODAL ============
        function openSaleModal() {
            var client = clients[currentClientIndex];
            var esAlquiler = client.tipoOperacion === 'alquiler';
            document.getElementById('saleModalTitle').textContent = esAlquiler ? 'Registro de Alquiler' : 'Registro de Venta';
            document.getElementById('precioLabel').textContent = esAlquiler ? 'Precio Alquiler *' : 'Precio Venta *';
            document.getElementById('compradorLabel').textContent = esAlquiler ? 'Nombre Inquilino *' : 'Nombre Comprador *';
            document.getElementById('fechaOperacionLabel').textContent = esAlquiler ? 'Fecha Alquiler' : 'Fecha Venta';
            document.getElementById('submitSaleBtn').textContent = esAlquiler ? 'Registrar Alquiler' : 'Registrar Venta';
            document.getElementById('saleModal').style.display = 'block';
        }

        function closeSaleModal() { document.getElementById('saleModal').style.display = 'none'; document.getElementById('saleForm').reset(); }

        function registerSale() {
            var client = clients[currentClientIndex];
            client.venta = { precio: document.getElementById('precioVenta').value, nombreComprador: document.getElementById('nombreComprador').value, telefono: document.getElementById('telefonoComprador').value, fecha: document.getElementById('fechaVenta').value };
            client.seguimiento.vendida = true;
            client.ultimoContacto = new Date().toISOString();
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            closeSaleModal();
            closeModal();
            alert(client.tipoOperacion === 'alquiler' ? ' 隆Alquiler registrado!' : ' 隆Venta registrada!');
        }

        // ============ EDIT/DELETE ============
        function editClient(index) {
            editingIndex = index;
            var client = clients[index];
            document.getElementById('nombre').value = client.nombre;
            document.getElementById('telefono').value = client.telefono;
            document.getElementById('tipoOperacion').value = client.tipoOperacion || 'venta';
            document.getElementById('direccion').value = client.direccion;
            document.getElementById('linkPropiedad').value = client.linkPropiedad || '';
            document.getElementById('fechaLlamada').value = client.fechaLlamada;
            document.getElementById('nota').value = client.nota;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteClient(index) {
            if (confirm('驴Eliminar este cliente?')) {
                clients.splice(index, 1);
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                populateMonthSelector();
                if (isAdmin) populateAgentSelector();
            }
        }

        function resetForm() { document.getElementById('clientForm').reset(); editingIndex = -1; }

        // ============ STATS ============
        function switchStatsTab(tab) {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            event.target.classList.add('active');
            document.getElementById('statsGeneral').style.display = tab === 'general' ? 'block' : 'none';
            document.getElementById('statsAgent').style.display = tab === 'agent' ? 'block' : 'none';
            document.getElementById('statsMonthly').style.display = tab === 'monthly' ? 'block' : 'none';
            if (tab === 'agent' && isAdmin) { populateAgentSelector(); updateAgentsSummary(); updateAgentsLastLogin(); }
            if (tab === 'monthly' && isAdmin) { populateMonthlyAgentSelector(); }
        }

        function filterStats(tipo) {
            statsFilter = tipo;
            document.getElementById('filterAll').classList.toggle('active', tipo === 'all');
            document.getElementById('filterVentas').classList.toggle('active', tipo === 'venta');
            document.getElementById('filterAlquileres').classList.toggle('active', tipo === 'alquiler');
            
            // Mostrar/ocultar estadisticas segun tipo
            var soloVentas = tipo === 'alquiler';
            document.getElementById('rowPreTasacion').style.display = soloVentas ? 'none' : 'flex';
            document.getElementById('rowTasacionEntregada').style.display = soloVentas ? 'none' : 'flex';
            document.getElementById('rowAceptaTasacion').style.display = soloVentas ? 'none' : 'flex';
            document.getElementById('rowExclusiva').style.display = soloVentas ? 'none' : 'flex';
            document.getElementById('rowPublicadas').style.display = soloVentas ? 'none' : 'flex';
            
            // Cambiar texto de vendidas/alquiladas
            var labelVendidas = document.getElementById('labelVendidas');
            if (tipo === 'venta') {
                labelVendidas.textContent = 'Vendidas';
            } else if (tipo === 'alquiler') {
                labelVendidas.textContent = 'Alquiladas';
            } else {
                labelVendidas.textContent = 'Vendidas/Alquiladas';
            }
            
            updateStats();
        }

        function updateStats() {
            var llamados = 0, respuestas = 0, preTasacion = 0, tasacionEntregada = 0, aceptaTasacion = 0, exclusivas = 0, publicadas = 0, vendidas = 0, totalLlamadas = 0;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== currentAgent) continue;
                if (statsFilter !== 'all' && client.tipoOperacion !== statsFilter) continue;
                var s = client.seguimiento;
                if (s.seLlamo === true) llamados++;
                if (s.huboRespuesta === true) respuestas++;
                if (s.aceptaPreTasacion === true && client.tipoOperacion === 'venta') preTasacion++;
                if (s.tasacionEntregada === true) tasacionEntregada++;
                if (s.aceptaTasacion === true) aceptaTasacion++;
                if (s.tipoExclusiva) exclusivas++;
                if (s.publicaste === true) publicadas++;
                if (s.vendida) vendidas++;
                totalLlamadas += client.cantidadLlamadas || 0;
            }
            document.getElementById('statLlamado').textContent = llamados;
            document.getElementById('statRespuesta').textContent = respuestas;
            document.getElementById('statPreTasacion').textContent = preTasacion;
            document.getElementById('statTasacionEntregada').textContent = tasacionEntregada;
            document.getElementById('statAceptaTasacion').textContent = aceptaTasacion;
            document.getElementById('statExclusiva').textContent = exclusivas;
            document.getElementById('statPublicadas').textContent = publicadas;
            document.getElementById('statVendidas').textContent = vendidas;
            document.getElementById('totalLlamadas').textContent = totalLlamadas;
            
            // Actualizar el TOP de agentes para todos
            updateTopAgents();
        }

        function getUniqueAgents() {
            var agents = {};
            for (var i = 0; i < clients.length; i++) { if (clients[i].agente) agents[clients[i].agente] = true; }
            return Object.keys(agents).sort();
        }

        function populateAgentSelector() {
            var selector = document.getElementById('agentSelector');
            var agents = getUniqueAgents();
            selector.innerHTML = '<option value="">Seleccionar agente...</option>';
            for (var i = 0; i < agents.length; i++) { var opt = document.createElement('option'); opt.value = agents[i]; opt.textContent = agents[i]; selector.appendChild(opt); }
        }

        function filterAgentStats(tipo) {
            agentStatsFilter = tipo;
            document.getElementById('agentFilterAll').classList.toggle('active', tipo === 'all');
            document.getElementById('agentFilterVentas').classList.toggle('active', tipo === 'venta');
            document.getElementById('agentFilterAlquileres').classList.toggle('active', tipo === 'alquiler');
            
            var soloAlquiler = tipo === 'alquiler';
            document.getElementById('agentRowTasaciones').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowExclusivas').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowNoExclusivas').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowPublicadas').style.display = soloAlquiler ? 'none' : 'flex';
            
            var labelVentas = document.getElementById('agentLabelVentas');
            if (tipo === 'venta') {
                labelVentas.textContent = 'Ventas';
            } else if (tipo === 'alquiler') {
                labelVentas.textContent = 'Alquileres';
            } else {
                labelVentas.textContent = 'Ventas/Alquileres';
            }
            
            updateAgentStats();
        }

        function updateAgentStats() {
            var agentName = document.getElementById('agentSelector').value;
            var content = document.getElementById('agentStatsContent');
            var filterBtns = document.getElementById('agentFilterBtns');
            if (!agentName) { content.style.display = 'none'; filterBtns.style.display = 'none'; return; }
            content.style.display = 'block';
            filterBtns.style.display = 'flex';
            
            var clientes = 0, llamadas = 0, tasaciones = 0, exclusivas = 0, noExclusivas = 0, publicadas = 0, ventas = 0;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== agentName) continue;
                if (agentStatsFilter !== 'all' && client.tipoOperacion !== agentStatsFilter) continue;
                clientes++;
                llamadas += client.cantidadLlamadas || 0;
                if (client.seguimiento.tasacionEntregada === true) tasaciones++;
                if (client.seguimiento.tipoExclusiva) {
                    if (client.seguimiento.tipoExclusiva === 'No Exclusiva') {
                        noExclusivas++;
                    } else {
                        exclusivas++;
                    }
                }
                if (client.seguimiento.publicaste === true) publicadas++;
                if (client.seguimiento.vendida) ventas++;
            }
            document.getElementById('agentClientes').textContent = clientes;
            document.getElementById('agentLlamadas').textContent = llamadas;
            document.getElementById('agentTasaciones').textContent = tasaciones;
            document.getElementById('agentExclusivas').textContent = exclusivas;
            document.getElementById('agentNoExclusivas').textContent = noExclusivas;
            document.getElementById('agentPublicadas').textContent = publicadas;
            document.getElementById('agentVentas').textContent = ventas;
        }

        function getAgentScore(agentName) {
            var llamadas = 0, tasaciones = 0, exclusivas = 0, noExclusivas = 0, ventas = 0;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== agentName) continue;
                llamadas += client.cantidadLlamadas || 0;
                if (client.seguimiento.tasacionEntregada === true) tasaciones++;
                if (client.seguimiento.tipoExclusiva) {
                    if (client.seguimiento.tipoExclusiva === 'No Exclusiva') {
                        noExclusivas++;
                    } else {
                        exclusivas++;
                    }
                }
                if (client.seguimiento.vendida) ventas++;
            }
            // Puntuaci贸n: ventas*50 + exclusivas*30 + tasaciones*20 + llamadas*1
            var score = (ventas * 50) + (exclusivas * 30) + (tasaciones * 20) + (llamadas * 1);
            return { llamadas: llamadas, tasaciones: tasaciones, exclusivas: exclusivas, noExclusivas: noExclusivas, ventas: ventas, score: score };
        }

        function updateTopAgents() {
            var agents = getUniqueAgents();
            var agentScores = [];
            
            for (var i = 0; i < agents.length; i++) {
                var stats = getAgentScore(agents[i]);
                agentScores.push({ name: agents[i], stats: stats });
            }
            
            agentScores.sort(function(a, b) { return b.stats.score - a.stats.score; });
            
            var html = '';
            var limit = Math.min(10, agentScores.length);
            
            for (var j = 0; j < limit; j++) {
                var agent = agentScores[j];
                var posClass = '';
                var posEmoji = (j + 1) + '.';
                
                if (j === 0) { posClass = 'gold'; posEmoji = 'TOP 1'; }
                else if (j === 1) { posClass = 'silver'; posEmoji = 'TOP 2'; }
                else if (j === 2) { posClass = 'bronze'; posEmoji = 'TOP 3'; }
                
                html += '<div class="top-agent ' + posClass + '">' +
                    '<div class="top-position">' + posEmoji + '</div>' +
                    '<div class="top-info">' +
                        '<div class="top-name">' + agent.name + '</div>' +
                        '<div class="top-stats">Llam: ' + agent.stats.llamadas + ' | Tas: ' + agent.stats.tasaciones + ' | Exc: ' + agent.stats.exclusivas + ' | Ven: ' + agent.stats.ventas + '</div>' +
                    '</div>' +
                    '<div class="top-score">' + agent.stats.score + ' pts</div>' +
                '</div>';
            }
            
            var contentHtml = html || '<p style="color:#666">No hay agentes</p>';
            
            // Actualizar el TOP en la vista general (visible para todos)
            var containerGeneral = document.getElementById('topAgentsGeneral');
            if (containerGeneral) {
                containerGeneral.innerHTML = contentHtml;
            }
        }

        function updateAgentsSummary() {
            var agents = getUniqueAgents();
            var container = document.getElementById('agentsSummary');
            var html = '';
            for (var i = 0; i < agents.length; i++) {
                var agent = agents[i];
                var stats = getAgentScore(agent);
                html += '<div class="stat-row" style="flex-wrap: wrap; gap: 5px;">' +
                    '<span class="stat-label" style="flex: 1; min-width: 100px;">' + agent + '</span>' +
                    '<span class="stat-value" style="font-size: 0.8em; text-align: right;">Llam: ' + stats.llamadas + ' | Tas: ' + stats.tasaciones + ' | Exc: ' + stats.exclusivas + ' | NoExc: ' + stats.noExclusivas + ' | Ven: ' + stats.ventas + '</span>' +
                '</div>';
            }
            container.innerHTML = html || '<p style="color:#666">No hay agentes</p>';
        }

        function populateMonthlyAgentSelector() {
            var selector = document.getElementById('monthlyAgentSelector');
            var agents = getUniqueAgents();
            selector.innerHTML = '<option value="all">Todos los agentes</option>';
            for (var i = 0; i < agents.length; i++) {
                var opt = document.createElement('option');
                opt.value = agents[i];
                opt.textContent = agents[i];
                selector.appendChild(opt);
            }
        }

        function updateAgentsLastLogin() {
            var container = document.getElementById('agentsLastLogin');
            var html = '';
            
            // Ordenar usuarios por ultima sesion (mas reciente primero)
            var sortedUsers = users.slice().sort(function(a, b) {
                var dateA = a.lastLogin ? new Date(a.lastLogin) : new Date(0);
                var dateB = b.lastLogin ? new Date(b.lastLogin) : new Date(0);
                return dateB - dateA;
            });
            
            for (var i = 0; i < sortedUsers.length; i++) {
                var user = sortedUsers[i];
                var lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Nunca';
                var isOnline = user.username === currentAgent ? ' (En linea)' : '';
                var statusClass = user.username === currentAgent ? 'color: #28a745; font-weight: bold;' : '';
                html += '<div class="stat-row"><span class="stat-label">' + user.username + isOnline + '</span><span class="stat-value" style="font-size: 0.85em; ' + statusClass + '">' + lastLogin + '</span></div>';
            }
            container.innerHTML = html || '<p style="color:#666">No hay agentes registrados</p>';
        }

        function formatDateTime(isoString) {
            var date = new Date(isoString);
            var dia = String(date.getDate()).padStart(2, '0');
            var mes = String(date.getMonth() + 1).padStart(2, '0');
            var anio = date.getFullYear();
            var hora = String(date.getHours()).padStart(2, '0');
            var min = String(date.getMinutes()).padStart(2, '0');
            return dia + '/' + mes + '/' + anio + ' ' + hora + ':' + min;
        }

        function populateMonthSelector() {
            var selector = document.getElementById('mesSelector');
            var mesesUnicos = {};
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (!isAdmin && client.agente !== currentAgent) continue;
                if (client.fechaCreacion) { var f = new Date(client.fechaCreacion); mesesUnicos[f.getFullYear() + '-' + String(f.getMonth() + 1).padStart(2, '0')] = true; }
                if (client.historialLlamadas) { for (var j = 0; j < client.historialLlamadas.length; j++) { if (client.historialLlamadas[j].fecha) { var fc = new Date(client.historialLlamadas[j].fecha); mesesUnicos[fc.getFullYear() + '-' + String(fc.getMonth() + 1).padStart(2, '0')] = true; } } }
                if (client.venta && client.venta.fecha) { var fv = new Date(client.venta.fecha); mesesUnicos[fv.getFullYear() + '-' + String(fv.getMonth() + 1).padStart(2, '0')] = true; }
            }
            var mesesArray = Object.keys(mesesUnicos).sort().reverse();
            selector.innerHTML = '<option value="">Seleccionar mes...</option>';
            var nombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            for (var k = 0; k < mesesArray.length; k++) { var parts = mesesArray[k].split('-'); var opt = document.createElement('option'); opt.value = mesesArray[k]; opt.textContent = nombres[parseInt(parts[1]) - 1] + ' ' + parts[0]; selector.appendChild(opt); }
        }

        function updateMonthlyStats() {
            var mesSeleccionado = document.getElementById('mesSelector').value;
            var statsDiv = document.getElementById('monthlyStats');
            if (!mesSeleccionado) { statsDiv.style.display = 'none'; return; }
            statsDiv.style.display = 'block';
            var parts = mesSeleccionado.split('-');
            var year = parseInt(parts[0]), month = parseInt(parts[1]);
            var clientesNuevos = 0, llamadasMes = 0, tasacionesMes = 0, ventasMes = 0;
            
            var selectedAgent = isAdmin ? document.getElementById('monthlyAgentSelector').value : currentAgent;
            
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (selectedAgent !== 'all' && client.agente !== selectedAgent) continue;
                if (!isAdmin && client.agente !== currentAgent) continue;
                if (client.fechaCreacion) { var fc = new Date(client.fechaCreacion); if (fc.getFullYear() === year && fc.getMonth() + 1 === month) clientesNuevos++; }
                if (client.historialLlamadas) { for (var j = 0; j < client.historialLlamadas.length; j++) { if (client.historialLlamadas[j].fecha) { var fl = new Date(client.historialLlamadas[j].fecha); if (fl.getFullYear() === year && fl.getMonth() + 1 === month) llamadasMes++; } } }
                if (client.seguimiento.fechaEntrega) { var fe = new Date(client.seguimiento.fechaEntrega); if (fe.getFullYear() === year && fe.getMonth() + 1 === month) tasacionesMes++; }
                if (client.venta && client.venta.fecha) { var fv = new Date(client.venta.fecha); if (fv.getFullYear() === year && fv.getMonth() + 1 === month) ventasMes++; }
            }
            document.getElementById('monthlyNewClients').textContent = clientesNuevos;
            document.getElementById('monthlyCallsMade').textContent = llamadasMes;
            document.getElementById('monthlyTasaciones').textContent = tasacionesMes;
            document.getElementById('monthlySales').textContent = ventasMes;
        }

        function showSaveIndicator() {
            var ind = document.getElementById('saveIndicator');
            ind.style.display = 'block';
            setTimeout(function() { ind.style.display = 'none'; }, 2000);
        }

        function downloadBackup() {
            var data = JSON.stringify({ clients: clients, users: users }, null, 2);
            var blob = new Blob([data], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'backup_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Respaldo descargado');
        }

        function uploadBackup(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('驴Cargar respaldo? Reemplazar谩 los datos actuales.')) {
                        if (data.clients) clients = data.clients;
                        else if (Array.isArray(data)) clients = data;
                        if (data.users) users = data.users;
                        migrateOldData();
                        saveToFirebase();
                        saveUsersToFirebase();
                        displayClients();
                        updateStats();
                        populateMonthSelector();
                        if (isAdmin) populateAgentSelector();
                        alert(' Respaldo cargado');
                    }
                } catch (err) { alert(' Error al leer archivo'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.onclick = function(event) {
            var modals = ['followUpModal', 'saleModal', 'callModal', 'passwordModal'];
            for (var i = 0; i < modals.length; i++) { var modal = document.getElementById(modals[i]); if (event.target === modal) { modal.style.display = 'none'; if (modals[i] !== 'callModal') currentClientIndex = -1; } }
        }
    </script>
</body>
</html>
