<!DOCTYPE html>
<!--
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    Gesti√≥n de Clientes - Sistema de Gesti√≥n de Clientes
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    Copyright (c) 2025 Anibal Malave
    Todos los derechos reservados.
    
    Este c√≥digo es propiedad de Anibal Malave.
    Queda prohibida su copia, modificaci√≥n o distribuci√≥n
    sin autorizaci√≥n expresa del autor.
    
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#d2a94d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Gesti√≥n de Clientes - Gesti√≥n de clientes y propiedades">
    <meta name="mobile-web-app-capable" content="yes">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="author" content="Anibal Malave">
    <meta name="copyright" content="Copyright (c) 2025 Anibal Malave. Todos los derechos reservados.">
    <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
    <title>Gesti√≥n de Clientes</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        /* Optimizaciones de rendimiento */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f2d26e 0%, #c2943b 100%);
            padding: 20px;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }
        /* Optimizaci√≥n para im√°genes */
        img { max-width: 100%; height: auto; display: block; }
        /* Mejoras de accesibilidad t√°ctil */
        button, a, input, select, textarea { 
            touch-action: manipulation;
        }
        button, .btn { 
            min-height: 44px; 
            cursor: pointer;
        }
        /* Reducir repaints en animaciones */
        .client-card, .modal, .btn {
            will-change: transform;
            transform: translateZ(0);
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }
        .header h1 { font-size: 2em; margin-bottom: 10px; }
        .agent-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9em;
        }
        .agent-info .agent-name-line {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-wrap: nowrap;
        }
        .agent-info .agent-badges-line {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .admin-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75em;
        }
        .sync-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            margin-left: 10px;
        }
        .sync-online { background: #28a745; }
        .sync-offline { background: #dc3545; }
        .sync-syncing { background: #ffc107; color: #333; }
        /* Menu Hamburguesa */
        .menu-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        .hamburger-btn {
            background: white;
            color: #b6802d;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            flex-direction: column;
            gap: 4px;
            transition: transform 0.2s;
        }
        .hamburger-btn:hover { transform: scale(1.05); }
        .hamburger-btn span {
            display: block;
            width: 22px;
            height: 3px;
            background: #b6802d;
            border-radius: 2px;
            transition: all 0.3s;
        }
        .hamburger-btn.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .hamburger-btn.active span:nth-child(2) { opacity: 0; }
        .hamburger-btn.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 55px;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            min-width: 200px;
            overflow: hidden;
            z-index: 1001;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item {
            display: block;
            width: 100%;
            padding: 15px 20px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 0.95em;
            color: #333;
            transition: background 0.2s;
            border-bottom: 1px solid #eee;
        }
        .dropdown-item:last-child { border-bottom: none; }
        .dropdown-item:hover { background: #f8f9fa; }
        .dropdown-item.danger { color: #dc3545; }
        .dropdown-item.danger:hover { background: #f8d7da; }
        .dropdown-item i { margin-right: 10px; }
        .content { display: grid; grid-template-columns: 1fr 380px; gap: 0; }
        .form-section { padding: 30px; border-right: 2px solid #e0e0e0; }
        .stats-section { padding: 30px; background: #f8f9fa; }
        .chat-header { margin-bottom: 15px; }
        .chat-tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .chat-tab { 
            flex: 1; 
            padding: 8px; 
            border: none; 
            background: #e9ecef; 
            cursor: pointer; 
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .chat-tab.active { background: #d2a94d; color: white; }
        .online-users { 
            background: #f8f9fa; 
            border-radius: 10px; 
            padding: 10px; 
            margin-bottom: 15px;
            max-height: 150px;
            overflow-y: auto;
        }
        .online-user {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        .online-user:hover { background: #e9ecef; }
        .online-user.selected { background: #d2a94d22; }
        .online-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #28a745;
        }
        .online-indicator.offline { background: #6c757d; }
        .online-user-name { font-size: 0.9em; flex: 1; }
        .online-user-office { font-size: 0.7em; color: #666; }
        .chat-messages {
            flex: 1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 10px;
            overflow-y: auto;
            margin-bottom: 10px;
            min-height: 200px;
        }
        .chat-message {
            margin-bottom: 10px;
            max-width: 85%;
        }
        .chat-message.sent {
            margin-left: auto;
            text-align: right;
        }
        .chat-message-bubble {
            display: inline-block;
            padding: 8px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }
        .chat-message.sent .chat-message-bubble {
            background: #d2a94d;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .chat-message.received .chat-message-bubble {
            background: white;
            border: 1px solid #ddd;
            border-bottom-left-radius: 5px;
        }
        .chat-message-sender {
            font-size: 0.75em;
            color: #666;
            margin-bottom: 2px;
        }
        .chat-message-time {
            font-size: 0.7em;
            color: #999;
            margin-top: 2px;
        }
        .chat-input-container {
            display: flex;
            gap: 8px;
        }
        .chat-input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .chat-input-container button {
            background: #d2a94d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
        }
        .unread-badge {
            background: #dc3545;
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
        }
        .form-group input[type="text"],
        .form-group input[type="tel"],
        .form-group input[type="email"],
        .form-group input[type="date"],
        .form-group input[type="time"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #d2a94d;
        }
        .form-group textarea { resize: vertical; min-height: 80px; }
        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%); color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .stats-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        #statsContent, #totalCallsSection {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stats-card h3 {
            color: #c2943b;
            margin-bottom: 15px;
            font-size: 1.1em;
            border-bottom: 2px solid #c2943b;
            padding-bottom: 10px;
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { font-weight: 500; color: #555; }
        .stat-value { font-weight: 700; color: #b6802d; font-size: 1.1em; }
        .clients-list { margin-top: 30px; }
        .client-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #d2a94d;
            transition: all 0.3s;
        }
        .client-card:hover { box-shadow: 0 3px 10px rgba(0,0,0,0.1); }
        .client-card-compact {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }
        .client-photo {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, #d2a94d, #b6802d);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.1em;
            flex-shrink: 0;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .client-photo:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .client-compact-info {
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .client-compact-header {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: nowrap;
            white-space: nowrap;
            overflow: hidden;
        }
        .client-name { 
            font-size: 1.1em; 
            font-weight: 700; 
            color: #333; 
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-shrink: 1;
            min-width: 0;
        }
        .client-name:hover { color: #b6802d; }
        .client-compact-stage {
            font-size: 0.8em;
            color: #666;
            margin-top: 3px;
            display: flex;
            align-items: center;
            flex-wrap: nowrap;
            white-space: nowrap;
            overflow: hidden;
            min-height: 24px;
        }
        .client-expand-icon {
            font-size: 1.2em;
            color: #999;
            transition: transform 0.3s;
        }
        .client-card.expanded .client-expand-icon {
            transform: rotate(180deg);
        }
        .client-details {
            display: none;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .client-card.expanded .client-details {
            display: block;
        }
        .client-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }
        .client-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
        .btn-small {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.85em;
            cursor: pointer;
            font-weight: 600;
        }
        .btn-edit { background: #ffc107; color: #333; }
        .btn-delete { background: #dc3545; color: white; }
        .btn-follow { background: #d2a94d; color: white; }
        .btn-call { background: #17a2b8; color: white; }
        .client-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 0.9em; }
        .info-item { color: #666; }
        .info-label { font-weight: 600; color: #333; }
        .stage-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            margin-top: 10px;
        }
        .type-badge, .agent-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .type-venta { background: #4caf50; color: white; }
        .type-alquiler { background: #2196f3; color: white; }
        .agent-badge { background: #6c757d; color: white; font-size: 0.7em; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
        .stage-inicial { background: #f2d26e; color: #5a4a1f; }
        .stage-respuesta { background: #e2bd5d; color: #4a3d15; }
        .stage-pretasacion { background: #d2a94d; color: #3a2f0f; }
        .stage-tasacion { background: #c2943b; color: #2a2109; }
        .stage-exclusiva { background: #b6802d; color: #1f1805; }
        .stage-publicada { background: #9a6b24; color: #ffffff; }
        .stage-vendida { background: #7a5619; color: #ffffff; }
        .stage-archivada { background: #6c757d; color: #ffffff; }
        .stage-pendiente { background: #ffc107; color: #5a4a1f; }
        .stage-seguimiento { background: #17a2b8; color: #ffffff; }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #d2a94d;
        }
        .modal-header h2 { color: #b6802d; margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .stage-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .stage-title { font-size: 1.3em; font-weight: 700; color: #b6802d; margin-bottom: 15px; }
        .radio-group { display: flex; gap: 20px; margin: 15px 0; flex-wrap: wrap; }
        .radio-item { display: flex; align-items: center; }
        .radio-item input[type="radio"] { width: 20px; height: 20px; margin-right: 8px; cursor: pointer; }
        .radio-item label { cursor: pointer; font-weight: 500; }
        .checkbox-group { display: flex; flex-direction: column; gap: 10px; margin: 15px 0; }
        .checkbox-item { display: flex; align-items: center; }
        .checkbox-item input[type="checkbox"] { width: 20px; height: 20px; margin-right: 8px; cursor: pointer; }
        .checkbox-item label { cursor: pointer; font-weight: 500; }
        .total-calls {
            background: linear-gradient(135deg, #d2a94d 0%, #b6802d 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            margin-top: 15px;
        }
        .total-calls-number { font-size: 2.5em; font-weight: 700; margin: 5px 0; }
        .alert-box { padding: 15px; border-radius: 8px; margin-top: 15px; font-weight: 600; }
        .alert-warning { background: #fff3cd; color: #856404; border: 2px solid #ffc107; }
        .alert-info { background: #d1ecf1; color: #0c5460; border: 2px solid #17a2b8; }
        .timestamp-display {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #1565c0;
        }
        .save-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: none;
            animation: fadeInOut 2s;
            z-index: 999;
        }
        @keyframes fadeInOut { 0%, 100% { opacity: 0; } 10%, 90% { opacity: 1; } }
        .call-history {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .call-history h4 { color: #1565c0; margin-bottom: 10px; }
        .call-item {
            padding: 8px;
            background: white;
            border-radius: 5px;
            margin-bottom: 5px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .call-item .delete-call {
            background: #dc3545;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8em;
        }
        /* Login Screen */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }
        .login-box h2 {
            color: #b6802d;
            text-align: center;
            margin-bottom: 30px;
        }
        .login-box .btn {
            width: 100%;
            margin-top: 10px;
        }
        .login-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        .login-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.3s;
        }
        .login-tab.active {
            color: #b6802d;
            border-bottom-color: #b6802d;
        }
        .login-tab:hover { color: #b6802d; }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .error-msg {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .success-msg {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .tab {
            padding: 8px 15px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: background 0.2s;
        }
        .tab.active { background: #d2a94d; color: white; }
        .tab:hover { background: #c2943b; color: white; }
        .filter-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 8px;
        }
        .filter-section select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .client-tabs {
            display: flex;
            gap: 10px;
        }
        .client-tab {
            padding: 8px 16px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.2s;
        }
        .client-tab.active {
            background: #d2a94d;
            color: white;
        }
        .client-tab:hover {
            background: #c2943b;
            color: white;
        }
        .archived-count {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        .note-container {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .note-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .note-text.expanded {
            display: block;
            -webkit-line-clamp: unset;
        }
        .ver-mas-btn {
            background: none;
            border: none;
            color: #b6802d;
            cursor: pointer;
            font-weight: 600;
            padding: 5px 0;
            font-size: 0.85em;
        }
        .ver-mas-btn:hover {
            text-decoration: underline;
        }
        .btn-restore {
            background: #28a745;
            color: white;
        }
        .stats-filter-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }
        .stats-filter-btn {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #d2a94d;
            background: white;
            color: #b6802d;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85em;
            transition: all 0.2s;
        }
        .stats-filter-btn.active {
            background: #d2a94d;
            color: white;
        }
        .stats-filter-btn:hover {
            background: #f2d26e;
        }
        .top-agent {
            display: flex;
            flex-direction: column;
            padding: 12px 15px;
            margin-bottom: 8px;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .top-agent:hover {
            transform: translateX(3px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .top-agent.gold {
            background: linear-gradient(135deg, #ffd700 0%, #ffec8b 100%);
            font-weight: bold;
        }
        .top-agent.silver {
            background: linear-gradient(135deg, #c0c0c0 0%, #e8e8e8 100%);
            font-weight: bold;
        }
        .top-agent.bronze {
            background: linear-gradient(135deg, #cd7f32 0%, #daa06d 100%);
            color: white;
            font-weight: bold;
        }
        .top-header-row {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }
        .top-position {
            font-size: 1.3em;
            flex-shrink: 0;
        }
        .top-name {
            font-weight: 600;
            color: #333;
            font-size: 0.95em;
            flex: 1;
            white-space: nowrap;
        }
        .top-expand-icon {
            font-size: 0.65em;
            color: #888;
            margin-left: 4px;
        }
        .top-agent.bronze .top-name {
            color: white;
        }
        .top-agent.bronze .top-expand-icon {
            color: #f0e6d3;
        }
        .top-score {
            font-size: 1em;
            font-weight: bold;
            color: #b6802d;
            white-space: nowrap;
            flex-shrink: 0;
            background: rgba(255,255,255,0.85);
            padding: 5px 10px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .top-agent.gold .top-score {
            background: rgba(255,255,255,0.95);
        }
        .top-agent.silver .top-score {
            background: rgba(255,255,255,0.95);
        }
        .top-agent.bronze .top-score {
            color: #5a3d1a;
            background: rgba(255,255,255,0.95);
        }
        .top-stats-detail {
            width: 100%;
            padding-top: 6px;
            margin-top: 6px;
            border-top: 1px dashed rgba(0,0,0,0.15);
            font-size: 0.8em;
            color: #555;
            text-align: center;
            letter-spacing: -0.5px;
        }
        .top-agent.bronze .top-stats-detail {
            border-top-color: rgba(255,255,255,0.3);
            color: #f0e6d3;
        }
        .top-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            font-size: 11px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            padding: 0;
            line-height: 1;
            opacity: 0.7;
            transition: opacity 0.2s;
            margin-left: 5px;
        }
        .top-remove-btn:hover {
            opacity: 1;
        }
        /* Config Modal */
        .config-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .config-section h3 { color: #856404; margin-bottom: 15px; }
        .config-section code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
        }
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #e0e0e0;
            border-top-color: #b6802d;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 15px; color: #666; font-weight: 600; }
        @media (max-width: 1024px) {
            .content { grid-template-columns: 1fr; }
            .form-section { border-right: none; border-bottom: 2px solid #e0e0e0; }
            .agent-info { position: static; margin-bottom: 15px; text-align: center; }
            .agent-info .agent-name-line { justify-content: center; }
            .agent-info .agent-badges-line { justify-content: center; }
        }
        @media (max-width: 768px) {
            body { padding: 8px; }
            .header { padding: 12px; }
            .header h1 { font-size: 1.2em; }
            .menu-container { top: 8px; right: 8px; }
            .agent-info { position: static; margin-bottom: 8px; text-align: center; background: rgba(255,255,255,0.15); padding: 8px 12px; font-size: 0.85em; border-radius: 10px; }
            .agent-info .agent-name-line { justify-content: center; font-size: 0.95em; }
            .agent-info .agent-badges-line { justify-content: center; margin-top: 4px; gap: 4px; }
            .agent-info .agent-badges-line span { font-size: 0.7em !important; padding: 2px 6px !important; }
            .form-section, .stats-section { padding: 12px; }
            .form-group input, .form-group select, .form-group textarea { padding: 12px; font-size: 16px; }
            .btn-group { flex-direction: column; gap: 8px; }
            .client-info { grid-template-columns: 1fr; }
            .client-header { flex-direction: column; align-items: flex-start; }
            .client-actions { width: 100%; justify-content: flex-start; margin-top: 8px; flex-wrap: wrap; }
            .btn-small { padding: 10px 14px; font-size: 0.9em; min-height: 44px; }
            .tabs { flex-wrap: wrap; gap: 4px; }
            .tab { padding: 10px 14px; font-size: 0.85em; min-height: 44px; }
            .modal-content { margin: 0; padding: 15px; width: 100%; max-height: 100vh; border-radius: 0; }
            .modal { padding: 0; }
            .top-agent { padding: 10px 12px; }
            .top-header-row { gap: 6px; }
            .top-position { font-size: 1.2em; }
            .top-score { font-size: 0.85em; padding: 4px 8px; }
            .top-stats-detail { font-size: 0.75em; }
            .top-name { font-size: 0.85em; }
            .top-expand-icon { font-size: 0.6em; }
            .top-remove-btn { width: 20px; height: 20px; min-height: 20px; font-size: 12px; }
            .contact-btn { padding: 10px 14px; min-height: 44px; }
            .client-card-compact { padding: 10px; }
            .client-compact-header { gap: 5px; }
            .client-compact-stage { font-size: 0.7em; min-height: 22px; }
            .client-name { font-size: 1em; }
            .type-badge, .agent-badge { padding: 2px 6px; font-size: 0.65em; margin-left: 5px; }
            .agent-badge { max-width: 80px; }
            .stage-badge { padding: 2px 6px !important; font-size: 0.65em !important; }
            .support-chat { width: calc(100vw - 20px); right: 10px; bottom: 80px; }
        }
        @media (max-width: 480px) {
            body { padding: 5px; }
            .header { padding: 10px; }
            .header h1 { font-size: 1.1em; }
            .container { border-radius: 10px; }
            .agent-info { padding: 6px 10px; font-size: 0.8em; }
            .agent-info .agent-name-line { font-size: 0.9em; }
            .agent-info .agent-badges-line span { font-size: 0.65em !important; }
            .form-section, .stats-section { padding: 10px; }
            .client-card { margin-bottom: 10px; }
            .stats-card { padding: 12px; }
            .top-agent { padding: 8px 10px; }
            .top-header-row { gap: 5px; }
            .top-stats-detail { font-size: 0.65em; letter-spacing: -0.5px; }
            .top-name { font-size: 0.8em; }
            .top-position { font-size: 1.1em; }
            .top-score { font-size: 0.75em; padding: 3px 6px; }
            .top-expand-icon { font-size: 0.55em; }
            .client-compact-stage { font-size: 0.65em; }
            .client-name { font-size: 0.95em; }
            .type-badge, .agent-badge { padding: 2px 5px; font-size: 0.6em; }
            .agent-badge { max-width: 70px; }
        }
        /* Preferencias de movimiento reducido */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            html { scroll-behavior: auto; }
        }
        /* Soporte T√©cnico */
        .support-bubble {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            font-size: 1.5em;
            transition: transform 0.2s;
        }
        .support-bubble:hover { transform: scale(1.1); }
        .support-inbox-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 30px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1000;
        }
        .support-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc3545;
            color: white;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.75em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .support-chat {
            position: fixed;
            bottom: 90px;
            right: 20px;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.3);
            z-index: 1001;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .support-chat.show { display: flex; }
        .support-chat-messages {
            height: 300px;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }
        .support-message {
            margin-bottom: 12px;
            max-width: 85%;
        }
        .support-message.sent {
            margin-left: auto;
            text-align: right;
        }
        .support-message.sent > div:first-child {
            background: #17a2b8;
            color: white;
            padding: 10px 15px;
            border-radius: 15px 15px 0 15px;
            display: inline-block;
        }
        .support-message.received > div:first-child {
            background: white;
            padding: 10px 15px;
            border-radius: 15px 15px 15px 0;
            display: inline-block;
            border: 1px solid #e0e0e0;
        }
        .support-message-time {
            font-size: 0.75em;
            color: #999;
            margin-top: 3px;
        }
        /* Botones de contacto */
        .contact-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .contact-btn {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            border: none;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .contact-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .btn-call-phone {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        .btn-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }
        .btn-maps {
            background: linear-gradient(135deg, #4285F4, #1a73e8);
            color: white;
        }
        .btn-email {
            background: linear-gradient(135deg, #EA4335, #c5221f);
            color: white;
        }
        .btn-link {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
        }
        /* Paginaci√≥n */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        .pagination button {
            padding: 10px 15px;
            border: 2px solid #d2a94d;
            background: white;
            color: #b6802d;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .pagination button:hover:not(:disabled) {
            background: #d2a94d;
            color: white;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination .page-info {
            font-weight: 600;
            color: #666;
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text">üîÑ Conectando con la base de datos...</div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen" style="display: none;">
        <div class="login-box">
            <h2>üè† Gesti√≥n de Clientes</h2>
            
            <div class="login-tabs">
                <div class="login-tab active" onclick="switchLoginTab('login')">Iniciar Sesi√≥n</div>
                <div class="login-tab" onclick="switchLoginTab('register')">üìù Registrarse</div>
            </div>

            <div id="errorMsg" class="error-msg"></div>
            <div id="successMsg" class="success-msg"></div>

            <!-- Login Form -->
            <div id="loginForm" class="login-form active">
                <div class="form-group">
                    <label for="loginUsername">Usuario</label>
                    <input type="text" id="loginUsername" placeholder="Nombre Apellido...">
                </div>
                <div class="form-group">
                    <label for="loginPassword">Contrase√±a</label>
                    <input type="password" id="loginPassword" placeholder="Tu n√∫mero de tel√©fono...">
                </div>
                <button class="btn btn-primary" onclick="login()">Iniciar Sesion</button>
            </div>

            <!-- Register Form -->
            <div id="registerForm" class="login-form">
                <div style="display: flex; gap: 10px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="regNombre">Nombre *</label>
                        <input type="text" id="regNombre" placeholder="Ej: Juan">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="regApellido">Apellido *</label>
                        <input type="text" id="regApellido" placeholder="Ej: Perez">
                    </div>
                </div>
                <div class="form-group">
                    <label for="regCedula">C√©dula de Identidad *</label>
                    <input type="text" id="regCedula" placeholder="Ej: 12345678...">
                    <small style="color: #666; font-size: 0.8em;">No podr√°s crear otra cuenta con esta c√©dula</small>
                </div>
                <div class="form-group">
                    <label for="regTelefono">Tel√©fono (Contrase√±a) *</label>
                    <input type="tel" id="regTelefono" placeholder="Ej: 094000000...">
                    <small style="color: #666; font-size: 0.8em;">Este n√∫mero ser√° tu contrase√±a para ingresar</small>
                </div>
                <div class="form-group">
                    <label for="regOficina">Oficina *</label>
                    <select id="regOficina" required>
                        <option value="">Seleccionar oficina...</option>
                        <option value="imperium_harmony">üè¢ Imperium Harmony</option>
                    </select>
                </div>
                <button class="btn btn-success" onclick="register()">Registrarse</button>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <div class="container">
            <div class="header">
                <div class="agent-info">
                    <div class="agent-name-line">
                        <strong>üë§ Agente:</strong>
                        <span id="currentAgentDisplay"></span>
                    </div>
                    <div class="agent-badges-line">
                        <span id="adminBadge" class="admin-badge" style="display: none;">üëë ADMIN</span>
                        <span id="oficinaBadge" style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.75em; display: none;"></span>
                        <span id="syncStatus" class="sync-status sync-online">üü¢ En l√≠nea</span>
                    </div>
                </div>
                <h1>üè† Gesti√≥n de Clientes Inmobiliarios</h1>
                <p> Sistema de registro y seguimiento por etapas</p>
                
                <!-- Menu Hamburguesa -->
                <div class="menu-container">
                    <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
                        <span></span>
                        <span></span>
                        <span></span>
                    </button>
                    <div class="dropdown-menu" id="dropdownMenu">
                        <button class="dropdown-item" onclick="openChangePasswordModal(); closeMenu();">
                            üîê Cambiar Contrase√±a
                        </button>
                        <button class="dropdown-item" onclick="downloadBackup(); closeMenu();">
                            üíæ Descargar Respaldo
                        </button>
                        <button class="dropdown-item" onclick="document.getElementById('fileInput').click(); closeMenu();">
                            üìÇ Cargar Respaldo
                        </button>
                        <button class="dropdown-item" onclick="syncNow(); closeMenu();">
                            üîÑ Sincronizar Ahora
                        </button>
                        <!-- Opciones de Sistema T√©cnico -->
                        <div id="stMenuOptions" style="display: none;">
                            <hr style="border: none; border-top: 1px solid #ddd; margin: 8px 0;">
                            <div style="padding: 5px 15px; font-size: 0.75em; color: #888; text-transform: uppercase;">Sistema T√©cnico</div>
                            <button class="dropdown-item" onclick="openUserManagement(); closeMenu();">
                                üë• Gesti√≥n de Usuarios
                            </button>
                            <button class="dropdown-item" onclick="openTopManagement(); closeMenu();">
                                üèÜ Gesti√≥n del TOP
                            </button>
                        </div>
                        <button class="dropdown-item danger" onclick="logout()">
                            üö™ Cerrar Sesi√≥n
                        </button>
                    </div>
                    <input type="file" id="fileInput" accept=".json" style="display: none;" onchange="uploadBackup(event)">
                </div>
            </div>

            <div class="content">
                <div class="form-section">
                    <!-- Bot√≥n para a√±adir cliente -->
                    <button type="button" class="btn btn-primary" id="toggleFormBtn" onclick="toggleClientForm()" style="width: 100%; padding: 15px; font-size: 1.1em; margin-bottom: 20px;">
                        ‚ûï A√±adir Cliente
                    </button>
                    
                    <!-- Formulario colapsable -->
                    <div id="clientFormContainer" style="display: none;">
                        <h2 style="margin-bottom: 25px; color: #333;">üìù Datos del Cliente</h2>
                        <form id="clientForm">
                            <div class="form-group">
                                <label for="nombre">Nombre del Cliente *</label>
                                <input type="text" id="nombre" required>
                            </div>
                            <div class="form-group">
                                <label for="telefono">Numero Telefonico *</label>
                                <input type="tel" id="telefono" required>
                            </div>
                            <div class="form-group">
                                <label for="tipoOperacion">Tipo de Operacion *</label>
                                <select id="tipoOperacion" required>
                                    <option value="">Seleccionar...</option>
                                    <option value="venta">Venta</option>
                                    <option value="alquiler">Alquiler</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="direccion">Direccion de la Propiedad</label>
                                <input type="text" id="direccion">
                            </div>
                            <div class="form-group">
                                <label for="linkPropiedad">Link de la Propiedad</label>
                                <input type="text" id="linkPropiedad" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label for="nota">Notas</label>
                                <textarea id="nota"></textarea>
                            </div>
                            <div class="btn-group">
                                <button type="submit" class="btn btn-primary">Guardar Cliente</button>
                                <button type="button" class="btn btn-secondary" onclick="resetForm()">Limpiar</button>
                                <button type="button" class="btn btn-danger" onclick="toggleClientForm()">Cerrar</button>
                            </div>
                        </form>
                    </div>

                    <div class="clients-list">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
                            <h2 style="color: #333; margin: 0;">Clientes</h2>
                            <div class="client-tabs">
                                <button class="client-tab active" id="tabRegistrados" onclick="switchClientTab('registrados')">Registrados</button>
                                <button class="client-tab" id="tabArchivados" onclick="switchClientTab('archivados')">Archivados <span id="archivedCount" class="archived-count">0</span></button>
                            </div>
                            <div style="flex: 1; min-width: 200px; max-width: 300px;">
                                <input type="text" id="quickSearch" placeholder="üîç Buscar cliente..." 
                                    oninput="debouncedSearch(this.value)"
                                    style="width: 100%; padding: 8px 12px; border: 1px solid #ddd; border-radius: 20px; font-size: 0.9em; outline: none;">
                            </div>
                        </div>
                        <div class="filter-section" id="filterSection" style="display: none;">
                            <select id="filterAgent" onchange="displayClients()">
                                <option value="mine">Mis clientes</option>
                                <option value="all">Todos los clientes</option>
                            </select>
                        </div>
                        <div id="clientsList"></div>
                    </div>
                </div>

                <div class="stats-section">
                    <div class="tabs" id="statsTabs">
                        <button class="tab active" onclick="switchStatsTab('general')">Mis Stats</button>
                        <button class="tab" id="tabAgents" onclick="switchStatsTab('agent')" style="display: none;">Por Agente</button>
                        <button class="tab" onclick="switchStatsTab('monthly')">Mensual</button>
                    </div>

                    <!-- Stats General -->
                    <div id="statsGeneral">
                        <div class="stats-card">
                            <h3 id="statsTitle">Mis Estadisticas</h3>
                            <div class="stats-filter-btns">
                                <button class="stats-filter-btn" id="filterAll" onclick="filterStats('all')">Todos</button>
                                <button class="stats-filter-btn" id="filterVentas" onclick="filterStats('venta')">Ventas</button>
                                <button class="stats-filter-btn" id="filterAlquileres" onclick="filterStats('alquiler')">Alquileres</button>
                            </div>
                            <div id="statsContent" style="display: none;">
                                <div class="stat-row">
                                    <span class="stat-label">Se llamo</span>
                                    <span class="stat-value" id="statLlamado">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Con respuesta</span>
                                    <span class="stat-value" id="statRespuesta">0</span>
                                </div>
                                <div class="stat-row" id="rowPreTasacion">
                                    <span class="stat-label">Pre-Tasacion</span>
                                    <span class="stat-value" id="statPreTasacion">0</span>
                                </div>
                                <div class="stat-row" id="rowTasacionEntregada">
                                    <span class="stat-label">Tasacion Entregada</span>
                                    <span class="stat-value" id="statTasacionEntregada">0</span>
                                </div>
                                <div class="stat-row" id="rowAceptaTasacion">
                                    <span class="stat-label">Acepta Tasacion</span>
                                    <span class="stat-value" id="statAceptaTasacion">0</span>
                                </div>
                                <div class="stat-row" id="rowExclusiva">
                                    <span class="stat-label">Con Exclusiva</span>
                                    <span class="stat-value" id="statExclusiva">0</span>
                                </div>
                                <div class="stat-row" id="rowPublicadas">
                                    <span class="stat-label">Publicadas</span>
                                    <span class="stat-value" id="statPublicadas">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label" id="labelVendidas">Vendidas/Alquiladas</span>
                                    <span class="stat-value" id="statVendidas">0</span>
                                </div>
                                <div class="stat-row" id="rowOtraInmobiliaria" style="display: none;">
                                    <span class="stat-label">Alquilados por otra inmobiliaria</span>
                                    <span class="stat-value" id="statOtraInmobiliaria">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="total-calls" id="totalCallsSection" style="display: none;">
                            <div style="font-size: 1em; font-weight: 600;">MIS LLAMADAS</div>
                            <div class="total-calls-number" id="totalLlamadas">0</div>
                        </div>
                        
                        <!-- TOP Agentes visible para todos -->
                        <div class="stats-card" style="margin-top: 15px;">
                            <h3 style="display: flex; align-items: center; gap: 10px;">
                                üèÜ Top 10 Agentes - <span id="topMonthDisplay"></span>
                                <span onclick="showPointsInfo()" style="background: #17a2b8; color: white; border-radius: 50%; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.6em; cursor: pointer; font-weight: bold;" title="Ver sistema de puntos">?</span>
                            </h3>
                            <div id="topAgentsGeneral"></div>
                        </div>
                    </div>

                    <!-- Stats por Agente -->
                    <div id="statsAgent" style="display: none;">
                        <div class="stats-card">
                            <h3>Estadisticas por Agente</h3>
                            <div class="form-group">
                                <select id="agentSelector" onchange="updateAgentStats()">
                                    <option value="">Seleccionar agente...</option>
                                    <option value="__ALL__">üìä Todos los agentes (Reporte completo)</option>
                                </select>
                            </div>
                            <button id="btnReporteAgente" onclick="generateAgentReport()" style="width: 100%; margin-top: 10px; margin-bottom: 15px; padding: 12px; background: linear-gradient(135deg, #d2a94d, #b6802d); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em; display: none;">
                                üìÑ Descargar Reporte PDF
                            </button>
                            <div class="stats-filter-btns" id="agentFilterBtns" style="display: none;">
                                <button class="stats-filter-btn active" id="agentFilterAll" onclick="filterAgentStats('all')">Todos</button>
                                <button class="stats-filter-btn" id="agentFilterVentas" onclick="filterAgentStats('venta')">Ventas</button>
                                <button class="stats-filter-btn" id="agentFilterAlquileres" onclick="filterAgentStats('alquiler')">Alquileres</button>
                            </div>
                            <div id="agentStatsContent" style="display: none;">
                                <div class="stat-row">
                                    <span class="stat-label">Clientes</span>
                                    <span class="stat-value" id="agentClientes">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Llamadas</span>
                                    <span class="stat-value" id="agentLlamadas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowTasaciones">
                                    <span class="stat-label">Tasaciones</span>
                                    <span class="stat-value" id="agentTasaciones">0</span>
                                </div>
                                <div class="stat-row" id="agentRowExclusivas">
                                    <span class="stat-label">Exclusivas</span>
                                    <span class="stat-value" id="agentExclusivas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowNoExclusivas">
                                    <span class="stat-label">No Exclusivas</span>
                                    <span class="stat-value" id="agentNoExclusivas">0</span>
                                </div>
                                <div class="stat-row" id="agentRowPublicadas">
                                    <span class="stat-label">Publicadas</span>
                                    <span class="stat-value" id="agentPublicadas">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label" id="agentLabelVentas">Ventas/Alquileres</span>
                                    <span class="stat-value" id="agentVentas">0</span>
                                </div>
                            </div>
                        </div>
                        <div class="stats-card">
                            <h3>Resumen de Agentes</h3>
                            <div id="agentsSummary"></div>
                        </div>
                        <div class="stats-card">
                            <h3>Ultima Sesi√≥n de Agentes</h3>
                            <div id="agentsLastLogin"></div>
                        </div>
                    </div>

                    <!-- Stats Mensual -->
                    <div id="statsMonthly" style="display: none;">
                        <div class="stats-card">
                            <h3 id="monthlyTitle">Mis Estadisticas Mensuales</h3>
                            <div class="form-group" id="monthlyAgentFilter" style="display: none;">
                                <label style="font-size: 0.9em; color: #666;">Agente:</label>
                                <select id="monthlyAgentSelector" onchange="updateMonthlyStats()">
                                    <option value="all">Todos los agentes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label style="font-size: 0.9em; color: #666;">Mes:</label>
                                <select id="mesSelector" onchange="updateMonthlyStats()">
                                    <option value="">Seleccionar mes...</option>
                                </select>
                            </div>
                            <div id="monthlyStats" style="display: none;">
                                <div class="stat-row">
                                    <span class="stat-label">Clientes nuevos</span>
                                    <span class="stat-value" id="monthlyNewClients">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Llamadas realizadas</span>
                                    <span class="stat-value" id="monthlyCallsMade">0</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">Tasaciones entregadas</span>
                                    <span class="stat-value" id="monthlyTasaciones">0</span>
                                </div>
                                <div class="stat-row" style="background: #e8f5e9; padding: 8px; border-radius: 5px; margin: 5px 0;">
                                    <span class="stat-label" style="color: #2e7d32;">üè† Ventas</span>
                                    <span class="stat-value" style="color: #2e7d32;" id="monthlyVentas">0</span>
                                </div>
                                <div class="stat-row" style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin: 5px 0;">
                                    <span class="stat-label" style="color: #1565c0;">üîë Alquileres (nuestros)</span>
                                    <span class="stat-value" style="color: #1565c0;" id="monthlyAlquileres">0</span>
                                </div>
                                <div class="stat-row" style="background: #fff3e0; padding: 8px; border-radius: 5px; margin: 5px 0;">
                                    <span class="stat-label" style="color: #e65100;">üè¢ Alquilados por otra inmobiliaria</span>
                                    <span class="stat-value" style="color: #e65100;" id="monthlyOtraInmobiliaria">0</span>
                                </div>
                                <button id="btnReporteMensual" onclick="generateMonthlyReport()" style="width: 100%; margin-top: 15px; padding: 12px; background: linear-gradient(135deg, #d2a94d, #b6802d); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95em; display: none;">
                                    üìÑ Descargar Reporte PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Burbuja de Soporte T√©cnico (para agentes) -->
    <div class="support-bubble" id="supportBubble" onclick="toggleSupportChat()">
        üõü
    </div>

    <!-- Bot√≥n de Inbox de Soporte (para ST) -->
    <button class="support-inbox-btn" id="supportInboxBtn" onclick="openSupportInbox()" style="display: none;">
        üì¨ Inbox
        <span class="support-badge" id="supportBadge" style="display: none;">0</span>
    </button>

    <!-- Chat de Soporte (para agentes) -->
    <div class="support-chat" id="supportChat">
        <div style="background: linear-gradient(135deg, #17a2b8, #138496); color: white; padding: 12px; display: flex; justify-content: space-between; align-items: center; border-radius: 15px 15px 0 0;">
            <span style="font-weight: bold;">üõü Soporte T√©cnico</span>
            <button onclick="toggleSupportChat()" style="background: none; border: none; color: white; font-size: 1.3em; cursor: pointer;">√ó</button>
        </div>
        <div class="support-chat-messages" id="supportChatMessages"></div>
        <div style="padding: 10px; border-top: 1px solid #eee; display: flex; gap: 8px;">
            <input type="text" id="supportMessageInput" placeholder="Escribe tu mensaje..." style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 20px; outline: none;" onkeypress="if(event.key==='Enter')sendSupportMessage()">
            <button onclick="sendSupportMessage()" style="background: #17a2b8; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer;">‚û§</button>
        </div>
    </div>

    <!-- Modal Inbox de Soporte (para ST) -->
    <div id="supportInboxModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: white;">
                <h2>üì¨ Inbox de Soporte T√©cnico</h2>
                <span class="close" onclick="closeSupportInbox()" style="color: white;">&times;</span>
            </div>
            <div style="padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openUserManagement()" class="btn" style="background: #6f42c1; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">üë• Gestionar Usuarios</button>
                <button onclick="openTopManagement()" class="btn" style="background: #ffc107; color: #333; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">üèÜ Gesti√≥n del TOP</button>
                <button onclick="clearSupportInbox()" class="btn" style="background: #dc3545; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer;">üóëÔ∏è Limpiar Inbox</button>
            </div>
            <div id="supportInboxList" style="max-height: 450px; overflow-y: auto; padding: 15px;"></div>
        </div>
    </div>

    <!-- Modal Gesti√≥n de Usuarios (para ST) -->
    <div id="userManagementModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white;">
                <h2>üë• Gesti√≥n de Usuarios</h2>
                <span class="close" onclick="closeUserManagement()" style="color: white;">&times;</span>
            </div>
            <div style="padding: 15px;">
                <div style="margin-bottom: 15px;">
                    <input type="text" id="userSearchInput" placeholder="üîç Buscar usuario..." oninput="renderUserList()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div id="userManagementList" style="max-height: 450px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario (para ST) -->
    <div id="editUserModal" class="modal">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6f42c1, #5a32a3); color: white;">
                <h2>‚úèÔ∏è Editar Usuario</h2>
                <span class="close" onclick="closeEditUser()" style="color: white;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <input type="hidden" id="editUserIndex">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="editUserName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                </div>
                <div class="form-group">
                    <label>C√©dula</label>
                    <input type="text" id="editUserCedula" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;" readonly>
                    <small style="color: #666;">La c√©dula no se puede modificar</small>
                </div>
                <div class="form-group">
                    <label>Rol</label>
                    <select id="editUserRole" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="agent">üë§ Agente</option>
                        <option value="support">üõ†Ô∏è Soporte T√©cnico</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Oficina</label>
                    <select id="editUserOficina" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <option value="">Sin oficina</option>
                        <option value="imperium_harmony">üè¢ Imperium Harmony</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button onclick="saveUserChanges()" class="btn btn-success">üíæ Guardar Cambios</button>
                    <button onclick="closeEditUser()" class="btn btn-secondary">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Gesti√≥n del TOP -->
    <div id="topManagementModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #333;">
                <h2>üèÜ Gesti√≥n del TOP</h2>
                <span class="close" onclick="closeTopManagement()" style="color: #333;">&times;</span>
            </div>
            <div style="padding: 20px;">
                <p style="color: #666; margin-bottom: 15px;">Administra los agentes del ranking. Puedes reasignar o eliminar agentes con sus clientes.</p>
                <div id="topManagementList"></div>
            </div>
        </div>
    </div>

    <!-- Modal de Seguimiento -->
    <div id="followUpModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Seguimiento del Cliente</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Modal de Venta/Alquiler -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="saleModalTitle">Registro de Venta</h2>
                <span class="close" onclick="closeSaleModal()">&times;</span>
            </div>
            <form id="saleForm">
                <div class="form-group">
                    <label for="monedaVenta">Moneda *</label>
                    <select id="monedaVenta" required style="font-size: 1.1em;">
                        <option value="">Seleccionar moneda...</option>
                        <option value="USD">üá∫üá∏ D√≥lares (USD)</option>
                        <option value="UYU">üá∫üáæ Pesos Uruguayos (UYU)</option>
                        <option value="EUR">üá™üá∫ Euros (EUR)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="precioVenta" id="precioLabel">Precio de Venta *</label>
                    <input type="number" id="precioVenta" required>
                </div>
                <div class="form-group">
                    <label for="nombreComprador" id="compradorLabel">Nombre del Comprador *</label>
                    <input type="text" id="nombreComprador" required>
                </div>
                <div class="form-group">
                    <label for="telefonoComprador">Telefono</label>
                    <input type="tel" id="telefonoComprador">
                </div>
                <div class="form-group">
                    <label for="fechaVenta" id="fechaOperacionLabel">Fecha de Venta *</label>
                    <input type="date" id="fechaVenta" required>
                </div>
                <div class="btn-group">
                    <button type="submit" class="btn btn-success" id="submitSaleBtn">Registrar Venta</button>
                    <button type="button" class="btn btn-secondary" onclick="closeSaleModal()">Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Llamada R√°pida -->
    <div id="quickCallModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>üìû Llamar a Cliente</h2>
                <span class="close" onclick="closeQuickCallModal()">&times;</span>
            </div>
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 1.3em; font-weight: bold; margin-bottom: 10px;" id="quickCallClientName"></div>
                <div style="color: #666; margin-bottom: 25px;" id="quickCallPhone"></div>
                
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button id="btnQuickCallNormal" class="btn" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 15px; font-size: 1.1em; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üìû Llamada Normal
                    </button>
                    <button id="btnQuickCallWhatsapp" class="btn" style="background: linear-gradient(135deg, #25D366, #128C7E); color: white; padding: 15px; font-size: 1.1em; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        üí¨ WhatsApp
                    </button>
                </div>
                
                <p style="color: #999; font-size: 0.85em; margin-top: 20px;">Al realizar la llamada, se te preguntar√° si deseas registrarla.</p>
            </div>
        </div>
    </div>

    <!-- Modal de Agregar Llamada -->
    <div id="callModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Registrar Llamada</h2>
                <span class="close" onclick="closeCallModal()">&times;</span>
            </div>
            <div id="callModalBody">
                <div class="form-group">
                    <label for="callDate">Fecha de la Llamada</label>
                    <input type="date" id="callDate">
                </div>
                <div class="form-group">
                    <label for="callTime">Hora de la Llamada</label>
                    <input type="time" id="callTime">
                </div>
                <div class="form-group">
                    <label for="callNote">Nota de la Llamada</label>
                    <textarea id="callNote" placeholder="Descripcion de la llamada..."></textarea>
                </div>
                <div id="callHistoryContainer"></div>
                <div class="btn-group">
                    <button type="button" class="btn btn-primary" onclick="addCall()">Agregar Llamada</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCallModal()">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="save-indicator" id="saveIndicator">Datos sincronizados</div>

    <!-- Modal Cambiar Contrasena -->
    <div id="passwordModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>Cambiar Contrasena</h2>
                <span class="close" onclick="closePasswordModal()">&times;</span>
            </div>
            <div class="form-group">
                <label for="currentPassword">Contrasena Actual</label>
                <input type="password" id="currentPassword" placeholder="Tu contrasena actual...">
            </div>
            <div class="form-group">
                <label for="newPassword">Nueva Contrasena</label>
                <input type="password" id="newPassword" placeholder="Nueva contrasena...">
            </div>
            <div class="form-group">
                <label for="confirmNewPassword">Confirmar Nueva Contrasena</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirma la nueva contrasena...">
            </div>
            <div id="passwordError" class="error-msg"></div>
            <div id="passwordSuccess" class="success-msg"></div>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" onclick="changePassword()">Cambiar</button>
                <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        // ============ FIREBASE CONFIG ============
        // IMPORTANTE: Reemplaza esta configuracion con la tuya de Firebase
        var firebaseConfig = {
            apiKey: "AIzaSyBFX3su6mj96li7YUo46yKjGpz2MFqd1nM",
            authDomain: "gestion-clientes-e7e9f.firebaseapp.com",
            databaseURL: "https://gestion-clientes-e7e9f-default-rtdb.firebaseio.com",
            projectId: "gestion-clientes-e7e9f",
            storageBucket: "gestion-clientes-e7e9f.firebasestorage.app",
            messagingSenderId: "137858869180",
            appId: "1:137858869180:web:a2e272640fc36755a6edb9"
        };

        var db = null;
        var firebaseInitialized = false;
        var SESSION_KEY = 'inmobiliaria_session';
        var ADMIN_USER = 'Diego Hernandez';
        var SUPPORT_USER = 'Anibal Malave';
        
        // Configuraci√≥n de oficinas
        var OFICINAS = {
            'imperium_harmony': {
                nombre: 'Imperium Harmony',
                lider: 'Diego Hernandez',
                icono: 'üè¢'
            }
            // Agregar m√°s oficinas aqu√≠ en el futuro
        };
        
        // Funci√≥n para parsear fechas en formato YYYY-MM-DD de manera local (evita problemas de zona horaria)
        function parseLocalDate(dateStr) {
            if (!dateStr) return null;
            var parts = dateStr.split('-');
            if (parts.length !== 3) return new Date(dateStr);
            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
        }
        
        var clients = [];
        var users = [];
        var supportMessages = [];
        var editingIndex = -1;
        var currentClientIndex = -1;
        var currentAgent = '';
        var isAdmin = false;
        var isSupport = false;
        var showingArchived = false;
        var statsFilter = 'all';
        var agentStatsFilter = 'all';
        var currentPage = 1;
        var clientsPerPage = 5;

        // ============ FUNCIONES DE OPTIMIZACI√ìN ============
        // Debounce para evitar llamadas excesivas
        function debounce(func, wait) {
            var timeout;
            return function() {
                var context = this, args = arguments;
                clearTimeout(timeout);
                timeout = setTimeout(function() {
                    func.apply(context, args);
                }, wait);
            };
        }

        // Throttle para limitar frecuencia de llamadas
        function throttle(func, limit) {
            var inThrottle;
            return function() {
                var context = this, args = arguments;
                if (!inThrottle) {
                    func.apply(context, args);
                    inThrottle = true;
                    setTimeout(function() { inThrottle = false; }, limit);
                }
            };
        }

        // Versi√≥n optimizada de b√∫squeda con debounce
        var debouncedSearch = debounce(function(term) {
            filterClientsBySearch(term);
        }, 300);

        function filterClientsBySearch(term) {
            var searchTerm = term.toLowerCase().trim();
            var cards = document.querySelectorAll('.client-card, .client-card-compact');
            
            for (var i = 0; i < cards.length; i++) {
                var card = cards[i];
                var text = card.textContent.toLowerCase();
                if (searchTerm === '' || text.indexOf(searchTerm) !== -1) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            }
        }

        // ============ INICIALIZACION ============
        window.onload = function() {
            initializeApp();
        };

        function initializeApp() {
            try {
                // Intentar inicializar Firebase
                if (firebaseConfig.apiKey !== "TU_API_KEY") {
                    firebase.initializeApp(firebaseConfig);
                    db = firebase.database();
                    firebaseInitialized = true;
                    
                    // Escuchar cambios en tiempo real
                    setupRealtimeListeners();
                    
                    // Cargar datos desde Firebase
                    loadFromFirebase(function() {
                        hideLoading();
                        checkSession();
                    });
                } else {
                    // Usar localStorage si Firebase no esta configurado
                    console.log('Firebase no configurado, usando localStorage');
                    firebaseInitialized = false;
                    loadFromLocalStorage();
                    hideLoading();
                    checkSession();
                }
            } catch (e) {
                console.error('Error inicializando Firebase:', e);
                firebaseInitialized = false;
                loadFromLocalStorage();
                hideLoading();
                checkSession();
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function updateSyncStatus(status) {
            var el = document.getElementById('syncStatus');
            if (!el) return;
            el.className = 'sync-status';
            if (status === 'online') {
                el.classList.add('sync-online');
                el.textContent = 'üü¢ En l√≠nea';
            } else if (status === 'offline') {
                el.classList.add('sync-offline');
                el.textContent = 'üî¥ Sin conexi√≥n';
            } else if (status === 'syncing') {
                el.classList.add('sync-syncing');
                el.textContent = 'üîÑ Sincronizando...';
            }
        }

        // ============ FIREBASE FUNCTIONS ============
        function setupRealtimeListeners() {
            if (!db) return;
            
            // Escuchar cambios en clientes
            db.ref('clients').on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    clients = Object.values(data);
                } else {
                    clients = [];
                }
                // Actualizar vista si la app principal est√° visible
                if (currentAgent && document.getElementById('mainApp').style.display !== 'none') {
                    displayClients();
                    updateArchivedCount();
                    updateStats();
                    populateMonthSelector();
                    if (isAdmin) populateAgentSelector();
                }
                updateSyncStatus('online');
            }, function(error) {
                console.error('Error en listener de clientes:', error);
                updateSyncStatus('offline');
            });

            // Escuchar cambios en usuarios
            db.ref('users').on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    users = Object.values(data);
                } else {
                    users = [];
                }
            });

            // Escuchar cambios en mensajes de soporte
            db.ref('supportMessages').on('value', function(snapshot) {
                var data = snapshot.val();
                if (data) {
                    supportMessages = Object.values(data);
                } else {
                    supportMessages = [];
                }
                updateSupportBadge();
                if (isSupport) renderSupportInbox();
            });

            // Estado de conexion
            db.ref('.info/connected').on('value', function(snapshot) {
                if (snapshot.val() === true) {
                    updateSyncStatus('online');
                } else {
                    updateSyncStatus('offline');
                }
            });
        }

        function loadFromFirebase(callback) {
            if (!db) {
                if (callback) callback();
                return;
            }

            var loaded = 0;
            var total = 2;

            db.ref('clients').once('value').then(function(snapshot) {
                var data = snapshot.val();
                if (data) clients = Object.values(data);
                loaded++;
                if (loaded === total && callback) callback();
            }).catch(function(e) {
                console.error('Error cargando clientes:', e);
                loaded++;
                if (loaded === total && callback) callback();
            });

            db.ref('users').once('value').then(function(snapshot) {
                var data = snapshot.val();
                if (data) users = Object.values(data);
                loaded++;
                if (loaded === total && callback) callback();
            }).catch(function(e) {
                console.error('Error cargando usuarios:', e);
                loaded++;
                if (loaded === total && callback) callback();
            });
        }

        function saveToFirebase() {
            if (!db) {
                saveToLocalStorage();
                return;
            }

            updateSyncStatus('syncing');

            // Funci√≥n para limpiar valores undefined que Firebase no acepta
            function cleanForFirebase(obj) {
                if (obj === null || obj === undefined) return null;
                if (typeof obj !== 'object') return obj;
                if (Array.isArray(obj)) {
                    return obj.map(function(item) { return cleanForFirebase(item); });
                }
                var cleaned = {};
                for (var key in obj) {
                    if (obj.hasOwnProperty(key)) {
                        var value = obj[key];
                        if (value !== undefined) {
                            cleaned[key] = cleanForFirebase(value);
                        }
                    }
                }
                return cleaned;
            }

            var clientsObj = {};
            for (var i = 0; i < clients.length; i++) {
                clientsObj['client_' + i] = cleanForFirebase(clients[i]);
            }

            // Timeout de seguridad (10 segundos)
            var saveTimeout = setTimeout(function() {
                console.warn('Timeout al guardar en Firebase');
                updateSyncStatus('online');
                showSaveIndicator();
            }, 10000);

            try {
                db.ref('clients').set(clientsObj).then(function() {
                    clearTimeout(saveTimeout);
                    updateSyncStatus('online');
                    showSaveIndicator();
                }).catch(function(e) {
                    clearTimeout(saveTimeout);
                    console.error('Error guardando en Firebase:', e);
                    updateSyncStatus('offline');
                    saveToLocalStorage();
                });
            } catch (e) {
                clearTimeout(saveTimeout);
                console.error('Error en saveToFirebase:', e);
                updateSyncStatus('offline');
                saveToLocalStorage();
            }
        }

        function saveUsersToFirebase() {
            if (!db) {
                localStorage.setItem('inmobiliaria_users', JSON.stringify(users));
                return;
            }

            var usersObj = {};
            for (var i = 0; i < users.length; i++) {
                var safeKey = users[i].username.replace(/[.#$\/\[\]]/g, '_');
                usersObj[safeKey] = users[i];
            }

            db.ref('users').set(usersObj).catch(function(e) {
                console.error('Error guardando usuarios:', e);
            });
        }

        function syncNow() {
            if (db) {
                updateSyncStatus('syncing');
                loadFromFirebase(function() {
                    displayClients();
                    updateStats();
                    alert(' Sincronizaci√≥n completada');
                });
            } else {
                alert('‚ö†Ô∏è Firebase no est√° configurado');
            }
        }

        // ============ LOCAL STORAGE FALLBACK ============
        function loadFromLocalStorage() {
            try {
                var savedClients = localStorage.getItem('inmobiliaria_clientes_data');
                if (savedClients) clients = JSON.parse(savedClients);
                var savedUsers = localStorage.getItem('inmobiliaria_users');
                if (savedUsers) users = JSON.parse(savedUsers);
            } catch (e) {
                console.error('Error cargando localStorage:', e);
            }
        }

        function saveToLocalStorage() {
            try {
                localStorage.setItem('inmobiliaria_clientes_data', JSON.stringify(clients));
            } catch (e) {
                console.error('Error guardando:', e);
            }
        }

        // ============ MENU HAMBURGUESA ============
        function toggleMenu() {
            var btn = document.getElementById('hamburgerBtn');
            var menu = document.getElementById('dropdownMenu');
            btn.classList.toggle('active');
            menu.classList.toggle('show');
        }

        function closeMenu() {
            var btn = document.getElementById('hamburgerBtn');
            var menu = document.getElementById('dropdownMenu');
            btn.classList.remove('active');
            menu.classList.remove('show');
        }

        // Cerrar menu al hacer click fuera
        document.addEventListener('click', function(e) {
            var menu = document.getElementById('dropdownMenu');
            var btn = document.getElementById('hamburgerBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                closeMenu();
            }
        });

        // ============ AUTH SYSTEM ============
        function checkSession() {
            var session = localStorage.getItem(SESSION_KEY);
            if (session) {
                var sessionData = JSON.parse(session);
                var user = null;
                
                // Buscar por tel√©fono (nuevo sistema) o por username/password (compatibilidad)
                if (sessionData.telefono) {
                    user = findUserByTelefono(sessionData.telefono);
                } else if (sessionData.username) {
                    user = findUser(sessionData.username);
                    if (user && user.password !== sessionData.password) {
                        user = null;
                    }
                }
                
                if (user) {
                    // Actualizar ultima sesion
                    user.lastLogin = new Date().toISOString();
                    saveUsersToFirebase();
                    
                    currentAgent = user.username;
                    isAdmin = (currentAgent === ADMIN_USER);
                    isSupport = (currentAgent === SUPPORT_USER) || (user.role === 'support');
                    showMainApp();
                    return;
                }
            }
            showLoginScreen();
        }

        function findUser(username) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].username.toLowerCase() === username.toLowerCase()) {
                    return users[i];
                }
            }
            return null;
        }

        function switchLoginTab(tab) {
            var tabs = document.querySelectorAll('.login-tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            event.target.classList.add('active');
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            if (tab === 'login') document.getElementById('loginForm').classList.add('active');
            else document.getElementById('registerForm').classList.add('active');
            hideMessages();
        }

        function showError(msg) {
            var el = document.getElementById('errorMsg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('successMsg').style.display = 'none';
        }

        function showSuccess(msg) {
            var el = document.getElementById('successMsg');
            el.textContent = msg;
            el.style.display = 'block';
            document.getElementById('errorMsg').style.display = 'none';
        }

        function hideMessages() {
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('successMsg').style.display = 'none';
        }

        function register() {
            hideMessages();
            var nombre = document.getElementById('regNombre').value.trim();
            var apellido = document.getElementById('regApellido').value.trim();
            var cedula = document.getElementById('regCedula').value.trim();
            var telefono = document.getElementById('regTelefono').value.trim().replace(/\s/g, '');
            var oficina = document.getElementById('regOficina').value;

            if (!nombre || !apellido || !cedula || !telefono || !oficina) { showError('Completa todos los campos'); return; }
            if (cedula.length < 6) { showError('C√©dula inv√°lida (m√≠nimo 6 d√≠gitos)'); return; }
            if (telefono.length < 8) { showError('Tel√©fono inv√°lido (m√≠nimo 8 d√≠gitos)'); return; }
            
            // Crear username: Nombre Apellido (capitalizado)
            var username = capitalizeWords(nombre) + ' ' + capitalizeWords(apellido);
            
            // Verificar si la c√©dula ya existe
            for (var i = 0; i < users.length; i++) {
                if (users[i].cedula === cedula) {
                    showError('Esta c√©dula ya est√° registrada. No puedes crear otra cuenta.'); return;
                }
            }
            
            // Verificar si el usuario ya existe
            if (findUser(username)) {
                showError('Este nombre de usuario ya existe'); return;
            }

            users.push({ 
                username: username, 
                cedula: cedula,
                telefono: telefono,
                oficina: oficina,
                password: telefono, // El tel√©fono es la contrase√±a
                role: 'agent',
                createdAt: new Date().toISOString() 
            });
            saveUsersToFirebase();
            showSuccess('¬°Registro exitoso! Usuario: ' + username);
            document.getElementById('regNombre').value = '';
            document.getElementById('regApellido').value = '';
            document.getElementById('regCedula').value = '';
            document.getElementById('regTelefono').value = '';
            document.getElementById('regOficina').value = '';
            setTimeout(function() { switchLoginTab('login'); }, 2000);
        }
        
        function capitalizeWords(str) {
            return str.toLowerCase().replace(/\b\w/g, function(char) {
                return char.toUpperCase();
            });
        }

        function login() {
            hideMessages();
            var username = document.getElementById('loginUsername').value.trim();
            var password = document.getElementById('loginPassword').value.trim().replace(/\s/g, '');

            if (!username || !password) { showError('Completa todos los campos'); return; }
            
            // Buscar usuario por nombre
            var user = findUser(username);
            if (!user) { showError('Usuario no encontrado'); return; }
            
            // Verificar contrase√±a (tel√©fono)
            if (user.password !== password && user.telefono !== password) {
                showError('Contrase√±a incorrecta'); return;
            }

            // Guardar ultima sesion
            user.lastLogin = new Date().toISOString();
            saveUsersToFirebase();

            currentAgent = user.username;
            isAdmin = (currentAgent === ADMIN_USER);
            isSupport = (currentAgent === SUPPORT_USER) || (user.role === 'support');
            localStorage.setItem(SESSION_KEY, JSON.stringify({ username: user.username, password: user.password }));
            showMainApp();
        }
        
        function findUserByTelefono(telefono) {
            for (var i = 0; i < users.length; i++) {
                if (users[i].telefono === telefono || users[i].password === telefono) {
                    return users[i];
                }
            }
            return null;
        }

        function logout() {
            closeMenu();
            
            localStorage.removeItem(SESSION_KEY);
            currentAgent = '';
            isAdmin = false;
            isSupport = false;
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            hideMessages();
        }

        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentAgentDisplay').textContent = currentAgent;
            
            // Mostrar badge de oficina
            var currentUserData = findUser(currentAgent);
            var oficinaBadge = document.getElementById('oficinaBadge');
            if (currentUserData && currentUserData.oficina && OFICINAS[currentUserData.oficina]) {
                var oficina = OFICINAS[currentUserData.oficina];
                oficinaBadge.innerHTML = oficina.icono + ' ' + oficina.nombre;
                oficinaBadge.style.display = 'inline';
                
                // Si es el l√≠der de la oficina, mostrar indicador especial
                if (currentAgent === oficina.lider) {
                    oficinaBadge.style.background = '#d2a94d';
                    oficinaBadge.innerHTML = '‚≠ê L√≠der - ' + oficina.nombre;
                }
            } else {
                oficinaBadge.style.display = 'none';
            }
            
            if (isAdmin) {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('adminBadge').innerHTML = 'üëë ADMIN';
                document.getElementById('tabAgents').style.display = 'inline-block';
                document.getElementById('filterSection').style.display = 'block';
                document.getElementById('statsTitle').textContent = ' Mis Estad√≠sticas';
                document.getElementById('monthlyTitle').textContent = ' Estad√≠sticas Mensuales';
                document.getElementById('monthlyAgentFilter').style.display = 'block';
                populateMonthlyAgentSelector();
            } else if (isSupport) {
                document.getElementById('adminBadge').style.display = 'inline';
                document.getElementById('adminBadge').innerHTML = 'üõ†Ô∏è ST';
                document.getElementById('adminBadge').style.background = '#17a2b8';
                document.getElementById('tabAgents').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                document.getElementById('statsTitle').textContent = ' Mis Estad√≠sticas';
                document.getElementById('monthlyTitle').textContent = ' Mis Estad√≠sticas Mensuales';
                document.getElementById('monthlyAgentFilter').style.display = 'none';
            } else {
                document.getElementById('adminBadge').style.display = 'none';
                document.getElementById('tabAgents').style.display = 'none';
                document.getElementById('filterSection').style.display = 'none';
                document.getElementById('statsTitle').textContent = ' Mis Estad√≠sticas';
                document.getElementById('monthlyTitle').textContent = ' Mis Estad√≠sticas Mensuales';
                document.getElementById('monthlyAgentFilter').style.display = 'none';
            }
            
            // Mostrar/ocultar elementos de soporte seg√∫n rol
            if (isSupport) {
                document.getElementById('supportBubble').style.display = 'none';
                document.getElementById('supportInboxBtn').style.display = 'block';
                document.getElementById('stMenuOptions').style.display = 'block';
                updateSupportBadge();
                renderSupportInbox();
            } else {
                document.getElementById('supportBubble').style.display = 'flex';
                document.getElementById('supportInboxBtn').style.display = 'none';
                document.getElementById('stMenuOptions').style.display = 'none';
            }
            
            // Mostrar bot√≥n de reporte mensual para Admin y L√≠deres
            var isLider = false;
            if (currentUserData && currentUserData.oficina && OFICINAS[currentUserData.oficina]) {
                isLider = (currentAgent === OFICINAS[currentUserData.oficina].lider);
            }
            if (isAdmin || isLider) {
                document.getElementById('btnReporteMensual').style.display = 'block';
            } else {
                document.getElementById('btnReporteMensual').style.display = 'none';
            }
            
            migrateOldData();
            updateStats();
            displayClients();
            updateArchivedCount();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            
            // Forzar actualizaci√≥n despu√©s de que Firebase termine de cargar
            setTimeout(function() {
                displayClients();
                updateStats();
                updateArchivedCount();
            }, 500);
        }

        // ============ CLIENT FORM ============
        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveClient();
        });

        document.getElementById('saleForm').addEventListener('submit', function(e) {
            e.preventDefault();
            registerSale();
        });

        function migrateOldData() {
            var needsSave = false;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (!client.historialLlamadas) {
                    client.historialLlamadas = [];
                    if (client.cantidadLlamadas > 0 && client.fechaLlamada) {
                        for (var j = 0; j < client.cantidadLlamadas; j++) {
                            client.historialLlamadas.push({ fecha: client.fechaLlamada, hora: '', nota: j === 0 ? 'Primera llamada' : 'Llamada ' + (j + 1) });
                        }
                    }
                    needsSave = true;
                }
                if (!client.agente) { client.agente = currentAgent; needsSave = true; }
            }
            if (needsSave) saveToFirebase();
        }

        function saveClient() {
            var clientData = {
                nombre: document.getElementById('nombre').value,
                telefono: document.getElementById('telefono').value,
                tipoOperacion: document.getElementById('tipoOperacion').value,
                direccion: document.getElementById('direccion').value,
                linkPropiedad: document.getElementById('linkPropiedad').value,
                nota: document.getElementById('nota').value,
                cantidadLlamadas: 0,
                historialLlamadas: [],
                archivado: false,
                ultimoContacto: new Date().toISOString(),
                fechaCreacion: new Date().toISOString(),
                agente: currentAgent,
                seguimiento: createEmptySeguimiento(),
                venta: null,
                foto: null
            };

            if (editingIndex === -1) {
                clients.push(clientData);
            } else {
                var existing = clients[editingIndex];
                clientData.seguimiento = existing.seguimiento;
                clientData.cantidadLlamadas = existing.cantidadLlamadas;
                clientData.historialLlamadas = existing.historialLlamadas || [];
                clientData.archivado = existing.archivado;
                clientData.venta = existing.venta;
                clientData.ultimoContacto = existing.ultimoContacto;
                clientData.fechaCreacion = existing.fechaCreacion;
                clientData.agente = existing.agente;
                clientData.foto = existing.foto || null;
                clients[editingIndex] = clientData;
                editingIndex = -1;
            }

            saveToFirebase();
            displayClients();
            updateStats();
            resetForm();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            
            // Cerrar el formulario despu√©s de guardar
            closeClientForm();
        }

        function createEmptySeguimiento() {
            return {
                seLlamo: null, huboRespuesta: null, esInmobiliaria: null, compartenPropiedad: null,
                notaInmobiliaria: '', fueVendido: null, esDueno: null, notaNoDueno: '', numeroNuevoDueno: '',
                aceptaPreTasacion: null, fechaEntrega: '', modalidadEntrega: '', personaEntrega: '',
                tasacionEntregada: null, aceptaTasacion: null, tipoExclusiva: '', publicaste: null,
                plataformasPublicacion: [], vendida: false, llamadaInicialRegistrada: false
            };
        }

        function switchClientTab(tab) {
            showingArchived = (tab === 'archivados');
            currentPage = 1; // Resetear a p√°gina 1
            document.getElementById('tabRegistrados').classList.toggle('active', !showingArchived);
            document.getElementById('tabArchivados').classList.toggle('active', showingArchived);
            displayClients();
        }

        function updateArchivedCount() {
            var count = 0;
            var filter = isAdmin ? document.getElementById('filterAgent').value : 'mine';
            for (var i = 0; i < clients.length; i++) {
                if (clients[i].archivado) {
                    if (filter === 'mine') {
                        if (clients[i].agente === currentAgent) count++;
                    } else {
                        count++;
                    }
                }
            }
            document.getElementById('archivedCount').textContent = count;
        }

        function toggleNote(index) {
            var noteEl = document.getElementById('note-' + index);
            var btnEl = document.getElementById('btn-note-' + index);
            if (noteEl.classList.contains('expanded')) {
                noteEl.classList.remove('expanded');
                btnEl.textContent = 'Ver m√°s...';
            } else {
                noteEl.classList.add('expanded');
                btnEl.textContent = 'Ver menos';
            }
        }

        function toggleClientDetails(index) {
            var card = document.getElementById('client-card-' + index);
            if (card) {
                card.classList.toggle('expanded');
            }
        }

        function uploadClientPhoto(index) {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (file) {
                    // Validar tama√±o (m√°ximo 10MB)
                    if (file.size > 10000000) {
                        alert('La imagen es muy grande. M√°ximo 10MB.');
                        return;
                    }
                    var reader = new FileReader();
                    reader.onload = function(event) {
                        // Comprimir imagen
                        var img = new Image();
                        img.onload = function() {
                            var canvas = document.createElement('canvas');
                            var maxSize = 200; // Tama√±o mayor para mejor calidad
                            var width = img.width;
                            var height = img.height;
                            
                            // Calcular el recorte cuadrado centrado
                            var size = Math.min(width, height);
                            var startX = (width - size) / 2;
                            var startY = (height - size) / 2;
                            
                            canvas.width = maxSize;
                            canvas.height = maxSize;
                            var ctx = canvas.getContext('2d');
                            
                            // Dibujar la imagen recortada y centrada
                            ctx.drawImage(img, startX, startY, size, size, 0, 0, maxSize, maxSize);
                            
                            var compressedData = canvas.toDataURL('image/jpeg', 0.8);
                            clients[index].foto = compressedData;
                            saveToFirebase();
                            displayClients();
                        };
                        img.src = event.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // ============ MODAL DE LLAMADA R√ÅPIDA ============
        function quickCall(index) {
            currentClientIndex = index;
            var client = clients[index];
            var phoneClean = client.telefono.replace(/\D/g, '');
            var whatsappNumber = phoneClean;
            if (phoneClean.length <= 9) {
                whatsappNumber = '598' + phoneClean;
            } else if (phoneClean.startsWith('0')) {
                whatsappNumber = '598' + phoneClean.substring(1);
            }
            
            document.getElementById('quickCallClientName').textContent = client.nombre;
            document.getElementById('quickCallPhone').textContent = client.telefono;
            document.getElementById('btnQuickCallNormal').onclick = function() {
                window.location.href = 'tel:' + client.telefono;
                setTimeout(function() { askIfCallMade(index); }, 1000);
            };
            document.getElementById('btnQuickCallWhatsapp').onclick = function() {
                window.open('https://wa.me/' + whatsappNumber, '_blank');
                setTimeout(function() { askIfCallMade(index); }, 1000);
            };
            document.getElementById('quickCallModal').style.display = 'block';
        }

        function closeQuickCallModal() {
            document.getElementById('quickCallModal').style.display = 'none';
        }

        function askIfCallMade(index) {
            closeQuickCallModal();
            if (confirm('¬øSe realiz√≥ la llamada?\n\nSi confirmas, se registrar√° autom√°ticamente.')) {
                registerQuickCall(index);
            }
        }

        function registerQuickCall(index) {
            var client = clients[index];
            var now = new Date();
            client.historialLlamadas = client.historialLlamadas || [];
            client.historialLlamadas.push({ 
                fecha: now.toISOString().split('T')[0], 
                hora: now.toTimeString().slice(0, 5), 
                nota: 'Llamada r√°pida' 
            });
            client.cantidadLlamadas = client.historialLlamadas.length;
            client.ultimoContacto = now.toISOString();
            
            // Marcar que se llam√≥ en seguimiento (siempre)
            client.seguimiento.seLlamo = true;
            
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            alert('‚úÖ Llamada registrada correctamente.\nSe contabiliz√≥ en tus estad√≠sticas.');
        }

        function displayClients() {
            var list = document.getElementById('clientsList');
            list.innerHTML = '';
            var filter = isAdmin ? document.getElementById('filterAgent').value : 'mine';

            var filteredClients = [];
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (showingArchived) {
                    if (!client.archivado) continue;
                } else {
                    if (client.archivado) continue;
                }
                if (filter === 'mine' && client.agente !== currentAgent) continue;
                filteredClients.push({ client: client, originalIndex: i });
            }

            filteredClients.sort(function(a, b) { return new Date(b.client.ultimoContacto) - new Date(a.client.ultimoContacto); });

            if (filteredClients.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">' + (showingArchived ? ' No hay clientes archivados' : ' No hay clientes registrados') + '</p>';
                updateArchivedCount();
                return;
            }

            // Paginaci√≥n
            var totalPages = Math.ceil(filteredClients.length / clientsPerPage);
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;
            
            var startIndex = (currentPage - 1) * clientsPerPage;
            var endIndex = Math.min(startIndex + clientsPerPage, filteredClients.length);
            var paginatedClients = filteredClients.slice(startIndex, endIndex);

            for (var j = 0; j < paginatedClients.length; j++) {
                var item = paginatedClients[j];
                var client = item.client;
                var index = item.originalIndex;
                var stage = getClientStage(client);
                var card = document.createElement('div');
                card.className = 'client-card';
                card.id = 'client-card-' + index;
                
                var tipoText = client.tipoOperacion === 'venta' ? 'Venta' : 'Alquiler';
                var tipoClass = client.tipoOperacion === 'venta' ? 'type-venta' : 'type-alquiler';
                var fechaFormateada = new Date(client.ultimoContacto).toLocaleDateString('es-ES');
                
                // Iniciales para la burbuja o foto si existe
                var initials = client.nombre.split(' ').map(function(n) { return n[0]; }).join('').substring(0, 2).toUpperCase();
                var photoContent = client.foto 
                    ? '<img src="' + client.foto + '" alt="Foto" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">' 
                    : initials;
                
                // Nota de seguimiento compacta
                var seguimientoNote = '';
                if (stage.badge === 'Hacer Seguimiento' || stage.badge === 'Llamar de Nuevo' || stage.badge === 'Seguir o Archivar') {
                    seguimientoNote = '<div style="font-size: 0.8em; color: #e65100; margin-top: 3px;">‚ö†Ô∏è ' + stage.badge + '</div>';
                }
                
                // Badge del agente (solo admin)
                var agentBadge = (isAdmin && filter === 'all') ? '<span class="agent-badge" style="font-size: 0.75em;">' + (client.agente || 'Sin agente') + '</span>' : '';
                
                // Contador de progreso del cliente (TOTAL HIST√ìRICO acumulado con PUNTOS)
                var s = client.seguimiento || {};
                
                // Contar llamada del seguimiento (1 si seLlamo=true, 0 si no)
                var llamadasCount = (s.seLlamo === true) ? 1 : 0;
                
                // Calcular puntos hist√≥ricos seg√∫n tipo de operaci√≥n
                var puntosHistoricos = 0;
                var statsCounter = '';
                
                if (client.tipoOperacion === 'alquiler') {
                    // Alquileres: llamadas (1pt), alquiler publicado (5pt), alquiler cerrado (25pt)
                    var alqPublicado = (s.publicaste === true && !s.vendida) ? 1 : 0;
                    var alqCerrado = (s.vendida && client.venta) ? 1 : 0;
                    
                    puntosHistoricos = (llamadasCount * 1) + (alqPublicado * 5) + (alqCerrado * 25);
                    
                    statsCounter = '<span style="font-size: 0.7em; color: #666; margin-left: 8px;">| üìû' + llamadasCount + ' | üì¢' + alqPublicado + ' | üîë' + alqCerrado + ' | <strong style="color: #c2943b;">' + puntosHistoricos + 'pts</strong></span>';
                } else {
                    // Ventas: llamadas (1pt), tasaci√≥n (5pt), no exclusiva (5pt), exclusiva (15pt), venta (60pt)
                    var tasacionCount = (s.tasacionEntregada === true) ? 1 : 0;
                    var noExclusivaCount = (s.tipoExclusiva === 'No Exclusiva') ? 1 : 0;
                    var exclusivaCount = (s.tipoExclusiva === 'Exclusiva') ? 1 : 0;
                    var otraModalidadCount = (s.tipoExclusiva === 'Otra Modalidad') ? 1 : 0;
                    var ventaCount = (s.vendida && client.venta) ? 1 : 0;
                    
                    // Otra Modalidad NO suma puntos (solo cuenta No Exclusiva y Exclusiva)
                    puntosHistoricos = (llamadasCount * 1) + (tasacionCount * 5) + (noExclusivaCount * 5) + (exclusivaCount * 15) + (ventaCount * 60);
                    
                    // Mostrar emoji diferente seg√∫n tipo de exclusiva: üìù No Exclusiva, ‚≠ê Exclusiva, üîÑ Otra Modalidad
                    var exclusivaEmoji = '';
                    if (exclusivaCount > 0) {
                        exclusivaEmoji = '‚≠ê1';
                    } else if (noExclusivaCount > 0) {
                        exclusivaEmoji = 'üìù1';
                    } else if (otraModalidadCount > 0) {
                        exclusivaEmoji = 'üîÑ1'; // Otra Modalidad - no suma puntos
                    } else {
                        exclusivaEmoji = 'üìù0';
                    }
                    
                    statsCounter = '<span style="font-size: 0.7em; color: #666; margin-left: 8px;">| üìû' + llamadasCount + ' | üìã' + tasacionCount + ' | ' + exclusivaEmoji + ' | üè†' + ventaCount + ' | <strong style="color: #c2943b;">' + puntosHistoricos + 'pts</strong></span>';
                }
                
                // Secci√≥n compacta (siempre visible)
                var compactHTML = '<div class="client-card-compact" onclick="toggleClientDetails(' + index + ')">';
                compactHTML += '<div class="client-photo" onclick="event.stopPropagation(); uploadClientPhoto(' + index + ')" title="Clic para agregar foto">' + photoContent + '</div>';
                compactHTML += '<div class="client-compact-info">';
                compactHTML += '<div class="client-compact-header"><span class="client-name">' + client.nombre + '</span><span class="type-badge ' + tipoClass + '">' + tipoText + '</span>' + agentBadge + '</div>';
                compactHTML += '<div class="client-compact-stage"><span class="stage-badge ' + stage.class + '" style="padding: 2px 8px; font-size: 0.75em;">' + stage.badge + '</span>' + statsCounter + '</div>';
                compactHTML += seguimientoNote;
                compactHTML += '</div>';
                compactHTML += '<span class="client-expand-icon">‚ñº</span>';
                compactHTML += '</div>';
                
                // Secci√≥n de detalles (oculta por defecto)
                var detailsHTML = '<div class="client-details" id="client-details-' + index + '">';
                
                // Info del cliente
                detailsHTML += '<div class="client-info">';
                detailsHTML += '<div class="info-item"><span class="info-label">üìû Tel√©fono:</span> ' + client.telefono + '</div>';
                detailsHTML += '<div class="info-item"><span class="info-label">üìç Direcci√≥n:</span> ' + (client.direccion || 'N/A') + '</div>';
                detailsHTML += '<div class="info-item"><span class="info-label">üìä Llamadas:</span> ' + client.cantidadLlamadas + '</div>';
                detailsHTML += '<div class="info-item"><span class="info-label">üìÖ √öltimo contacto:</span> ' + fechaFormateada + '</div>';
                detailsHTML += '</div>';
                
                // Botones de contacto
                var phoneClean = client.telefono.replace(/\D/g, '');
                var whatsappNumber = phoneClean;
                if (phoneClean.length <= 9) {
                    whatsappNumber = '598' + phoneClean;
                } else if (phoneClean.startsWith('0')) {
                    whatsappNumber = '598' + phoneClean.substring(1);
                }
                
                detailsHTML += '<div class="contact-buttons" style="margin-top: 10px;">';
                detailsHTML += '<button onclick="event.stopPropagation(); quickCall(' + index + ')" class="contact-btn btn-call-phone">üìû Llamar / WhatsApp</button>';
                if (client.direccion) {
                    detailsHTML += '<a href="https://www.google.com/maps/search/' + encodeURIComponent(client.direccion) + '" target="_blank" class="contact-btn btn-maps" onclick="event.stopPropagation();">üìç Mapa</a>';
                }
                if (client.linkPropiedad) {
                    detailsHTML += '<a href="' + client.linkPropiedad + '" target="_blank" class="contact-btn btn-link" onclick="event.stopPropagation();">üîó Ver Propiedad</a>';
                }
                detailsHTML += '</div>';
                
                // Botones de acci√≥n
                detailsHTML += '<div class="client-actions" style="margin-top: 10px;">';
                if (showingArchived) {
                    detailsHTML += '<button class="btn-small btn-restore" onclick="event.stopPropagation(); restaurarCliente(' + index + ')">‚ôªÔ∏è Restaurar</button>';
                    detailsHTML += '<button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteClient(' + index + ')">üóëÔ∏è Eliminar</button>';
                } else {
                    detailsHTML += '<button class="btn-small btn-call" onclick="event.stopPropagation(); openCallModal(' + index + ')">üìû +Llamada</button>';
                    detailsHTML += '<button class="btn-small btn-follow" onclick="event.stopPropagation(); openFollowUp(' + index + ')">üìã Seguimiento</button>';
                    detailsHTML += '<button class="btn-small btn-edit" onclick="event.stopPropagation(); editClient(' + index + ')">‚úèÔ∏è Editar</button>';
                    detailsHTML += '<button class="btn-small btn-delete" onclick="event.stopPropagation(); deleteClient(' + index + ')">üóëÔ∏è Borrar</button>';
                }
                detailsHTML += '</div>';
                
                // Nota
                if (client.nota) {
                    detailsHTML += '<div class="note-container" style="margin-top: 10px;"><strong>üìù Nota:</strong> ' + client.nota + '</div>';
                }
                
                // Info de venta/alquiler
                if (client.venta) {
                    var tipoOp = client.tipoOperacion === 'venta' ? 'VENDIDA' : 'ALQUILADA';
                    var tipoPers = client.tipoOperacion === 'venta' ? 'Comprador' : 'Inquilino';
                    var monedaSymbol = 'US$';
                    if (client.venta.moneda === 'UYU') monedaSymbol = '$';
                    else if (client.venta.moneda === 'EUR') monedaSymbol = '‚Ç¨';
                    var monedaFlag = client.venta.moneda === 'UYU' ? 'üá∫üáæ' : (client.venta.moneda === 'EUR' ? 'üá™üá∫' : 'üá∫üá∏');
                    detailsHTML += '<div style="margin-top: 10px; padding: 10px; background: #c8e6c9; border-radius: 5px; color: #2e7d32;"><strong>' + tipoOp + '</strong> ' + monedaFlag + ' ' + monedaSymbol + ' ' + client.venta.precio + ' - ' + tipoPers + ': ' + client.venta.nombreComprador + '</div>';
                }
                
                detailsHTML += '</div>';
                
                card.innerHTML = compactHTML + detailsHTML;
                list.appendChild(card);
            }
            
            // Agregar controles de paginaci√≥n
            if (totalPages > 1) {
                var paginationHTML = '<div class="pagination">';
                paginationHTML += '<button onclick="prevPage()" ' + (currentPage === 1 ? 'disabled' : '') + '>‚Üê Anterior</button>';
                paginationHTML += '<span class="page-info">P√°gina ' + currentPage + ' de ' + totalPages + ' (' + filteredClients.length + ' clientes)</span>';
                paginationHTML += '<button onclick="nextPage()" ' + (currentPage === totalPages ? 'disabled' : '') + '>Siguiente ‚Üí</button>';
                paginationHTML += '</div>';
                list.insertAdjacentHTML('beforeend', paginationHTML);
            }
            
            updateArchivedCount();
        }

        function restaurarCliente(index) {
            if (confirm('¬øRestaurar este cliente?')) {
                clients[index].archivado = false;
                clients[index].ultimoContacto = new Date().toISOString();
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
            }
        }

        function getClientStage(client) {
            var s = client.seguimiento;
            // Archivados
            if (client.archivado) {
                if (s.motivoArchivo === 'inmobiliaria') return { badge: 'üè¢ Inmobiliaria', class: 'stage-archivada' };
                if (s.motivoArchivo === 'no_acepta_tasacion') return { badge: 'üìã Seguimiento', class: 'stage-seguimiento' };
                if (s.vendida) return { badge: client.tipoOperacion === 'venta' ? '‚úÖ VENDIDA' : '‚úÖ ALQUILADA', class: 'stage-vendida' };
                return { badge: 'üìÅ Archivado', class: 'stage-archivada' };
            }
            // Activos
            if (s.vendida) return { badge: client.tipoOperacion === 'venta' ? '‚úÖ VENDIDA' : '‚úÖ ALQUILADA', class: 'stage-vendida' };
            if (s.publicaste === true) return { badge: 'üì¢ Publicada', class: 'stage-publicada' };
            if (s.tipoExclusiva) {
                if (s.tipoExclusiva === 'No Exclusiva') return { badge: 'üìù No Exclusiva', class: 'stage-exclusiva' };
                return { badge: '‚≠ê Exclusiva', class: 'stage-exclusiva' };
            }
            if (s.aceptaTasacion === true) return { badge: '‚úîÔ∏è Acepta Tasaci√≥n', class: 'stage-tasacion' };
            if (s.tasacionEntregada === true) return { badge: 'üìã Tasaci√≥n Entregada', class: 'stage-tasacion' };
            if (s.aceptaPreTasacion === true) return { badge: 'üëÅÔ∏è Hacer Seguimiento', class: 'stage-seguimiento' };
            if (s.aceptaPreTasacion === false) return { badge: '‚è≥ Seguir o Archivar', class: 'stage-seguimiento' };
            if (s.esDueno === false) return { badge: 'üìû Pedir Tel√©fono', class: 'stage-seguimiento' };
            if (s.fueVendido === true) return { badge: 'üîí Para Archivar', class: 'stage-archivada' };
            if (s.esInmobiliaria === true) return { badge: 'üè¢ Inmobiliaria', class: 'stage-respuesta' };
            if (s.huboRespuesta === false) return { badge: 'üìû Llamar de Nuevo', class: 'stage-pendiente' };
            if (s.huboRespuesta === true) return { badge: 'üí¨ Respondi√≥', class: 'stage-respuesta' };
            if (s.seLlamo === false) return { badge: '‚è∞ Pendiente Llamar', class: 'stage-pendiente' };
            if (s.seLlamo === true) return { badge: 'üìû Llamado', class: 'stage-inicial' };
            return { badge: 'üÜï Nuevo', class: 'stage-inicial' };
        }

        // ============ CALL MODAL ============
        function openCallModal(index) {
            currentClientIndex = index;
            var client = clients[index];
            var now = new Date();
            document.getElementById('callDate').value = now.toISOString().split('T')[0];
            document.getElementById('callTime').value = now.toTimeString().slice(0, 5);
            document.getElementById('callNote').value = '';
            renderCallHistory(client);
            document.getElementById('callModal').style.display = 'block';
        }

        function closeCallModal() { document.getElementById('callModal').style.display = 'none'; currentClientIndex = -1; }

        function renderCallHistory(client) {
            var container = document.getElementById('callHistoryContainer');
            var historial = client.historialLlamadas || [];
            if (historial.length === 0) { container.innerHTML = '<p style="color: #666; font-style: italic;">No hay llamadas registradas.</p>'; return; }
            var html = '<div class="call-history"><h4>Historial (' + historial.length + ')</h4>';
            for (var i = historial.length - 1; i >= 0; i--) {
                var call = historial[i];
                html += '<div class="call-item"><div><span>' + (call.fecha || 'Sin fecha') + ' ' + (call.hora || '') + '</span>' + (call.nota ? '<br><small>' + call.nota + '</small>' : '') + '</div><button class="delete-call" onclick="deleteCall(' + i + ')">X</button></div>';
            }
            html += '</div>';
            container.innerHTML = html;
        }

        function addCall() {
            var client = clients[currentClientIndex];
            client.historialLlamadas = client.historialLlamadas || [];
            client.historialLlamadas.push({ fecha: document.getElementById('callDate').value, hora: document.getElementById('callTime').value, nota: document.getElementById('callNote').value });
            client.cantidadLlamadas = client.historialLlamadas.length;
            client.ultimoContacto = new Date().toISOString();
            if (client.seguimiento.seLlamo !== true) client.seguimiento.seLlamo = true;
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            renderCallHistory(client);
            document.getElementById('callNote').value = '';
            var now = new Date();
            document.getElementById('callDate').value = now.toISOString().split('T')[0];
            document.getElementById('callTime').value = now.toTimeString().slice(0, 5);
        }

        function deleteCall(callIndex) {
            if (!confirm('¬øEliminar esta llamada?')) return;
            var client = clients[currentClientIndex];
            client.historialLlamadas.splice(callIndex, 1);
            client.cantidadLlamadas = client.historialLlamadas.length;
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            renderCallHistory(client);
        }

        // ============ FOLLOW UP ============
        function openFollowUp(index) {
            currentClientIndex = index;
            var client = clients[index];
            var s = client.seguimiento;
            var esAlquiler = client.tipoOperacion === 'alquiler';
            var html = buildFollowUpHTML(client, s, esAlquiler);
            html += '<div class="btn-group"><button type="button" class="btn btn-primary" onclick="saveFollowUp()">Guardar</button><button type="button" class="btn btn-secondary" onclick="closeModal()">Cerrar</button></div>';
            
            // Bot√≥n de Registrar Venta/Alquiler independiente (siempre visible si no se ha registrado)
            if (!s.vendida) {
                var btnText = esAlquiler ? 'üîë Registrar Alquiler' : 'üè† Registrar Venta';
                html += '<div style="margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd;">';
                html += '<button type="button" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.1em;" onclick="openSaleModal()">' + btnText + '</button>';
                
                // Bot√≥n "No se alquil√≥" solo para alquileres
                if (esAlquiler) {
                    html += '<button type="button" class="btn btn-secondary" style="width: 100%; padding: 12px; font-size: 1em; margin-top: 10px; background: #6c757d; color: white;" onclick="archivarNoSeAlquilo()">‚ùå No se alquil√≥ (otra inmobiliaria)</button>';
                }
                html += '</div>';
            } else {
                // Mostrar informaci√≥n de la venta registrada
                var v = client.venta;
                var simbolo = v.moneda === 'USD' ? 'US$' : (v.moneda === 'UYU' ? '$' : '‚Ç¨');
                var tipoOp = esAlquiler ? 'Alquiler' : 'Venta';
                html += '<div style="margin-top: 15px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 2px solid #4caf50;"><div style="font-weight: bold; color: #2e7d32; font-size: 1.1em; margin-bottom: 10px;">‚úÖ ' + tipoOp + ' Registrada</div>';
                html += '<div style="font-size: 0.95em;"><strong>Fecha:</strong> ' + (v.fecha || 'N/A') + '</div>';
                html += '<div style="font-size: 0.95em;"><strong>Precio:</strong> ' + simbolo + ' ' + (v.precio || 'N/A') + '</div></div>';
            }
            
            document.getElementById('modalBody').innerHTML = html;
            document.getElementById('followUpModal').style.display = 'block';
        }
        
        function archivarNoSeAlquilo() {
            if (!confirm('¬øArchivar este cliente porque el alquiler fue realizado por otra inmobiliaria?\n\nEsto NO sumar√° puntos al contador.')) return;
            var client = clients[currentClientIndex];
            client.archivado = true;
            client.fechaArchivado = new Date().toISOString();
            client.ultimoContacto = new Date().toISOString();
            client.seguimiento.motivoArchivo = 'alquilado_otra_inmobiliaria';
            // NO se marca como vendida para que no sume puntos
            saveToFirebase();
            displayClients();
            updateArchivedCount();
            updateStats();
            closeModal();
            alert('Cliente archivado. El alquiler fue realizado por otra inmobiliaria.');
        }

        function buildFollowUpHTML(client, s, esAlquiler) {
            var html = '';
            
            html += '<div class="stage-section"><div class="stage-title">1. ¬øSe realiz√≥ la llamada?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="seLlamoSi" name="seLlamo" value="si" ' + (s.seLlamo === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="seLlamoSi">S√≠</label></div><div class="radio-item"><input type="radio" id="seLlamoNo" name="seLlamo" value="no" ' + (s.seLlamo === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="seLlamoNo">No</label></div></div>' + (s.seLlamo === false ? '<div class="alert-box alert-warning">Pendiente por llamar</div>' : '') + '</div>';
            if (s.seLlamo !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">2. ¬øHubo respuesta?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="respuestaSi" name="huboRespuesta" value="si" ' + (s.huboRespuesta === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="respuestaSi">S√≠</label></div><div class="radio-item"><input type="radio" id="respuestaNo" name="huboRespuesta" value="no" ' + (s.huboRespuesta === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="respuestaNo">No</label></div></div>' + (s.huboRespuesta === false ? '<div class="alert-box alert-warning">Llamar de nuevo</div>' : '') + '</div>';
            if (s.huboRespuesta !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">3. ¬øEs inmobiliaria?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="inmobiliariaSi" name="esInmobiliaria" value="si" ' + (s.esInmobiliaria === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="inmobiliariaSi">S√≠</label></div><div class="radio-item"><input type="radio" id="inmobiliariaNo" name="esInmobiliaria" value="no" ' + (s.esInmobiliaria === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="inmobiliariaNo">No</label></div></div>';
            if (s.esInmobiliaria === true) {
                html += '<div class="form-group" style="margin-top:15px"><label>¬øComparten?</label><div class="radio-group"><div class="radio-item"><input type="radio" id="compartenSi" name="compartenPropiedad" value="si" ' + (s.compartenPropiedad === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="compartenSi">S√≠</label></div><div class="radio-item"><input type="radio" id="compartenNo" name="compartenPropiedad" value="no" ' + (s.compartenPropiedad === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="compartenNo">No</label></div></div></div><div class="form-group"><label>Nota:</label><textarea id="notaInmobiliaria">' + (s.notaInmobiliaria || '') + '</textarea></div>';
                html += '<button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarComoInmobiliaria()">üìÅ Archivar como Inmobiliaria</button>';
            }
            html += '</div>';
            if (s.esInmobiliaria !== false) return html;

            html += '<div class="stage-section"><div class="stage-title">4. ¬øYa fue ' + (esAlquiler ? 'alquilada' : 'vendida') + '?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="vendidoSi" name="fueVendido" value="si" ' + (s.fueVendido === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="vendidoSi">S√≠</label></div><div class="radio-item"><input type="radio" id="vendidoNo" name="fueVendido" value="no" ' + (s.fueVendido === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="vendidoNo">No</label></div></div>';
            if (s.fueVendido === true) html += '<div class="alert-box alert-warning">Puede archivarse</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
            html += '</div>';
            if (s.fueVendido !== false) return html;

            html += '<div class="stage-section"><div class="stage-title">5. ¬øEs el due√±o?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="duenoSi" name="esDueno" value="si" ' + (s.esDueno === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="duenoSi">S√≠</label></div><div class="radio-item"><input type="radio" id="duenoNo" name="esDueno" value="no" ' + (s.esDueno === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="duenoNo">No</label></div></div>';
            if (s.esDueno === false) html += '<div class="form-group" style="margin-top:15px"><label>Nota:</label><textarea id="notaNoDueno">' + (s.notaNoDueno || '') + '</textarea></div><div class="form-group"><label>Tel due√±o:</label><input type="tel" id="numeroNuevoDueno" value="' + (s.numeroNuevoDueno || '') + '"></div>';
            html += '</div>';
            if (s.esDueno !== true && s.esDueno !== false) return html;

            if (esAlquiler) {
                html += '<div class="stage-section"><div class="stage-title">6. ¬øAcepta alquiler con nosotros?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="preTasacionSi" name="aceptaPreTasacion" value="si" ' + (s.aceptaPreTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionSi">S√≠</label></div><div class="radio-item"><input type="radio" id="preTasacionNo" name="aceptaPreTasacion" value="no" ' + (s.aceptaPreTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionNo">No</label></div></div>';
                if (s.aceptaPreTasacion === false) html += '<div class="alert-box alert-warning">Seguimiento o archivar</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
                html += '</div>';
                
                // Para alquileres: si acepta, preguntar si public√≥
                if (s.aceptaPreTasacion === true) {
                    html += '<div class="stage-section"><div class="stage-title">7. ¬øLo publicaste?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="publicasteSi" name="publicaste" value="si" ' + (s.publicaste === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteSi">S√≠</label></div><div class="radio-item"><input type="radio" id="publicasteNo" name="publicaste" value="no" ' + (s.publicaste === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteNo">No</label></div></div>';
                    if (s.publicaste === true) {
                        var plataformas = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
                        html += '<div class="form-group" style="margin-top:15px"><label>¬øD√≥nde?</label><div class="checkbox-group">';
                        for (var p = 0; p < plataformas.length; p++) {
                            var plat = plataformas[p];
                            var isChecked = s.plataformasPublicacion && s.plataformasPublicacion.indexOf(plat) !== -1;
                            html += '<div class="checkbox-item"><input type="checkbox" id="plat_' + plat.replace(/\s/g, '') + '" value="' + plat + '" ' + (isChecked ? 'checked' : '') + '><label for="plat_' + plat.replace(/\s/g, '') + '">' + plat + '</label></div>';
                        }
                        html += '</div></div>';
                    }
                    html += '</div>';
                }
                return html;
            } else {
                html += '<div class="stage-section"><div class="stage-title">6. ¬øAcepta pre-tasaci√≥n?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="preTasacionSi" name="aceptaPreTasacion" value="si" ' + (s.aceptaPreTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionSi">S√≠</label></div><div class="radio-item"><input type="radio" id="preTasacionNo" name="aceptaPreTasacion" value="no" ' + (s.aceptaPreTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="preTasacionNo">No</label></div></div>';
                if (s.aceptaPreTasacion === false) html += '<div class="alert-box alert-warning">Seguimiento o archivar</div><button type="button" class="btn btn-danger" style="margin-top:15px;width:100%" onclick="archivarCliente()">Archivar</button>';
                html += '</div>';
            }

            if (s.aceptaPreTasacion !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">7. Entrega de Tasaci√≥n</div><div class="form-group"><label>Fecha entrega</label><input type="date" id="fechaEntrega" value="' + (s.fechaEntrega || '') + '" onchange="updateFollowUp()"></div><div class="form-group"><label>Modalidad</label><select id="modalidadEntrega" onchange="updateFollowUp()"><option value="">Seleccionar...</option><option value="Presencial" ' + (s.modalidadEntrega === 'Presencial' ? 'selected' : '') + '>Presencial</option><option value="Email" ' + (s.modalidadEntrega === 'Email' ? 'selected' : '') + '>Email</option><option value="WhatsApp" ' + (s.modalidadEntrega === 'WhatsApp' ? 'selected' : '') + '>WhatsApp</option><option value="Correo" ' + (s.modalidadEntrega === 'Correo' ? 'selected' : '') + '>Correo postal</option></select></div><div class="form-group"><label>Agente que entreg√≥</label><input type="text" id="personaEntrega" value="' + (s.personaEntrega || currentAgent) + '" readonly style="background:#f0f0f0"></div>' + (s.fechaEntrega ? '<div class="timestamp-display">Fecha: ' + s.fechaEntrega + '</div>' : '') + '<div class="radio-group" style="margin-top:15px"><div class="radio-item"><input type="radio" id="entregadaSi" name="tasacionEntregada" value="si" ' + (s.tasacionEntregada === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="entregadaSi">Entregada</label></div><div class="radio-item"><input type="radio" id="entregadaNo" name="tasacionEntregada" value="no" ' + (s.tasacionEntregada === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="entregadaNo">No</label></div></div></div>';
            if (s.tasacionEntregada !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">8. ¬øAcepta la tasaci√≥n?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="aceptaTasacionSi" name="aceptaTasacion" value="si" ' + (s.aceptaTasacion === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="aceptaTasacionSi">S√≠</label></div><div class="radio-item"><input type="radio" id="aceptaTasacionNo" name="aceptaTasacion" value="no" ' + (s.aceptaTasacion === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="aceptaTasacionNo">No</label></div></div>';
            if (s.aceptaTasacion === false) html += '<button type="button" class="btn btn-warning" style="margin-top:15px;width:100%;background:#ffc107;color:#333;" onclick="archivarConSeguimiento()">üìã Archivar con Seguimiento</button>';
            html += '</div>';
            if (s.aceptaTasacion !== true) return html;

            html += '<div class="stage-section"><div class="stage-title">9. Tipo de Exclusiva</div><div class="form-group"><select id="tipoExclusiva" onchange="updateFollowUp()"><option value="">Seleccionar...</option><option value="Exclusiva" ' + (s.tipoExclusiva === 'Exclusiva' ? 'selected' : '') + '>Exclusiva</option><option value="No Exclusiva" ' + (s.tipoExclusiva === 'No Exclusiva' ? 'selected' : '') + '>No Exclusiva</option><option value="Otra Modalidad" ' + (s.tipoExclusiva === 'Otra Modalidad' ? 'selected' : '') + '>Otra Modalidad</option></select></div></div>';
            if (!s.tipoExclusiva) return html;

            html += '<div class="stage-section"><div class="stage-title">10. ¬øPublicaste?</div><div class="radio-group"><div class="radio-item"><input type="radio" id="publicasteSi" name="publicaste" value="si" ' + (s.publicaste === true ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteSi">S√≠</label></div><div class="radio-item"><input type="radio" id="publicasteNo" name="publicaste" value="no" ' + (s.publicaste === false ? 'checked' : '') + ' onchange="updateFollowUp()"><label for="publicasteNo">No</label></div></div>';
            if (s.publicaste === true) {
                var plataformas = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
                html += '<div class="form-group" style="margin-top:15px"><label>¬øD√≥nde?</label><div class="checkbox-group">';
                for (var i = 0; i < plataformas.length; i++) {
                    var plat = plataformas[i];
                    var isChecked = s.plataformasPublicacion && s.plataformasPublicacion.indexOf(plat) !== -1;
                    html += '<div class="checkbox-item"><input type="checkbox" id="plat_' + plat.replace(/\s/g, '') + '" value="' + plat + '" ' + (isChecked ? 'checked' : '') + '><label for="plat_' + plat.replace(/\s/g, '') + '">' + plat + '</label></div>';
                }
                html += '</div></div>';
            }
            html += '</div>';
            return html;
        }

        function updateFollowUp() {
            var client = clients[currentClientIndex];
            var s = client.seguimiento;
            var getValue = function(name) { var el = document.querySelector('input[name="' + name + '"]:checked'); return el ? el.value === 'si' : null; };
            var getVal = function(id) { var el = document.getElementById(id); return el ? el.value : null; };

            // Guardar el estado anterior de seLlamo para detectar cambios
            var seLlamoAnterior = s.seLlamo;
            var nuevoSeLlamo = getValue('seLlamo');
            
            // Manejar cambios en "Se realiz√≥ la llamada"
            if (nuevoSeLlamo === true && seLlamoAnterior !== true && !s.llamadaInicialRegistrada) {
                // Agregar llamada inicial por primera vez
                client.historialLlamadas = client.historialLlamadas || [];
                client.historialLlamadas.push({ 
                    fecha: new Date().toISOString().split('T')[0], 
                    hora: new Date().toTimeString().slice(0, 5), 
                    nota: 'Llamada inicial', 
                    esInicial: true 
                });
                client.cantidadLlamadas = client.historialLlamadas.length;
                client.ultimoContacto = new Date().toISOString();
                s.llamadaInicialRegistrada = true;
            } else if (nuevoSeLlamo === false && s.llamadaInicialRegistrada) {
                // Cambi√≥ de S√≠ a No - eliminar llamada inicial del historial
                if (client.historialLlamadas && client.historialLlamadas.length > 0) {
                    for (var k = client.historialLlamadas.length - 1; k >= 0; k--) {
                        if (client.historialLlamadas[k].esInicial || client.historialLlamadas[k].nota === 'Llamada inicial') {
                            client.historialLlamadas.splice(k, 1);
                            break;
                        }
                    }
                    client.cantidadLlamadas = client.historialLlamadas.length;
                }
                s.llamadaInicialRegistrada = false;
            }
            s.seLlamo = nuevoSeLlamo;

            s.huboRespuesta = getValue('huboRespuesta');
            if (s.huboRespuesta) client.ultimoContacto = new Date().toISOString();
            // Reset cascada: si huboRespuesta es false, resetear todo lo que sigue
            if (s.huboRespuesta === false) {
                s.esInmobiliaria = null;
                s.compartenPropiedad = null;
                s.fueVendido = null;
                s.esDueno = null;
                s.aceptaPreTasacion = null;
                s.tasacionEntregada = null;
                s.aceptaTasacion = null;
                s.tipoExclusiva = '';
                s.publicaste = null;
                s.fechaEntrega = '';
                s.modalidadEntrega = '';
            }
            
            s.esInmobiliaria = getValue('esInmobiliaria');
            
            s.compartenPropiedad = getValue('compartenPropiedad');
            s.fueVendido = getValue('fueVendido');
            // Reset cascada: si fueVendido es true (ya fue vendido/alquilado por otro), resetear
            if (s.fueVendido === true) {
                s.esDueno = null;
                s.aceptaPreTasacion = null;
                s.tasacionEntregada = null;
                s.aceptaTasacion = null;
                s.tipoExclusiva = '';
                s.publicaste = null;
            }
            
            s.esDueno = getValue('esDueno');
            // Reset cascada: si esDueno es false, resetear lo que sigue
            if (s.esDueno === false) {
                s.aceptaPreTasacion = null;
                s.tasacionEntregada = null;
                s.aceptaTasacion = null;
                s.tipoExclusiva = '';
                s.publicaste = null;
            }
            
            s.aceptaPreTasacion = getValue('aceptaPreTasacion');
            // Reset cascada: si aceptaPreTasacion es false, resetear lo que sigue
            if (s.aceptaPreTasacion === false) {
                s.tasacionEntregada = null;
                s.aceptaTasacion = null;
                s.tipoExclusiva = '';
                s.publicaste = null;
                s.fechaEntrega = '';
                s.modalidadEntrega = '';
            }
            
            s.tasacionEntregada = getValue('tasacionEntregada');
            if (s.tasacionEntregada) client.ultimoContacto = new Date().toISOString();
            // Reset cascada: si tasacionEntregada es false, resetear lo que sigue
            if (s.tasacionEntregada === false) {
                s.aceptaTasacion = null;
                s.tipoExclusiva = '';
                s.publicaste = null;
            }
            
            s.aceptaTasacion = getValue('aceptaTasacion');
            // Reset cascada: si aceptaTasacion es false, resetear lo que sigue
            if (s.aceptaTasacion === false) {
                s.tipoExclusiva = '';
                s.publicaste = null;
            }
            
            // Solo actualizar publicaste si el elemento existe en el DOM
            var publicasteVal = getValue('publicaste');
            if (publicasteVal !== null) s.publicaste = publicasteVal;

            var fields = ['notaInmobiliaria', 'notaNoDueno', 'numeroNuevoDueno'];
            for (var i = 0; i < fields.length; i++) { var v = getVal(fields[i]); if (v !== null) s[fields[i]] = v; }
            var fe = getVal('fechaEntrega'); if (fe !== null) s.fechaEntrega = fe;
            var me = getVal('modalidadEntrega'); if (me !== null) s.modalidadEntrega = me;
            s.personaEntrega = currentAgent;
            var te = getVal('tipoExclusiva'); if (te !== null) s.tipoExclusiva = te;

            var plataformas = [];
            var platNames = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
            for (var j = 0; j < platNames.length; j++) {
                var cb = document.getElementById('plat_' + platNames[j].replace(/\s/g, ''));
                if (cb && cb.checked) plataformas.push(platNames[j]);
            }
            // Siempre guardar el array de plataformas si publicaste es true
            if (s.publicaste === true) {
                s.plataformasPublicacion = plataformas;
            }
            openFollowUp(currentClientIndex);
        }

        function saveFollowUp() {
            var client = clients[currentClientIndex];
            var s = client.seguimiento;
            var ni = document.getElementById('notaInmobiliaria'); if (ni) s.notaInmobiliaria = ni.value;
            var nd = document.getElementById('notaNoDueno'); if (nd) s.notaNoDueno = nd.value;
            var nn = document.getElementById('numeroNuevoDueno'); if (nn) s.numeroNuevoDueno = nn.value;
            
            // Guardar plataformas de publicaci√≥n
            var plataformas = [];
            var platNames = ['Mercado Libre', 'Infocasas', 'Gallito', 'Facebook Marketplace', 'Instagram', 'Sitio Web Propio', 'Otros'];
            for (var j = 0; j < platNames.length; j++) {
                var cb = document.getElementById('plat_' + platNames[j].replace(/\s/g, ''));
                if (cb && cb.checked) plataformas.push(platNames[j]);
            }
            // Siempre guardar el array de plataformas si publicaste es true
            if (s.publicaste === true) {
                s.plataformasPublicacion = plataformas;
            }
            
            client.ultimoContacto = new Date().toISOString();
            saveToFirebase();
            displayClients();
            updateStats();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            closeModal();
        }

        function archivarCliente() {
            if (confirm('¬øArchivar este cliente?')) {
                clients[currentClientIndex].archivado = true;
                clients[currentClientIndex].fechaArchivado = new Date().toISOString();
                clients[currentClientIndex].ultimoContacto = new Date().toISOString();
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                closeModal();
            }
        }

        function archivarComoInmobiliaria() {
            if (confirm('¬øArchivar este cliente como inmobiliaria?')) {
                var client = clients[currentClientIndex];
                client.archivado = true;
                client.fechaArchivado = new Date().toISOString();
                client.ultimoContacto = new Date().toISOString();
                client.seguimiento.motivoArchivo = 'inmobiliaria';
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                closeModal();
                alert('üìÅ Cliente archivado como inmobiliaria');
            }
        }

        function archivarConSeguimiento() {
            if (confirm('¬øArchivar este cliente con seguimiento?\n\nSe marcar√° para hacer seguimiento futuro.')) {
                var client = clients[currentClientIndex];
                client.archivado = true;
                client.fechaArchivado = new Date().toISOString();
                client.ultimoContacto = new Date().toISOString();
                client.seguimiento.motivoArchivo = 'no_acepta_tasacion';
                client.seguimiento.requiereSeguimiento = true;
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                closeModal();
                alert('üìã Cliente archivado con seguimiento');
            }
        }

        function closeModal() { document.getElementById('followUpModal').style.display = 'none'; currentClientIndex = -1; }

        // ============ CHANGE PASSWORD ============
        function openChangePasswordModal() {
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmNewPassword').value = '';
            document.getElementById('passwordError').style.display = 'none';
            document.getElementById('passwordSuccess').style.display = 'none';
            document.getElementById('passwordModal').style.display = 'block';
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').style.display = 'none';
        }

        function changePassword() {
            var currentPass = document.getElementById('currentPassword').value;
            var newPass = document.getElementById('newPassword').value;
            var confirmPass = document.getElementById('confirmNewPassword').value;
            var errorEl = document.getElementById('passwordError');
            var successEl = document.getElementById('passwordSuccess');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            // Buscar usuario actual
            var userIndex = -1;
            for (var i = 0; i < users.length; i++) {
                if (users[i].username.toLowerCase() === currentAgent.toLowerCase()) {
                    userIndex = i;
                    break;
                }
            }

            if (userIndex === -1) {
                errorEl.textContent = 'Error: Usuario no encontrado';
                errorEl.style.display = 'block';
                return;
            }

            // Validar contrasena actual
            if (users[userIndex].password !== currentPass) {
                errorEl.textContent = 'La contrasena actual es incorrecta';
                errorEl.style.display = 'block';
                return;
            }

            // Validar nueva contrasena
            if (newPass.length < 4) {
                errorEl.textContent = 'La nueva contrasena debe tener al menos 4 caracteres';
                errorEl.style.display = 'block';
                return;
            }

            if (newPass !== confirmPass) {
                errorEl.textContent = 'Las contrasenas nuevas no coinciden';
                errorEl.style.display = 'block';
                return;
            }

            // Cambiar contrasena
            users[userIndex].password = newPass;
            saveUsersToFirebase();

            // Actualizar sesion
            localStorage.setItem(SESSION_KEY, JSON.stringify({
                username: users[userIndex].username,
                password: newPass
            }));

            successEl.textContent = 'Contrasena cambiada exitosamente!';
            successEl.style.display = 'block';

            setTimeout(function() {
                closePasswordModal();
            }, 1500);
        }

        // ============ SALE MODAL ============
        function openSaleModal() {
            var client = clients[currentClientIndex];
            var esAlquiler = client.tipoOperacion === 'alquiler';
            document.getElementById('saleModalTitle').textContent = esAlquiler ? 'Registro de Alquiler' : 'Registro de Venta';
            document.getElementById('precioLabel').textContent = esAlquiler ? 'Precio Alquiler *' : 'Precio Venta *';
            document.getElementById('compradorLabel').textContent = esAlquiler ? 'Nombre Inquilino *' : 'Nombre Comprador *';
            document.getElementById('fechaOperacionLabel').textContent = esAlquiler ? 'Fecha Alquiler *' : 'Fecha Venta *';
            document.getElementById('submitSaleBtn').textContent = esAlquiler ? 'Registrar Alquiler' : 'Registrar Venta';
            document.getElementById('saleModal').style.display = 'block';
        }

        function closeSaleModal() { document.getElementById('saleModal').style.display = 'none'; document.getElementById('saleForm').reset(); }

        function registerSale() {
            var moneda = document.getElementById('monedaVenta').value;
            if (!moneda) {
                alert('Por favor selecciona una moneda');
                return;
            }
            
            var fechaVenta = document.getElementById('fechaVenta').value;
            if (!fechaVenta) {
                alert('La fecha de la operaci√≥n es obligatoria');
                return;
            }
            
            var client = clients[currentClientIndex];
            
            // Asegurar que seguimiento exista
            if (!client.seguimiento) {
                client.seguimiento = {};
            }
            
            client.venta = { 
                precio: document.getElementById('precioVenta').value, 
                moneda: moneda,
                nombreComprador: document.getElementById('nombreComprador').value, 
                telefono: document.getElementById('telefonoComprador').value, 
                fecha: fechaVenta 
            };
            client.seguimiento.vendida = true;
            client.ultimoContacto = new Date().toISOString();
            
            // Auto-archivar propiedad vendida/alquilada
            client.archivado = true;
            client.fechaArchivado = new Date().toISOString();
            
            saveToFirebase();
            displayClients();
            updateArchivedCount();
            updateStats();
            updateTopAgents();
            populateMonthSelector();
            if (isAdmin) populateAgentSelector();
            closeSaleModal();
            closeModal();
            
            var monedaSymbol = moneda === 'USD' ? 'US$' : (moneda === 'UYU' ? '$' : '‚Ç¨');
            alert(client.tipoOperacion === 'alquiler' ? ' ¬°Alquiler registrado en ' + monedaSymbol + '! El cliente fue archivado autom√°ticamente.' : ' ¬°Venta registrada en ' + monedaSymbol + '! El cliente fue archivado autom√°ticamente.');
        }

        // ============ EDIT/DELETE ============
        function editClient(index) {
            editingIndex = index;
            var client = clients[index];
            document.getElementById('nombre').value = client.nombre || '';
            document.getElementById('telefono').value = client.telefono || '';
            
            // Asegurar que tipoOperacion sea v√°lido
            var tipoOp = client.tipoOperacion;
            if (tipoOp !== 'venta' && tipoOp !== 'alquiler') {
                tipoOp = 'venta';
            }
            document.getElementById('tipoOperacion').value = tipoOp;
            
            document.getElementById('direccion').value = client.direccion || '';
            document.getElementById('linkPropiedad').value = client.linkPropiedad || '';
            document.getElementById('nota').value = client.nota || '';
            
            // Abrir el formulario si est√° cerrado
            openFormForEdit();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function deleteClient(index) {
            if (confirm('¬øEliminar este cliente?')) {
                clients.splice(index, 1);
                saveToFirebase();
                displayClients();
                updateArchivedCount();
                updateStats();
                populateMonthSelector();
                if (isAdmin) populateAgentSelector();
            }
        }

        function resetForm() { 
            document.getElementById('clientForm').reset(); 
            editingIndex = -1; 
        }

        function toggleClientForm() {
            var container = document.getElementById('clientFormContainer');
            var btn = document.getElementById('toggleFormBtn');
            
            if (container.style.display === 'none') {
                container.style.display = 'block';
                btn.innerHTML = '‚úñÔ∏è Cerrar Formulario';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            } else {
                container.style.display = 'none';
                btn.innerHTML = '‚ûï A√±adir Cliente';
                btn.classList.remove('btn-secondary');
                btn.classList.add('btn-primary');
                resetForm();
            }
        }

        function openFormForEdit() {
            var container = document.getElementById('clientFormContainer');
            var btn = document.getElementById('toggleFormBtn');
            container.style.display = 'block';
            btn.innerHTML = '‚úñÔ∏è Cerrar Formulario';
            btn.classList.remove('btn-primary');
            btn.classList.add('btn-secondary');
        }

        function closeClientForm() {
            var container = document.getElementById('clientFormContainer');
            var btn = document.getElementById('toggleFormBtn');
            container.style.display = 'none';
            btn.innerHTML = '‚ûï A√±adir Cliente';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-primary');
        }

        // ============ STATS ============
        function switchStatsTab(tab) {
            var tabs = document.querySelectorAll('.tab');
            for (var i = 0; i < tabs.length; i++) tabs[i].classList.remove('active');
            event.target.classList.add('active');
            document.getElementById('statsGeneral').style.display = tab === 'general' ? 'block' : 'none';
            document.getElementById('statsAgent').style.display = tab === 'agent' ? 'block' : 'none';
            document.getElementById('statsMonthly').style.display = tab === 'monthly' ? 'block' : 'none';
            if (tab === 'agent' && isAdmin) { populateAgentSelector(); updateAgentsSummary(); updateAgentsLastLogin(); }
            if (tab === 'monthly' && isAdmin) { populateMonthlyAgentSelector(); }
            
            // Resetear estado de filtros de Mis Estad√≠sticas al cambiar de pesta√±a
            if (tab !== 'general') {
                statsContentVisible = false;
                currentStatsFilter = null;
                var statsContent = document.getElementById('statsContent');
                var totalCallsSection = document.getElementById('totalCallsSection');
                if (statsContent) statsContent.style.display = 'none';
                if (totalCallsSection) totalCallsSection.style.display = 'none';
                document.getElementById('filterAll').classList.remove('active');
                document.getElementById('filterVentas').classList.remove('active');
                document.getElementById('filterAlquileres').classList.remove('active');
            }
        }

        var statsContentVisible = false;
        var currentStatsFilter = null;
        
        function filterStats(tipo) {
            var statsContent = document.getElementById('statsContent');
            var totalCallsSection = document.getElementById('totalCallsSection');
            
            // Si el mismo bot√≥n est√° activo, ocultar contenido (toggle off)
            if (currentStatsFilter === tipo && statsContentVisible) {
                statsContent.style.display = 'none';
                totalCallsSection.style.display = 'none';
                statsContentVisible = false;
                currentStatsFilter = null;
                
                // Quitar clase active de todos los botones
                document.getElementById('filterAll').classList.remove('active');
                document.getElementById('filterVentas').classList.remove('active');
                document.getElementById('filterAlquileres').classList.remove('active');
                return;
            }
            
            // Mostrar contenido y activar filtro
            statsFilter = tipo;
            currentStatsFilter = tipo;
            statsContentVisible = true;
            statsContent.style.display = 'block';
            totalCallsSection.style.display = 'block';
            
            document.getElementById('filterAll').classList.toggle('active', tipo === 'all');
            document.getElementById('filterVentas').classList.toggle('active', tipo === 'venta');
            document.getElementById('filterAlquileres').classList.toggle('active', tipo === 'alquiler');
            
            // Mostrar/ocultar estadisticas segun tipo
            var soloAlquiler = tipo === 'alquiler';
            document.getElementById('rowPreTasacion').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('rowTasacionEntregada').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('rowAceptaTasacion').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('rowExclusiva').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('rowPublicadas').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('rowOtraInmobiliaria').style.display = soloAlquiler ? 'flex' : 'none';
            
            // Cambiar texto de vendidas/alquiladas
            var labelVendidas = document.getElementById('labelVendidas');
            if (tipo === 'venta') {
                labelVendidas.textContent = 'Vendidas';
            } else if (tipo === 'alquiler') {
                labelVendidas.textContent = 'Alquilados (nuestros)';
            } else {
                labelVendidas.textContent = 'Vendidas/Alquiladas';
            }
            
            updateStats();
        }

        function updateStats() {
            var llamados = 0, respuestas = 0, preTasacion = 0, tasacionEntregada = 0, aceptaTasacion = 0, exclusivas = 0, publicadas = 0, vendidas = 0, totalLlamadas = 0, otraInmobiliaria = 0;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== currentAgent) continue;
                if (statsFilter !== 'all' && client.tipoOperacion !== statsFilter) continue;
                var s = client.seguimiento;
                if (s.seLlamo === true) llamados++;
                if (s.huboRespuesta === true) respuestas++;
                if (s.aceptaPreTasacion === true && client.tipoOperacion === 'venta') preTasacion++;
                if (s.tasacionEntregada === true) tasacionEntregada++;
                if (s.aceptaTasacion === true) aceptaTasacion++;
                if (s.tipoExclusiva) exclusivas++;
                if (s.publicaste === true) publicadas++;
                if (s.vendida) vendidas++;
                if (client.tipoOperacion === 'alquiler' && s.motivoArchivo === 'alquilado_otra_inmobiliaria') otraInmobiliaria++;
                totalLlamadas += client.cantidadLlamadas || 0;
            }
            document.getElementById('statLlamado').textContent = llamados;
            document.getElementById('statRespuesta').textContent = respuestas;
            document.getElementById('statPreTasacion').textContent = preTasacion;
            document.getElementById('statTasacionEntregada').textContent = tasacionEntregada;
            document.getElementById('statAceptaTasacion').textContent = aceptaTasacion;
            document.getElementById('statExclusiva').textContent = exclusivas;
            document.getElementById('statPublicadas').textContent = publicadas;
            document.getElementById('statVendidas').textContent = vendidas;
            document.getElementById('statOtraInmobiliaria').textContent = otraInmobiliaria;
            document.getElementById('totalLlamadas').textContent = totalLlamadas;
            
            // Actualizar el TOP de agentes para todos
            updateTopAgents();
        }

        function getUniqueAgents() {
            var agents = {};
            for (var i = 0; i < clients.length; i++) { if (clients[i].agente) agents[clients[i].agente] = true; }
            return Object.keys(agents).sort();
        }

        function populateAgentSelector() {
            var selector = document.getElementById('agentSelector');
            var agents = getUniqueAgents();
            selector.innerHTML = '<option value="">Seleccionar agente...</option>';
            selector.innerHTML += '<option value="__ALL__">üìä Todos los agentes (Reporte completo)</option>';
            for (var i = 0; i < agents.length; i++) { var opt = document.createElement('option'); opt.value = agents[i]; opt.textContent = agents[i]; selector.appendChild(opt); }
        }

        function filterAgentStats(tipo) {
            agentStatsFilter = tipo;
            document.getElementById('agentFilterAll').classList.toggle('active', tipo === 'all');
            document.getElementById('agentFilterVentas').classList.toggle('active', tipo === 'venta');
            document.getElementById('agentFilterAlquileres').classList.toggle('active', tipo === 'alquiler');
            
            var soloAlquiler = tipo === 'alquiler';
            document.getElementById('agentRowTasaciones').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowExclusivas').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowNoExclusivas').style.display = soloAlquiler ? 'none' : 'flex';
            document.getElementById('agentRowPublicadas').style.display = soloAlquiler ? 'none' : 'flex';
            
            var labelVentas = document.getElementById('agentLabelVentas');
            if (tipo === 'venta') {
                labelVentas.textContent = 'Ventas';
            } else if (tipo === 'alquiler') {
                labelVentas.textContent = 'Alquileres';
            } else {
                labelVentas.textContent = 'Ventas/Alquileres';
            }
            
            updateAgentStats();
        }

        function updateAgentStats() {
            var agentName = document.getElementById('agentSelector').value;
            var content = document.getElementById('agentStatsContent');
            var filterBtns = document.getElementById('agentFilterBtns');
            var btnReporte = document.getElementById('btnReporteAgente');
            
            // Si no hay selecci√≥n, ocultar todo
            if (!agentName) { 
                content.style.display = 'none'; 
                filterBtns.style.display = 'none'; 
                if (btnReporte) btnReporte.style.display = 'none';
                return; 
            }
            
            // Mostrar bot√≥n de reporte (solo para Admin y L√≠deres)
            if (btnReporte && (isAdmin || isCurrentUserLider())) {
                btnReporte.style.display = 'block';
                if (agentName === '__ALL__') {
                    btnReporte.innerHTML = 'üìÑ Descargar Reporte de TODOS los Agentes (PDF)';
                } else {
                    btnReporte.innerHTML = 'üìÑ Descargar Reporte de ' + agentName + ' (PDF)';
                }
            }
            
            // Si es "Todos los agentes", ocultar estad√≠sticas individuales
            if (agentName === '__ALL__') {
                content.style.display = 'none';
                filterBtns.style.display = 'none';
                return;
            }
            
            content.style.display = 'block';
            filterBtns.style.display = 'flex';
            
            var clientes = 0, llamadas = 0, tasaciones = 0, exclusivas = 0, noExclusivas = 0, publicadas = 0, ventas = 0;
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== agentName) continue;
                if (agentStatsFilter !== 'all' && client.tipoOperacion !== agentStatsFilter) continue;
                clientes++;
                llamadas += client.cantidadLlamadas || 0;
                if (client.seguimiento.tasacionEntregada === true) tasaciones++;
                if (client.seguimiento.tipoExclusiva) {
                    if (client.seguimiento.tipoExclusiva === 'No Exclusiva') {
                        noExclusivas++;
                    } else {
                        exclusivas++;
                    }
                }
                if (client.seguimiento.publicaste === true) publicadas++;
                if (client.seguimiento.vendida) ventas++;
            }
            document.getElementById('agentClientes').textContent = clientes;
            document.getElementById('agentLlamadas').textContent = llamadas;
            document.getElementById('agentTasaciones').textContent = tasaciones;
            document.getElementById('agentExclusivas').textContent = exclusivas;
            document.getElementById('agentNoExclusivas').textContent = noExclusivas;
            document.getElementById('agentPublicadas').textContent = publicadas;
            document.getElementById('agentVentas').textContent = ventas;
        }
        
        function isCurrentUserLider() {
            var currentUserData = findUser(currentAgent);
            if (currentUserData && currentUserData.oficina && OFICINAS[currentUserData.oficina]) {
                return currentAgent === OFICINAS[currentUserData.oficina].lider;
            }
            return false;
        }

        function getAgentScore(agentName) {
            var llamadas = 0, tasaciones = 0, exclusivas = 0, noExclusivas = 0, ventas = 0, alquileres = 0, alquileresPublicados = 0;
            
            // Obtener el mes y a√±o actual
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (client.agente !== agentName) continue;
                
                // Contar llamada del seguimiento si seLlamo = true
                // Usar fechaCreacion o ultimoContacto como referencia de fecha
                if (client.seguimiento.seLlamo === true) {
                    var fechaRef = client.ultimoContacto || client.fechaCreacion;
                    if (fechaRef) {
                        var fechaLlamada = parseLocalDate(fechaRef.split('T')[0]);
                        if (fechaLlamada && fechaLlamada.getMonth() === currentMonth && fechaLlamada.getFullYear() === currentYear) {
                            llamadas++;
                        }
                    }
                }
                
                // Contar tasaciones del mes actual (solo ventas)
                if (client.tipoOperacion === 'venta' && client.seguimiento.tasacionEntregada === true && client.seguimiento.fechaEntrega) {
                    var fechaTas = parseLocalDate(client.seguimiento.fechaEntrega);
                    if (fechaTas && fechaTas.getMonth() === currentMonth && fechaTas.getFullYear() === currentYear) {
                        tasaciones++;
                    }
                }
                
                // Contar exclusivas y no exclusivas del mes (solo ventas)
                if (client.tipoOperacion === 'venta' && client.seguimiento.tipoExclusiva) {
                    var fechaRefExc = client.seguimiento.fechaEntrega || client.fechaCreacion;
                    if (fechaRefExc) {
                        var fechaExc = parseLocalDate(fechaRefExc.split('T')[0]);
                        if (fechaExc && fechaExc.getMonth() === currentMonth && fechaExc.getFullYear() === currentYear) {
                            if (client.seguimiento.tipoExclusiva === 'No Exclusiva') {
                                noExclusivas++;
                            } else if (client.seguimiento.tipoExclusiva === 'Exclusiva') {
                                exclusivas++;
                            }
                            // "Otra Modalidad" NO cuenta
                        }
                    }
                }
                
                // Contar alquileres publicados del mes actual (publicaste = true, no vendido)
                if (client.tipoOperacion === 'alquiler' && client.seguimiento.publicaste === true && !client.seguimiento.vendida) {
                    var fechaRefAlq = client.ultimoContacto || client.fechaCreacion;
                    if (fechaRefAlq) {
                        var fechaPub = parseLocalDate(fechaRefAlq.split('T')[0]);
                        if (fechaPub && fechaPub.getMonth() === currentMonth && fechaPub.getFullYear() === currentYear) {
                            alquileresPublicados++;
                        }
                    }
                }
                
                // Contar ventas y alquileres cerrados del mes actual
                if (client.seguimiento.vendida && client.venta && client.venta.fecha) {
                    var fechaVenta = parseLocalDate(client.venta.fecha);
                    if (fechaVenta && fechaVenta.getMonth() === currentMonth && fechaVenta.getFullYear() === currentYear) {
                        if (client.tipoOperacion === 'alquiler') {
                            alquileres++;
                        } else {
                            ventas++;
                        }
                    }
                }
            }
            
            // Nueva puntuaci√≥n:
            // Llamadas = 1 pt, Tasaciones = 5 pts, No Exclusiva = 5 pts, Exclusiva = 15 pts
            // Alquiler publicado = 5 pts, Alquiler cerrado = 25 pts, Venta = 60 pts
            var score = (llamadas * 1) + (tasaciones * 5) + (noExclusivas * 5) + (exclusivas * 15) + (alquileresPublicados * 5) + (alquileres * 25) + (ventas * 60);
            return { 
                llamadas: llamadas, 
                tasaciones: tasaciones, 
                exclusivas: exclusivas, 
                noExclusivas: noExclusivas, 
                alquileresPublicados: alquileresPublicados,
                ventas: ventas, 
                alquileres: alquileres, 
                score: score 
            };
        }

        function toggleTopStats(element) {
            var statsDiv = element.querySelector('.top-stats-detail');
            var expandIcon = element.querySelector('.top-expand-icon');
            if (statsDiv) {
                if (statsDiv.style.display === 'none') {
                    statsDiv.style.display = 'block';
                    if (expandIcon) expandIcon.textContent = '‚ñ≤';
                } else {
                    statsDiv.style.display = 'none';
                    if (expandIcon) expandIcon.textContent = '‚ñº';
                }
            }
        }

        function showPointsInfo() {
            alert(
                'üèÜ SISTEMA DE PUNTOS MENSUAL\n\n' +
                'Los puntos se calculan por actividades del mes actual:\n\n' +
                'üìû Llamadas realizadas: 1 punto c/u\n' +
                'üìã Tasaciones entregadas: 5 puntos c/u\n' +
                'üìù No Exclusiva: 5 puntos c/u\n' +
                '‚≠ê Exclusiva firmada: 15 puntos c/u\n' +
                'üîÑ Otra Modalidad: 0 puntos (no suma)\n' +
                'üì¢ Alquiler publicado: 5 puntos c/u\n' +
                'üîë Alquiler cerrado: 25 puntos c/u\n' +
                'üè† Venta cerrada: 60 puntos c/u\n\n' +
                '¬°El ranking se reinicia cada mes!'
            );
        }

        function updateTopAgents() {
            var agents = getUniqueAgents();
            var agentScores = [];
            
            for (var i = 0; i < agents.length; i++) {
                var stats = getAgentScore(agents[i]);
                agentScores.push({ name: agents[i], stats: stats });
            }
            
            agentScores.sort(function(a, b) { return b.stats.score - a.stats.score; });
            
            // Mostrar el mes actual en el t√≠tulo
            var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            var now = new Date();
            var monthDisplay = document.getElementById('topMonthDisplay');
            if (monthDisplay) {
                monthDisplay.textContent = meses[now.getMonth()] + ' ' + now.getFullYear();
            }
            
            var html = '';
            var limit = Math.min(10, agentScores.length);
            
            for (var j = 0; j < limit; j++) {
                var agent = agentScores[j];
                
                // Solo mostrar agentes con puntuaci√≥n > 0
                if (agent.stats.score === 0) continue;
                
                var posClass = '';
                var posEmoji = (j + 1) + '.';
                
                if (j === 0) { posClass = 'gold'; posEmoji = 'ü•á'; }
                else if (j === 1) { posClass = 'silver'; posEmoji = 'ü•à'; }
                else if (j === 2) { posClass = 'bronze'; posEmoji = 'ü•â'; }
                
                // Formato del detalle desplegable compacto sin espacios
                var statsLine = 'üìû' + agent.stats.llamadas + '|üìã' + agent.stats.tasaciones + '|üìù' + agent.stats.noExclusivas + '|‚≠ê' + agent.stats.exclusivas + '|üì¢' + agent.stats.alquileresPublicados + '|üîë' + agent.stats.alquileres + '|üè†' + agent.stats.ventas;
                
                html += '<div class="top-agent ' + posClass + '" onclick="toggleTopStats(this)">' +
                    '<div class="top-header-row">' +
                        '<span class="top-position">' + posEmoji + '</span>' +
                        '<span class="top-name">' + agent.name + '<span class="top-expand-icon">‚ñº</span></span>' +
                        '<span class="top-score">' + agent.stats.score + ' pts</span>' +
                    '</div>' +
                    '<div class="top-stats-detail" style="display: none;">' + statsLine + '</div>' +
                '</div>';
            }
            
            if (html === '') {
                html = '<p style="color:#666; text-align: center; padding: 20px;">No hay actividad este mes</p>';
            }
            
            // Actualizar el TOP en la vista general (visible para todos)
            var containerGeneral = document.getElementById('topAgentsGeneral');
            if (containerGeneral) {
                containerGeneral.innerHTML = html;
            }
        }

        function removeFromTop(agentName) {
            if (!isSupport) return;
            
            // Contar clientes de este agente
            var clientCount = 0;
            for (var i = 0; i < clients.length; i++) {
                if (clients[i].agente === agentName) clientCount++;
            }
            
            var action = prompt(
                '¬øQu√© deseas hacer con "' + agentName + '"?\n\n' +
                'Este agente tiene ' + clientCount + ' cliente(s).\n\n' +
                'Escribe una opci√≥n:\n' +
                '1 = Eliminar agente Y sus clientes\n' +
                '2 = Reasignar clientes a otro agente\n' +
                '3 = Cancelar'
            );
            
            if (action === '1') {
                if (!confirm('‚ö†Ô∏è ¬øEst√°s SEGURO?\n\nSe eliminar√°n ' + clientCount + ' clientes de "' + agentName + '".\n\nEsta acci√≥n NO se puede deshacer.')) {
                    return;
                }
                
                // Eliminar clientes del agente
                clients = clients.filter(function(c) { return c.agente !== agentName; });
                saveToFirebase();
                displayClients();
                updateStats();
                updateTopAgents();
                alert('‚úÖ Se eliminaron ' + clientCount + ' clientes de "' + agentName + '"');
                
            } else if (action === '2') {
                var newAgent = prompt('Escribe el nombre EXACTO del agente al que quieres reasignar los ' + clientCount + ' clientes:');
                
                if (!newAgent || newAgent.trim() === '') {
                    alert('Operaci√≥n cancelada');
                    return;
                }
                
                newAgent = newAgent.trim();
                
                // Verificar que el nuevo agente existe
                var agentExists = false;
                for (var j = 0; j < users.length; j++) {
                    if (users[j].username === newAgent) {
                        agentExists = true;
                        break;
                    }
                }
                
                if (!agentExists) {
                    if (!confirm('El agente "' + newAgent + '" no existe en el sistema.\n\n¬øDeseas reasignar los clientes de todas formas?')) {
                        return;
                    }
                }
                
                // Reasignar clientes
                var reasignados = 0;
                for (var k = 0; k < clients.length; k++) {
                    if (clients[k].agente === agentName) {
                        clients[k].agente = newAgent;
                        reasignados++;
                    }
                }
                
                saveToFirebase();
                displayClients();
                updateStats();
                updateTopAgents();
                alert('‚úÖ Se reasignaron ' + reasignados + ' clientes de "' + agentName + '" a "' + newAgent + '"');
            }
        }

        function updateAgentsSummary() {
            var agents = getUniqueAgents();
            var container = document.getElementById('agentsSummary');
            var html = '';
            for (var i = 0; i < agents.length; i++) {
                var agent = agents[i];
                var stats = getAgentScore(agent);
                html += '<div class="stat-row" style="flex-wrap: wrap; gap: 5px;">' +
                    '<span class="stat-label" style="flex: 1; min-width: 100px;">' + agent + '</span>' +
                    '<span class="stat-value" style="font-size: 0.75em; text-align: right;">üìû' + stats.llamadas + ' ¬∑ üìã' + stats.tasaciones + ' ¬∑ üìù' + stats.noExclusivas + ' ¬∑ ‚≠ê' + stats.exclusivas + ' ¬∑ üì¢' + stats.alquileresPublicados + ' ¬∑ üîë' + stats.alquileres + ' ¬∑ üè†' + stats.ventas + ' ¬∑ <strong>' + stats.score + 'pts</strong></span>' +
                '</div>';
            }
            container.innerHTML = html || '<p style="color:#666">No hay agentes</p>';
        }

        function populateMonthlyAgentSelector() {
            var selector = document.getElementById('monthlyAgentSelector');
            var agents = getUniqueAgents();
            selector.innerHTML = '<option value="all">Todos los agentes</option>';
            for (var i = 0; i < agents.length; i++) {
                var opt = document.createElement('option');
                opt.value = agents[i];
                opt.textContent = agents[i];
                selector.appendChild(opt);
            }
        }

        function updateAgentsLastLogin() {
            var container = document.getElementById('agentsLastLogin');
            var html = '';
            
            // Ordenar usuarios por ultima sesion (mas reciente primero)
            var sortedUsers = users.slice().sort(function(a, b) {
                var dateA = a.lastLogin ? new Date(a.lastLogin) : new Date(0);
                var dateB = b.lastLogin ? new Date(b.lastLogin) : new Date(0);
                return dateB - dateA;
            });
            
            for (var i = 0; i < sortedUsers.length; i++) {
                var user = sortedUsers[i];
                var lastLogin = user.lastLogin ? formatDateTime(user.lastLogin) : 'Nunca';
                var isOnline = user.username === currentAgent ? ' (En linea)' : '';
                var statusClass = user.username === currentAgent ? 'color: #28a745; font-weight: bold;' : '';
                html += '<div class="stat-row"><span class="stat-label">' + user.username + isOnline + '</span><span class="stat-value" style="font-size: 0.85em; ' + statusClass + '">' + lastLogin + '</span></div>';
            }
            container.innerHTML = html || '<p style="color:#666">No hay agentes registrados</p>';
        }

        function formatDateTime(isoString) {
            var date = new Date(isoString);
            var dia = String(date.getDate()).padStart(2, '0');
            var mes = String(date.getMonth() + 1).padStart(2, '0');
            var anio = date.getFullYear();
            var hora = String(date.getHours()).padStart(2, '0');
            var min = String(date.getMinutes()).padStart(2, '0');
            return dia + '/' + mes + '/' + anio + ' ' + hora + ':' + min;
        }

        function populateMonthSelector() {
            var selector = document.getElementById('mesSelector');
            var mesesUnicos = {};
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (!isAdmin && client.agente !== currentAgent) continue;
                if (client.fechaCreacion) { var f = new Date(client.fechaCreacion); mesesUnicos[f.getFullYear() + '-' + String(f.getMonth() + 1).padStart(2, '0')] = true; }
                if (client.historialLlamadas) { for (var j = 0; j < client.historialLlamadas.length; j++) { if (client.historialLlamadas[j].fecha) { var fc = new Date(client.historialLlamadas[j].fecha); mesesUnicos[fc.getFullYear() + '-' + String(fc.getMonth() + 1).padStart(2, '0')] = true; } } }
                if (client.venta && client.venta.fecha) { var fv = new Date(client.venta.fecha); mesesUnicos[fv.getFullYear() + '-' + String(fv.getMonth() + 1).padStart(2, '0')] = true; }
                if (client.fechaArchivado) { var fa = new Date(client.fechaArchivado); mesesUnicos[fa.getFullYear() + '-' + String(fa.getMonth() + 1).padStart(2, '0')] = true; }
            }
            var mesesArray = Object.keys(mesesUnicos).sort().reverse();
            selector.innerHTML = '<option value="">Seleccionar mes...</option>';
            var nombres = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            for (var k = 0; k < mesesArray.length; k++) { var parts = mesesArray[k].split('-'); var opt = document.createElement('option'); opt.value = mesesArray[k]; opt.textContent = nombres[parseInt(parts[1]) - 1] + ' ' + parts[0]; selector.appendChild(opt); }
        }

        function updateMonthlyStats() {
            var mesSeleccionado = document.getElementById('mesSelector').value;
            var statsDiv = document.getElementById('monthlyStats');
            if (!mesSeleccionado) { statsDiv.style.display = 'none'; return; }
            statsDiv.style.display = 'block';
            var parts = mesSeleccionado.split('-');
            var year = parseInt(parts[0]), month = parseInt(parts[1]);
            var clientesNuevos = 0, llamadasMes = 0, tasacionesMes = 0, ventasMes = 0, alquileresMes = 0, otraInmobiliaria = 0;
            
            var selectedAgent = isAdmin ? document.getElementById('monthlyAgentSelector').value : currentAgent;
            
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                if (selectedAgent !== 'all' && client.agente !== selectedAgent) continue;
                if (!isAdmin && client.agente !== currentAgent) continue;
                
                if (client.fechaCreacion) { var fc = parseLocalDate(client.fechaCreacion.split('T')[0]); if (fc && fc.getFullYear() === year && fc.getMonth() + 1 === month) clientesNuevos++; }
                if (client.historialLlamadas) { for (var j = 0; j < client.historialLlamadas.length; j++) { if (client.historialLlamadas[j].fecha) { var fl = parseLocalDate(client.historialLlamadas[j].fecha.split('T')[0]); if (fl && fl.getFullYear() === year && fl.getMonth() + 1 === month) llamadasMes++; } } }
                if (client.seguimiento.fechaEntrega) { var fe = parseLocalDate(client.seguimiento.fechaEntrega); if (fe && fe.getFullYear() === year && fe.getMonth() + 1 === month) tasacionesMes++; }
                
                // Contar ventas y alquileres por separado
                if (client.venta && client.venta.fecha) {
                    var fv = parseLocalDate(client.venta.fecha);
                    if (fv && fv.getFullYear() === year && fv.getMonth() + 1 === month) {
                        if (client.tipoOperacion === 'venta') {
                            ventasMes++;
                        } else if (client.tipoOperacion === 'alquiler') {
                            alquileresMes++;
                        }
                    }
                }
                
                // Contar alquileres por otra inmobiliaria
                if (client.tipoOperacion === 'alquiler' && client.seguimiento.motivoArchivo === 'alquilado_otra_inmobiliaria') {
                    if (client.fechaArchivado) {
                        var fa = parseLocalDate(client.fechaArchivado.split('T')[0]);
                        if (fa && fa.getFullYear() === year && fa.getMonth() + 1 === month) otraInmobiliaria++;
                    }
                }
            }
            document.getElementById('monthlyNewClients').textContent = clientesNuevos;
            document.getElementById('monthlyCallsMade').textContent = llamadasMes;
            document.getElementById('monthlyTasaciones').textContent = tasacionesMes;
            document.getElementById('monthlyVentas').textContent = ventasMes;
            document.getElementById('monthlyAlquileres').textContent = alquileresMes;
            document.getElementById('monthlyOtraInmobiliaria').textContent = otraInmobiliaria;
        }

        function showSaveIndicator() {
            var ind = document.getElementById('saveIndicator');
            ind.style.display = 'block';
            setTimeout(function() { ind.style.display = 'none'; }, 2000);
        }

        function downloadBackup() {
            var data = JSON.stringify({ clients: clients, users: users }, null, 2);
            var blob = new Blob([data], { type: 'application/json' });
            var url = URL.createObjectURL(blob);
            var link = document.createElement('a');
            link.href = url;
            link.download = 'backup_' + new Date().toISOString().split('T')[0] + '.json';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            alert('Respaldo descargado');
        }

        function uploadBackup(event) {
            var file = event.target.files[0];
            if (!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    if (confirm('¬øCargar respaldo? Reemplazar√° los datos actuales.')) {
                        if (data.clients) clients = data.clients;
                        else if (Array.isArray(data)) clients = data;
                        if (data.users) users = data.users;
                        migrateOldData();
                        saveToFirebase();
                        saveUsersToFirebase();
                        displayClients();
                        updateStats();
                        populateMonthSelector();
                        if (isAdmin) populateAgentSelector();
                        alert(' Respaldo cargado');
                    }
                } catch (err) { alert(' Error al leer archivo'); }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        window.onclick = function(event) {
            var modals = ['followUpModal', 'saleModal', 'callModal', 'passwordModal', 'supportInboxModal', 'quickCallModal', 'userManagementModal', 'editUserModal', 'topManagementModal'];
            for (var i = 0; i < modals.length; i++) { var modal = document.getElementById(modals[i]); if (event.target === modal) { modal.style.display = 'none'; if (modals[i] !== 'callModal') currentClientIndex = -1; } }
        }

        // ============ SOPORTE T√âCNICO ============
        function toggleSupportChat() {
            var chat = document.getElementById('supportChat');
            chat.classList.toggle('show');
            if (chat.classList.contains('show')) {
                renderMySupportMessages();
            }
        }

        function sendSupportMessage() {
            var input = document.getElementById('supportMessageInput');
            var message = input.value.trim();
            if (!message) return;

            var newMessage = {
                id: Date.now(),
                from: currentAgent,
                fromCedula: getCurrentUserCedula(),
                message: message,
                timestamp: new Date().toISOString(),
                read: false,
                replies: []
            };

            supportMessages.push(newMessage);
            saveSupportMessages();
            input.value = '';
            renderMySupportMessages();
        }

        function getCurrentUserCedula() {
            var user = findUser(currentAgent);
            return user ? (user.cedula || 'N/A') : 'N/A';
        }

        function renderMySupportMessages() {
            var container = document.getElementById('supportChatMessages');
            var html = '<div class="support-message received"><div>¬°Hola! Soy el soporte t√©cnico. ¬øEn qu√© puedo ayudarte?</div><div class="support-message-time">Sistema</div></div>';
            
            var myMessages = supportMessages.filter(function(m) { return m.from === currentAgent; });
            
            for (var i = 0; i < myMessages.length; i++) {
                var msg = myMessages[i];
                var time = new Date(msg.timestamp).toLocaleString('es-ES');
                html += '<div class="support-message sent"><div>' + msg.message + '</div><div class="support-message-time">' + time + '</div></div>';
                
                // Mostrar respuestas
                if (msg.replies) {
                    for (var j = 0; j < msg.replies.length; j++) {
                        var reply = msg.replies[j];
                        var replyTime = new Date(reply.timestamp).toLocaleString('es-ES');
                        html += '<div class="support-message received"><div>' + reply.message + '</div><div class="support-message-time">Soporte - ' + replyTime + '</div></div>';
                    }
                }
            }
            
            container.innerHTML = html;
            container.scrollTop = container.scrollHeight;
        }

        function saveSupportMessages() {
            if (firebaseInitialized && db) {
                db.ref('supportMessages').set(supportMessages);
            }
        }

        function updateSupportBadge() {
            if (!isSupport) return;
            var unread = supportMessages.filter(function(m) { return !m.read; }).length;
            var badge = document.getElementById('supportBadge');
            if (unread > 0) {
                badge.textContent = unread;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        }

        function openSupportInbox() {
            document.getElementById('supportInboxModal').style.display = 'block';
            renderSupportInbox();
        }

        function closeSupportInbox() {
            document.getElementById('supportInboxModal').style.display = 'none';
        }

        function renderSupportInbox() {
            var container = document.getElementById('supportInboxList');
            if (supportMessages.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No hay mensajes pendientes</p>';
                return;
            }

            var html = '';
            // Ordenar por fecha (m√°s reciente primero)
            var sorted = supportMessages.slice().sort(function(a, b) {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            for (var i = 0; i < sorted.length; i++) {
                var msg = sorted[i];
                var time = new Date(msg.timestamp).toLocaleString('es-ES');
                var statusColor = msg.read ? '#28a745' : '#dc3545';
                var statusText = msg.read ? '‚úì Le√≠do' : '‚óè Nuevo';
                
                html += '<div style="border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 10px; background: ' + (msg.read ? '#f8f9fa' : '#fff3cd') + ';">';
                html += '<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">';
                html += '<strong>' + msg.from + '</strong>';
                html += '<span style="color: ' + statusColor + '; font-size: 0.85em;">' + statusText + '</span>';
                html += '</div>';
                html += '<div style="font-size: 0.85em; color: #666; margin-bottom: 5px;">CI: ' + msg.fromCedula + ' | ' + time + '</div>';
                html += '<div style="background: white; padding: 10px; border-radius: 5px; margin-bottom: 10px;">' + msg.message + '</div>';
                
                // Mostrar respuestas
                if (msg.replies && msg.replies.length > 0) {
                    html += '<div style="margin-left: 20px; border-left: 3px solid #17a2b8; padding-left: 10px;">';
                    for (var j = 0; j < msg.replies.length; j++) {
                        var reply = msg.replies[j];
                        var replyTime = new Date(reply.timestamp).toLocaleString('es-ES');
                        html += '<div style="background: #e3f2fd; padding: 8px; border-radius: 5px; margin-bottom: 5px;"><small style="color: #666;">' + replyTime + '</small><br>' + reply.message + '</div>';
                    }
                    html += '</div>';
                }
                
                html += '<div style="display: flex; gap: 10px; margin-top: 10px;">';
                html += '<input type="text" id="reply-' + msg.id + '" placeholder="Escribir respuesta..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px;">';
                html += '<button onclick="replyToSupport(' + msg.id + ')" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">Responder</button>';
                if (!msg.read) {
                    html += '<button onclick="markAsRead(' + msg.id + ')" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">‚úì</button>';
                }
                html += '</div>';
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        function replyToSupport(msgId) {
            var input = document.getElementById('reply-' + msgId);
            var replyText = input.value.trim();
            if (!replyText) return;

            for (var i = 0; i < supportMessages.length; i++) {
                if (supportMessages[i].id === msgId) {
                    if (!supportMessages[i].replies) supportMessages[i].replies = [];
                    supportMessages[i].replies.push({
                        message: replyText,
                        timestamp: new Date().toISOString(),
                        from: 'Soporte T√©cnico'
                    });
                    supportMessages[i].read = true;
                    break;
                }
            }
            saveSupportMessages();
            renderSupportInbox();
        }

        function markAsRead(msgId) {
            for (var i = 0; i < supportMessages.length; i++) {
                if (supportMessages[i].id === msgId) {
                    supportMessages[i].read = true;
                    break;
                }
            }
            saveSupportMessages();
            renderSupportInbox();
            updateSupportBadge();
        }

        // ============ GESTI√ìN DE USUARIOS (ST) ============
        function clearSupportInbox() {
            if (!isSupport) return;
            if (!confirm('¬øEst√°s seguro de que quieres eliminar TODOS los mensajes del inbox?\n\nEsta acci√≥n no se puede deshacer.')) return;
            
            supportMessages = [];
            saveSupportMessages();
            renderSupportInbox();
            updateSupportBadge();
            alert('‚úÖ Inbox limpiado correctamente');
        }

        function openUserManagement() {
            if (!isSupport) return;
            document.getElementById('userManagementModal').style.display = 'block';
            renderUserList();
        }

        function closeUserManagement() {
            document.getElementById('userManagementModal').style.display = 'none';
        }

        function renderUserList() {
            if (!isSupport) return;
            var container = document.getElementById('userManagementList');
            var searchTerm = document.getElementById('userSearchInput').value.toLowerCase();
            
            var filteredUsers = users.filter(function(u) {
                return u.username.toLowerCase().includes(searchTerm) || 
                       (u.cedula && u.cedula.includes(searchTerm));
            });
            
            if (filteredUsers.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No se encontraron usuarios</p>';
                return;
            }
            
            var html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #f8f9fa;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Usuario</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">C√©dula</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Rol</th>';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Oficina</th>';
            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Acciones</th>';
            html += '</tr></thead><tbody>';
            
            for (var i = 0; i < filteredUsers.length; i++) {
                var user = filteredUsers[i];
                var userIndex = users.indexOf(user);
                var roleBadge = '';
                var isAdminUser = user.username === ADMIN_USER;
                var isSupportUser = user.username === SUPPORT_USER || user.role === 'support';
                
                if (isAdminUser) {
                    roleBadge = '<span style="background: #ffc107; color: #333; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">üëë ADMIN</span>';
                } else if (isSupportUser) {
                    roleBadge = '<span style="background: #17a2b8; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">üõ†Ô∏è ST</span>';
                } else {
                    roleBadge = '<span style="background: #6c757d; color: white; padding: 3px 8px; border-radius: 10px; font-size: 0.8em;">üë§ Agente</span>';
                }
                
                var oficinaNombre = 'Sin oficina';
                if (user.oficina && OFICINAS[user.oficina]) {
                    oficinaNombre = OFICINAS[user.oficina].icono + ' ' + OFICINAS[user.oficina].nombre;
                }
                
                var lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('es-ES') : 'Nunca';
                
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += '<td style="padding: 12px;">';
                html += '<div style="font-weight: bold;">' + user.username + '</div>';
                html += '<div style="font-size: 0.8em; color: #666;">√öltimo acceso: ' + lastLogin + '</div>';
                html += '</td>';
                html += '<td style="padding: 12px;">' + (user.cedula || 'N/A') + '</td>';
                html += '<td style="padding: 12px;">' + roleBadge + '</td>';
                html += '<td style="padding: 12px; font-size: 0.9em;">' + oficinaNombre + '</td>';
                html += '<td style="padding: 12px; text-align: center;">';
                
                // Permitir editar a todos, pero no eliminar al ADMIN
                html += '<button onclick="editUser(' + userIndex + ')" style="background: #ffc107; color: #333; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px;">‚úèÔ∏è</button>';
                if (!isAdminUser) {
                    html += '<button onclick="deleteUser(' + userIndex + ')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">üóëÔ∏è</button>';
                }
                
                html += '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-size: 0.85em;">';
            html += 'üìä Total de usuarios: <strong>' + users.length + '</strong>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        function editUser(index) {
            var user = users[index];
            if (!user) return;
            
            document.getElementById('editUserIndex').value = index;
            document.getElementById('editUserName').value = user.username;
            document.getElementById('editUserCedula').value = user.cedula || '';
            document.getElementById('editUserRole').value = user.role || 'agent';
            document.getElementById('editUserOficina').value = user.oficina || '';
            
            document.getElementById('editUserModal').style.display = 'block';
        }

        function closeEditUser() {
            document.getElementById('editUserModal').style.display = 'none';
        }

        function saveUserChanges() {
            var index = parseInt(document.getElementById('editUserIndex').value);
            var user = users[index];
            if (!user) return;
            
            var newName = document.getElementById('editUserName').value.trim();
            var newRole = document.getElementById('editUserRole').value;
            var newOficina = document.getElementById('editUserOficina').value;
            
            if (!newName) {
                alert('El nombre no puede estar vac√≠o');
                return;
            }
            
            // Si el nombre cambi√≥, actualizar tambi√©n los clientes asociados
            var oldName = user.username;
            if (oldName !== newName) {
                // Verificar que el nuevo nombre no exista
                for (var i = 0; i < users.length; i++) {
                    if (i !== index && users[i].username.toLowerCase() === newName.toLowerCase()) {
                        alert('Ya existe un usuario con ese nombre');
                        return;
                    }
                }
                
                // Actualizar nombre en clientes
                for (var j = 0; j < clients.length; j++) {
                    if (clients[j].agente === oldName) {
                        clients[j].agente = newName;
                    }
                }
                saveToFirebase();
            }
            
            user.username = newName;
            user.role = newRole;
            user.oficina = newOficina;
            
            saveUsersToFirebase();
            closeEditUser();
            renderUserList();
            alert('‚úÖ Usuario actualizado correctamente');
        }

        function deleteUser(index) {
            var user = users[index];
            if (!user) return;
            
            // No permitir eliminar al ADMIN
            if (user.username === ADMIN_USER) {
                alert('No puedes eliminar al administrador principal.');
                return;
            }
            
            // No permitir eliminarse a s√≠ mismo
            if (user.username === currentAgent) {
                alert('No puedes eliminar tu propia cuenta.');
                return;
            }
            
            if (!confirm('¬øEst√°s seguro de que quieres eliminar al usuario "' + user.username + '"?\n\nEsta acci√≥n no se puede deshacer.\n\nNota: Los clientes asociados a este usuario NO ser√°n eliminados.')) {
                return;
            }
            
            users.splice(index, 1);
            saveUsersToFirebase();
            renderUserList();
            alert('‚úÖ Usuario eliminado correctamente');
        }

        // ============ GESTI√ìN DEL TOP ============
        function openTopManagement() {
            if (!isSupport) return;
            document.getElementById('topManagementModal').style.display = 'block';
            renderTopManagementList();
        }

        function closeTopManagement() {
            document.getElementById('topManagementModal').style.display = 'none';
        }

        function renderTopManagementList() {
            if (!isSupport) return;
            var container = document.getElementById('topManagementList');
            
            // Obtener agentes √∫nicos de los clientes
            var agentNames = {};
            for (var i = 0; i < clients.length; i++) {
                var agentName = clients[i].agente;
                if (agentName) {
                    if (!agentNames[agentName]) {
                        agentNames[agentName] = { count: 0, ventas: 0, alquileres: 0 };
                    }
                    agentNames[agentName].count++;
                    if (clients[i].seguimiento && clients[i].seguimiento.vendida) {
                        if (clients[i].tipoOperacion === 'alquiler') {
                            agentNames[agentName].alquileres++;
                        } else {
                            agentNames[agentName].ventas++;
                        }
                    }
                }
            }
            
            var agents = Object.keys(agentNames);
            
            if (agents.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay agentes en el sistema</p>';
                return;
            }
            
            var html = '<table style="width: 100%; border-collapse: collapse;">';
            html += '<thead><tr style="background: #fff3cd;">';
            html += '<th style="padding: 10px; text-align: left; border-bottom: 2px solid #ddd;">Agente</th>';
            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Clientes</th>';
            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Ventas</th>';
            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Alquileres</th>';
            html += '<th style="padding: 10px; text-align: center; border-bottom: 2px solid #ddd;">Acciones</th>';
            html += '</tr></thead><tbody>';
            
            for (var j = 0; j < agents.length; j++) {
                var agent = agents[j];
                var data = agentNames[agent];
                var isAdminAgent = agent === ADMIN_USER;
                
                html += '<tr style="border-bottom: 1px solid #eee;">';
                html += '<td style="padding: 12px; font-weight: bold;">' + agent;
                if (isAdminAgent) html += ' <span style="color: #ffc107;">üëë</span>';
                html += '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + data.count + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + data.ventas + '</td>';
                html += '<td style="padding: 12px; text-align: center;">' + data.alquileres + '</td>';
                html += '<td style="padding: 12px; text-align: center;">';
                
                // Permitir reasignar a todos, pero no eliminar al ADMIN
                html += '<button onclick="reassignAgentClients(\'' + agent.replace(/'/g, "\\'") + '\')" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; font-size: 0.85em;">üîÑ Reasignar</button>';
                if (!isAdminAgent) {
                    html += '<button onclick="deleteAgentFromTop(\'' + agent.replace(/'/g, "\\'") + '\')" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; font-size: 0.85em;">üóëÔ∏è Eliminar</button>';
                }
                
                html += '</td>';
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            html += '<div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 5px; font-size: 0.85em;">';
            html += 'üìä Total de agentes: <strong>' + agents.length + '</strong>';
            html += '</div>';
            
            container.innerHTML = html;
        }

        function reassignAgentClients(agentName) {
            if (!isSupport) return;
            
            var clientCount = 0;
            for (var i = 0; i < clients.length; i++) {
                if (clients[i].agente === agentName) clientCount++;
            }
            
            var newAgent = prompt(
                'Reasignar ' + clientCount + ' cliente(s) de "' + agentName + '"\n\n' +
                'Escribe el nombre del nuevo agente:'
            );
            
            if (!newAgent || newAgent.trim() === '') return;
            newAgent = newAgent.trim();
            
            if (!confirm('¬øConfirmas reasignar ' + clientCount + ' cliente(s) de "' + agentName + '" a "' + newAgent + '"?')) {
                return;
            }
            
            for (var j = 0; j < clients.length; j++) {
                if (clients[j].agente === agentName) {
                    clients[j].agente = newAgent;
                }
            }
            
            saveToFirebase();
            renderTopManagementList();
            updateTopAgents();
            displayClients();
            alert('‚úÖ Clientes reasignados correctamente de "' + agentName + '" a "' + newAgent + '"');
        }

        function deleteAgentFromTop(agentName) {
            if (!isSupport) return;
            if (agentName === ADMIN_USER) {
                alert('No puedes eliminar al administrador principal.');
                return;
            }
            
            var clientCount = 0;
            for (var i = 0; i < clients.length; i++) {
                if (clients[i].agente === agentName) clientCount++;
            }
            
            if (!confirm('‚ö†Ô∏è ATENCI√ìN: Vas a eliminar "' + agentName + '" y sus ' + clientCount + ' cliente(s).\n\n¬øEst√°s seguro? Esta acci√≥n no se puede deshacer.')) {
                return;
            }
            
            if (!confirm('‚ö†Ô∏è CONFIRMACI√ìN FINAL:\n\nSe eliminar√°n permanentemente ' + clientCount + ' clientes.\n\n¬øContinuar?')) {
                return;
            }
            
            // Eliminar clientes del agente
            for (var j = clients.length - 1; j >= 0; j--) {
                if (clients[j].agente === agentName) {
                    clients.splice(j, 1);
                }
            }
            
            saveToFirebase();
            renderTopManagementList();
            updateTopAgents();
            displayClients();
            updateStats();
            alert('‚úÖ Agente "' + agentName + '" y sus clientes han sido eliminados.');
        }

        // ============ REPORTES PDF ============
        function generateAgentReport() {
            var { jsPDF } = window.jspdf;
            var doc = new jsPDF();
            
            // Obtener el agente seleccionado
            var selectedAgent = document.getElementById('agentSelector').value;
            var reportarTodos = (selectedAgent === '__ALL__' || !selectedAgent);
            
            var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            var now = new Date();
            var mesActual = meses[now.getMonth()];
            var anioActual = now.getFullYear();
            
            var agents = reportarTodos ? getUniqueAgents() : [selectedAgent];
            var reportData = [];
            
            // Recopilar datos de cada agente
            for (var i = 0; i < agents.length; i++) {
                var agentName = agents[i];
                var stats = getAgentScore(agentName);
                var agentClients = clients.filter(function(c) { return c.agente === agentName; });
                var clientesActivos = agentClients.filter(function(c) { return !c.archivado; }).length;
                var clientesArchivados = agentClients.filter(function(c) { return c.archivado; }).length;
                var totalClientes = agentClients.length;
                
                var conversiones = stats.ventas + stats.alquileres;
                var tasaConversion = totalClientes > 0 ? ((conversiones / totalClientes) * 100).toFixed(1) : 0;
                
                var rendimiento = '';
                var rendimientoColor = [0, 0, 0];
                var sugerencias = [];
                
                if (stats.score >= 100) {
                    rendimiento = 'EXCELENTE';
                    rendimientoColor = [34, 139, 34];
                } else if (stats.score >= 50) {
                    rendimiento = 'BUENO';
                    rendimientoColor = [0, 128, 0];
                } else if (stats.score >= 20) {
                    rendimiento = 'REGULAR';
                    rendimientoColor = [255, 165, 0];
                } else {
                    rendimiento = 'NECESITA MEJORAR';
                    rendimientoColor = [220, 53, 69];
                }
                
                if (stats.llamadas < 5) sugerencias.push('Aumentar volumen de llamadas (actual: ' + stats.llamadas + ')');
                if (stats.tasaciones === 0 && stats.llamadas > 5) sugerencias.push('Mejorar conversion de llamadas a tasaciones');
                if (stats.exclusivas === 0 && stats.tasaciones > 0) sugerencias.push('Trabajar en obtener mas exclusivas');
                if (stats.ventas === 0 && stats.alquileres === 0 && stats.exclusivas > 0) sugerencias.push('Enfocarse en cerrar operaciones');
                if (clientesActivos > 20) sugerencias.push('Revisar clientes activos, considerar archivar inactivos');
                if (sugerencias.length === 0) sugerencias.push('Mantener el excelente trabajo!');
                
                reportData.push({
                    nombre: agentName,
                    stats: stats,
                    totalClientes: totalClientes,
                    clientesActivos: clientesActivos,
                    clientesArchivados: clientesArchivados,
                    tasaConversion: tasaConversion,
                    rendimiento: rendimiento,
                    rendimientoColor: rendimientoColor,
                    sugerencias: sugerencias
                });
            }
            
            reportData.sort(function(a, b) { return b.stats.score - a.stats.score; });
            
            // Totales
            var totalVentas = reportData.reduce(function(sum, a) { return sum + a.stats.ventas; }, 0);
            var totalAlquileres = reportData.reduce(function(sum, a) { return sum + a.stats.alquileres; }, 0);
            var totalLlamadas = reportData.reduce(function(sum, a) { return sum + a.stats.llamadas; }, 0);
            var totalTasaciones = reportData.reduce(function(sum, a) { return sum + a.stats.tasaciones; }, 0);
            var totalExclusivas = reportData.reduce(function(sum, a) { return sum + a.stats.exclusivas; }, 0);
            
            var y = 20;
            
            // Header
            doc.setFillColor(210, 169, 77);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            var tituloReporte = reportarTodos ? 'REPORTE DE RENDIMIENTO DE AGENTES' : 'REPORTE DE RENDIMIENTO';
            doc.text(tituloReporte, 105, 15, { align: 'center' });
            doc.setFontSize(14);
            var subtitulo = reportarTodos ? mesActual + ' ' + anioActual : selectedAgent + ' - ' + mesActual + ' ' + anioActual;
            doc.text(subtitulo, 105, 25, { align: 'center' });
            doc.setFontSize(10);
            doc.text('Generado: ' + now.toLocaleString('es-ES'), 105, 32, { align: 'center' });
            
            y = 45;
            doc.setTextColor(0, 0, 0);
            
            // Resumen Ejecutivo
            doc.setFillColor(240, 240, 240);
            doc.rect(10, y, 190, 35, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(reportarTodos ? 'RESUMEN EJECUTIVO' : 'RESUMEN DEL AGENTE', 15, y + 8);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            if (reportarTodos) {
                doc.text('Total Agentes: ' + reportData.length, 15, y + 18);
            }
            doc.text('Llamadas: ' + totalLlamadas, reportarTodos ? 60 : 15, y + 18);
            doc.text('Tasaciones: ' + totalTasaciones, reportarTodos ? 105 : 60, y + 18);
            doc.text('Exclusivas: ' + totalExclusivas, reportarTodos ? 150 : 105, y + 18);
            doc.text('Ventas: ' + totalVentas, 15, y + 28);
            doc.text('Alquileres: ' + totalAlquileres, 60, y + 28);
            doc.text('Total Operaciones: ' + (totalVentas + totalAlquileres), 105, y + 28);
            
            y += 45;
            
            // TOP 3 (solo para reporte de todos)
            if (reportarTodos && reportData.length > 1) {
                doc.setFillColor(255, 215, 0);
                doc.rect(10, y, 190, 25, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text('TOP 3 AGENTES DEL MES', 105, y + 8, { align: 'center' });
            }
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            
            // TOP 3 lista (solo para reporte de todos)
            if (reportarTodos && reportData.length > 1) {
                var medals = ['1ro', '2do', '3ro'];
                for (var t = 0; t < Math.min(3, reportData.length); t++) {
                    doc.text(medals[t] + ' ' + reportData[t].nombre + ' - ' + reportData[t].stats.score + ' pts', 15 + (t * 65), y + 20);
                }
                
                y += 35;
            } else {
                y += 10;
            }
            
            // Detalle por agente
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(14);
            doc.text(reportarTodos ? 'DETALLE POR AGENTE' : 'DETALLE DEL AGENTE', 105, y, { align: 'center' });
            y += 10;
            
            for (var k = 0; k < reportData.length; k++) {
                if (y > 250) {
                    doc.addPage();
                    y = 20;
                }
                
                var agent = reportData[k];
                
                // Caja del agente
                doc.setFillColor(248, 249, 250);
                doc.setDrawColor(210, 169, 77);
                doc.rect(10, y, 190, 55, 'FD');
                
                // Nombre y rendimiento
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(12);
                doc.setTextColor(0, 0, 0);
                doc.text((k + 1) + '. ' + agent.nombre, 15, y + 8);
                
                doc.setTextColor(agent.rendimientoColor[0], agent.rendimientoColor[1], agent.rendimientoColor[2]);
                doc.text(agent.rendimiento + ' (' + agent.stats.score + ' pts)', 150, y + 8);
                
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                
                // Estad√≠sticas
                doc.text('ESTADISTICAS:', 15, y + 18);
                doc.text('Llamadas: ' + agent.stats.llamadas, 15, y + 25);
                doc.text('Tasaciones: ' + agent.stats.tasaciones, 50, y + 25);
                doc.text('Exclusivas: ' + agent.stats.exclusivas, 90, y + 25);
                doc.text('Ventas: ' + agent.stats.ventas, 130, y + 25);
                doc.text('Alquileres: ' + agent.stats.alquileres, 165, y + 25);
                
                // Cartera
                doc.text('CARTERA:', 15, y + 33);
                doc.text('Total: ' + agent.totalClientes, 15, y + 40);
                doc.text('Activos: ' + agent.clientesActivos, 50, y + 40);
                doc.text('Archivados: ' + agent.clientesArchivados, 90, y + 40);
                doc.text('Conversion: ' + agent.tasaConversion + '%', 140, y + 40);
                
                // Sugerencias
                doc.setTextColor(100, 100, 100);
                doc.text('Sugerencia: ' + agent.sugerencias[0], 15, y + 50);
                
                y += 60;
            }
            
            // Secci√≥n de An√°lisis y Recomendaciones
            if (y > 200) {
                doc.addPage();
                y = 20;
            }
            
            doc.setFillColor(255, 224, 178);
            doc.rect(10, y, 190, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text('ANALISIS Y RECOMENDACIONES', 15, y + 6);
            y += 15;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            if (reportarTodos) {
                // An√°lisis para TODOS los agentes
                var agentesExcelentes = reportData.filter(function(a) { return a.stats.score >= 100; }).length;
                var agentesBuenos = reportData.filter(function(a) { return a.stats.score >= 50 && a.stats.score < 100; }).length;
                var agentesRegulares = reportData.filter(function(a) { return a.stats.score >= 20 && a.stats.score < 50; }).length;
                var agentesBajos = reportData.filter(function(a) { return a.stats.score < 20; }).length;
                
                doc.setFont('helvetica', 'bold');
                doc.text('Distribucion del Equipo:', 15, y);
                y += 7;
                doc.setFont('helvetica', 'normal');
                
                doc.setTextColor(34, 139, 34);
                doc.text('- Rendimiento Excelente: ' + agentesExcelentes + ' agente(s)', 20, y);
                y += 6;
                doc.setTextColor(0, 128, 0);
                doc.text('- Rendimiento Bueno: ' + agentesBuenos + ' agente(s)', 20, y);
                y += 6;
                doc.setTextColor(255, 165, 0);
                doc.text('- Rendimiento Regular: ' + agentesRegulares + ' agente(s)', 20, y);
                y += 6;
                doc.setTextColor(220, 53, 69);
                doc.text('- Necesitan Mejorar: ' + agentesBajos + ' agente(s)', 20, y);
                y += 10;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Recomendaciones Generales:', 15, y);
                y += 7;
                doc.setFont('helvetica', 'normal');
                
                if (agentesBajos > 0) {
                    doc.text('- Programar capacitacion para agentes con bajo rendimiento.', 20, y);
                    y += 6;
                }
                if (totalLlamadas < reportData.length * 5) {
                    doc.text('- El equipo necesita aumentar el volumen de llamadas de prospeccion.', 20, y);
                    y += 6;
                }
                if (totalTasaciones === 0) {
                    doc.text('- Ninguna tasacion entregada este mes. Revisar proceso de conversion.', 20, y);
                    y += 6;
                }
                if (totalVentas + totalAlquileres === 0) {
                    doc.text('- No se cerraron operaciones. Enfocarse en clientes calificados.', 20, y);
                    y += 6;
                } else if (totalVentas + totalAlquileres >= 3) {
                    doc.text('- Excelente mes! Documentar las estrategias exitosas del equipo.', 20, y);
                    y += 6;
                }
                if (agentesExcelentes > 0) {
                    doc.text('- Reconocer publicamente a los agentes con mejor rendimiento.', 20, y);
                    y += 6;
                }
                doc.text('- Realizar reunion semanal de seguimiento de objetivos.', 20, y);
                y += 6;
                
            } else {
                // An√°lisis para UN agente espec√≠fico
                var agent = reportData[0];
                
                doc.setFont('helvetica', 'bold');
                doc.text('Evaluacion de ' + agent.nombre + ':', 15, y);
                y += 7;
                doc.setFont('helvetica', 'normal');
                
                // Estado general
                doc.setTextColor(agent.rendimientoColor[0], agent.rendimientoColor[1], agent.rendimientoColor[2]);
                doc.text('Estado actual: ' + agent.rendimiento + ' (' + agent.stats.score + ' puntos)', 20, y);
                y += 8;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont('helvetica', 'bold');
                doc.text('Fortalezas:', 15, y);
                y += 6;
                doc.setFont('helvetica', 'normal');
                
                var fortalezas = [];
                if (agent.stats.llamadas >= 10) fortalezas.push('Buen volumen de llamadas (' + agent.stats.llamadas + ')');
                if (agent.stats.tasaciones >= 3) fortalezas.push('Buena conversion a tasaciones (' + agent.stats.tasaciones + ')');
                if (agent.stats.exclusivas >= 2) fortalezas.push('Obtiene exclusivas (' + agent.stats.exclusivas + ')');
                if (agent.stats.ventas >= 1) fortalezas.push('Cierra ventas (' + agent.stats.ventas + ')');
                if (agent.stats.alquileres >= 1) fortalezas.push('Cierra alquileres (' + agent.stats.alquileres + ')');
                if (agent.tasaConversion >= 10) fortalezas.push('Buena tasa de conversion (' + agent.tasaConversion + '%)');
                
                if (fortalezas.length === 0) {
                    doc.text('- En desarrollo, necesita enfocarse en mejorar metricas.', 20, y);
                    y += 6;
                } else {
                    for (var f = 0; f < Math.min(3, fortalezas.length); f++) {
                        doc.text('- ' + fortalezas[f], 20, y);
                        y += 6;
                    }
                }
                
                y += 3;
                doc.setFont('helvetica', 'bold');
                doc.text('Areas de Mejora:', 15, y);
                y += 6;
                doc.setFont('helvetica', 'normal');
                
                for (var s = 0; s < agent.sugerencias.length; s++) {
                    doc.text('- ' + agent.sugerencias[s].replace('‚Ä¢ ', ''), 20, y);
                    y += 6;
                }
                
                y += 3;
                doc.setFont('helvetica', 'bold');
                doc.text('Plan de Accion Sugerido:', 15, y);
                y += 6;
                doc.setFont('helvetica', 'normal');
                
                if (agent.stats.score < 20) {
                    doc.text('1. Establecer meta de minimo 10 llamadas por semana.', 20, y);
                    y += 6;
                    doc.text('2. Acompanar en visitas con agentes experimentados.', 20, y);
                    y += 6;
                    doc.text('3. Revisar y practicar guion de llamadas.', 20, y);
                } else if (agent.stats.score < 50) {
                    doc.text('1. Aumentar seguimiento a clientes existentes.', 20, y);
                    y += 6;
                    doc.text('2. Mejorar cierre de tasaciones a exclusivas.', 20, y);
                    y += 6;
                    doc.text('3. Establecer objetivos semanales medibles.', 20, y);
                } else if (agent.stats.score < 100) {
                    doc.text('1. Mantener consistencia en las actividades.', 20, y);
                    y += 6;
                    doc.text('2. Enfocarse en cerrar operaciones pendientes.', 20, y);
                    y += 6;
                    doc.text('3. Compartir mejores practicas con el equipo.', 20, y);
                } else {
                    doc.text('1. Continuar con las estrategias actuales.', 20, y);
                    y += 6;
                    doc.text('2. Mentorear a agentes con menor rendimiento.', 20, y);
                    y += 6;
                    doc.text('3. Documentar tecnicas exitosas para el equipo.', 20, y);
                }
            }
            
            // Footer
            if (y > 270) {
                doc.addPage();
                y = 20;
            }
            doc.setFillColor(210, 169, 77);
            doc.rect(0, 280, 210, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('Gestion de Clientes - (c) 2025 Anibal Malave - Todos los derechos reservados', 105, 290, { align: 'center' });
            
            var nombreArchivo = reportarTodos ? 
                'Reporte_Todos_Agentes_' + mesActual + '_' + anioActual + '.pdf' :
                'Reporte_' + selectedAgent.replace(/\s/g, '_') + '_' + mesActual + '_' + anioActual + '.pdf';
            doc.save(nombreArchivo);
            alert('Reporte PDF descargado correctamente');
        }

        function generateMonthlyReport() {
            var { jsPDF } = window.jspdf;
            var doc = new jsPDF();
            
            var meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            var now = new Date();
            var currentMonth = now.getMonth();
            var currentYear = now.getFullYear();
            var mesActual = meses[currentMonth];
            
            // Recopilar datos del mes
            var clientesMes = [];
            var llamadasMes = [];
            var tasacionesMes = [];
            var ventasMes = [];
            var alquileresMes = [];
            
            for (var i = 0; i < clients.length; i++) {
                var client = clients[i];
                var fechaCreacion = new Date(client.fechaCreacion);
                
                if (fechaCreacion.getMonth() === currentMonth && fechaCreacion.getFullYear() === currentYear) {
                    clientesMes.push(client);
                }
                
                if (client.historialLlamadas) {
                    for (var j = 0; j < client.historialLlamadas.length; j++) {
                        var llamada = client.historialLlamadas[j];
                        if (llamada.fecha) {
                            var fechaLlamada = new Date(llamada.fecha);
                            if (fechaLlamada.getMonth() === currentMonth && fechaLlamada.getFullYear() === currentYear) {
                                llamadasMes.push({ cliente: client.nombre, agente: client.agente, fecha: llamada.fecha });
                            }
                        }
                    }
                }
                
                if (client.seguimiento && client.seguimiento.tasacionEntregada && client.seguimiento.fechaEntrega) {
                    var fechaTas = new Date(client.seguimiento.fechaEntrega);
                    if (fechaTas.getMonth() === currentMonth && fechaTas.getFullYear() === currentYear) {
                        tasacionesMes.push({ cliente: client.nombre, agente: client.agente, fecha: client.seguimiento.fechaEntrega });
                    }
                }
                
                if (client.seguimiento && client.seguimiento.vendida && client.venta && client.venta.fecha) {
                    var fechaVenta = new Date(client.venta.fecha);
                    if (fechaVenta.getMonth() === currentMonth && fechaVenta.getFullYear() === currentYear) {
                        var operacion = {
                            cliente: client.nombre,
                            agente: client.agente,
                            fecha: client.venta.fecha,
                            precio: client.venta.precio,
                            moneda: client.venta.moneda
                        };
                        if (client.tipoOperacion === 'alquiler') {
                            alquileresMes.push(operacion);
                        } else {
                            ventasMes.push(operacion);
                        }
                    }
                }
            }
            
            var y = 20;
            
            // Header
            doc.setFillColor(210, 169, 77);
            doc.rect(0, 0, 210, 35, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text('REPORTE MENSUAL DETALLADO', 105, 15, { align: 'center' });
            doc.setFontSize(14);
            doc.text(mesActual + ' ' + currentYear, 105, 25, { align: 'center' });
            doc.setFontSize(10);
            doc.text('Generado: ' + now.toLocaleString('es-ES'), 105, 32, { align: 'center' });
            
            y = 45;
            doc.setTextColor(0, 0, 0);
            
            // Resumen del Mes
            doc.setFillColor(240, 240, 240);
            doc.rect(10, y, 190, 40, 'F');
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text('RESUMEN DEL MES', 15, y + 8);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            
            doc.text('Clientes nuevos: ' + clientesMes.length, 15, y + 18);
            doc.text('Llamadas realizadas: ' + llamadasMes.length, 80, y + 18);
            doc.text('Tasaciones entregadas: ' + tasacionesMes.length, 145, y + 18);
            
            doc.setFillColor(232, 245, 233);
            doc.rect(15, y + 22, 55, 12, 'F');
            doc.setTextColor(46, 125, 50);
            doc.text('Ventas: ' + ventasMes.length, 20, y + 30);
            
            doc.setFillColor(227, 242, 253);
            doc.rect(80, y + 22, 55, 12, 'F');
            doc.setTextColor(21, 101, 192);
            doc.text('Alquileres: ' + alquileresMes.length, 85, y + 30);
            
            doc.setFillColor(255, 243, 224);
            doc.rect(145, y + 22, 50, 12, 'F');
            doc.setTextColor(230, 81, 0);
            doc.text('Total Ops: ' + (ventasMes.length + alquileresMes.length), 150, y + 30);
            
            y += 50;
            doc.setTextColor(0, 0, 0);
            
            // Indicadores
            var tasaConvLlamadas = llamadasMes.length > 0 ? ((tasacionesMes.length / llamadasMes.length) * 100).toFixed(1) : 0;
            var tasaConvTasaciones = tasacionesMes.length > 0 ? (((ventasMes.length + alquileresMes.length) / tasacionesMes.length) * 100).toFixed(1) : 0;
            
            doc.setFillColor(232, 234, 246);
            doc.rect(10, y, 190, 20, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('INDICADORES DE RENDIMIENTO', 15, y + 8);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text('Conversion Llamadas a Tasaciones: ' + tasaConvLlamadas + '%', 15, y + 16);
            doc.text('Conversion Tasaciones a Operaciones: ' + tasaConvTasaciones + '%', 110, y + 16);
            
            y += 30;
            
            // Detalle de Ventas
            if (ventasMes.length > 0) {
                doc.setFillColor(200, 230, 201);
                doc.rect(10, y, 190, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('DETALLE DE VENTAS', 15, y + 6);
                y += 12;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                for (var v = 0; v < ventasMes.length; v++) {
                    if (y > 260) { doc.addPage(); y = 20; }
                    var venta = ventasMes[v];
                    var simbolo = venta.moneda === 'USD' ? 'US$' : (venta.moneda === 'UYU' ? '$' : 'EUR');
                    doc.text((v + 1) + '. ' + venta.cliente + ' | Agente: ' + venta.agente + ' | Fecha: ' + venta.fecha + ' | Precio: ' + simbolo + ' ' + (venta.precio || 'N/A'), 15, y);
                    y += 7;
                }
                y += 5;
            }
            
            // Detalle de Alquileres
            if (alquileresMes.length > 0) {
                if (y > 240) { doc.addPage(); y = 20; }
                doc.setFillColor(187, 222, 251);
                doc.rect(10, y, 190, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('DETALLE DE ALQUILERES', 15, y + 6);
                y += 12;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                for (var a = 0; a < alquileresMes.length; a++) {
                    if (y > 260) { doc.addPage(); y = 20; }
                    var alq = alquileresMes[a];
                    var simb = alq.moneda === 'USD' ? 'US$' : (alq.moneda === 'UYU' ? '$' : 'EUR');
                    doc.text((a + 1) + '. ' + alq.cliente + ' | Agente: ' + alq.agente + ' | Fecha: ' + alq.fecha + ' | Precio: ' + simb + ' ' + (alq.precio || 'N/A'), 15, y);
                    y += 7;
                }
                y += 5;
            }
            
            // Clientes nuevos
            if (clientesMes.length > 0) {
                if (y > 220) { doc.addPage(); y = 20; }
                doc.setFillColor(255, 236, 179);
                doc.rect(10, y, 190, 8, 'F');
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text('CLIENTES NUEVOS DEL MES (' + clientesMes.length + ')', 15, y + 6);
                y += 12;
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                for (var c = 0; c < Math.min(clientesMes.length, 15); c++) {
                    if (y > 260) { doc.addPage(); y = 20; }
                    var cli = clientesMes[c];
                    doc.text((c + 1) + '. ' + cli.nombre + ' (' + (cli.tipoOperacion === 'alquiler' ? 'Alquiler' : 'Venta') + ') - Agente: ' + cli.agente, 15, y);
                    y += 6;
                }
                if (clientesMes.length > 15) {
                    doc.text('... y ' + (clientesMes.length - 15) + ' clientes mas', 15, y);
                    y += 6;
                }
                y += 5;
            }
            
            // An√°lisis y Recomendaciones
            if (y > 200) { doc.addPage(); y = 20; }
            doc.setFillColor(255, 224, 178);
            doc.rect(10, y, 190, 8, 'F');
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text('ANALISIS Y RECOMENDACIONES', 15, y + 6);
            y += 15;
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(9);
            
            // Evaluaci√≥n general del mes
            doc.setFont('helvetica', 'bold');
            doc.text('Evaluacion del Mes:', 15, y);
            y += 7;
            doc.setFont('helvetica', 'normal');
            
            var totalOps = ventasMes.length + alquileresMes.length;
            
            if (totalOps === 0) {
                doc.setTextColor(220, 53, 69);
                doc.text('- No se cerraron operaciones este mes. Situacion critica.', 20, y);
                y += 6;
            } else if (totalOps === 1) {
                doc.setTextColor(255, 165, 0);
                doc.text('- Se cerro 1 operacion. Rendimiento bajo, hay que mejorar.', 20, y);
                y += 6;
            } else if (totalOps === 2) {
                doc.setTextColor(0, 128, 0);
                doc.text('- Se cerraron 2 operaciones. Rendimiento aceptable.', 20, y);
                y += 6;
            } else {
                doc.setTextColor(34, 139, 34);
                doc.text('- Se cerraron ' + totalOps + ' operaciones. Excelente rendimiento!', 20, y);
                y += 6;
            }
            
            doc.setTextColor(0, 0, 0);
            
            if (clientesMes.length === 0) {
                doc.text('- No se captaron clientes nuevos este mes.', 20, y);
                y += 6;
            } else if (clientesMes.length < 5) {
                doc.text('- Se captaron ' + clientesMes.length + ' clientes nuevos. Volumen bajo.', 20, y);
                y += 6;
            } else {
                doc.text('- Se captaron ' + clientesMes.length + ' clientes nuevos. Buen volumen de prospeccion.', 20, y);
                y += 6;
            }
            
            // Indicadores espec√≠ficos
            if (llamadasMes.length < 10) {
                doc.text('- Volumen de llamadas bajo (' + llamadasMes.length + '). Necesita aumentar.', 20, y);
                y += 6;
            } else if (llamadasMes.length >= 30) {
                doc.text('- Excelente volumen de llamadas (' + llamadasMes.length + ').', 20, y);
                y += 6;
            } else {
                doc.text('- Volumen de llamadas aceptable (' + llamadasMes.length + ').', 20, y);
                y += 6;
            }
            
            if (tasacionesMes.length === 0 && llamadasMes.length > 10) {
                doc.text('- Muchas llamadas pero sin tasaciones. Revisar calidad de prospeccion.', 20, y);
                y += 6;
            }
            
            y += 5;
            doc.setFont('helvetica', 'bold');
            doc.text('Recomendaciones:', 15, y);
            y += 7;
            doc.setFont('helvetica', 'normal');
            
            if (totalOps === 0) {
                doc.text('1. Revisar urgentemente el pipeline de clientes activos.', 20, y);
                y += 6;
                doc.text('2. Aumentar seguimiento a prospectos con tasacion entregada.', 20, y);
                y += 6;
                doc.text('3. Realizar reunion de equipo para identificar obstaculos.', 20, y);
                y += 6;
            } else if (totalOps < 3) {
                doc.text('1. Incrementar el volumen de llamadas de prospeccion.', 20, y);
                y += 6;
                doc.text('2. Mejorar la conversion de tasaciones a exclusivas.', 20, y);
                y += 6;
                doc.text('3. Dar seguimiento mas frecuente a clientes activos.', 20, y);
                y += 6;
            } else {
                doc.text('1. Mantener las estrategias actuales que estan funcionando.', 20, y);
                y += 6;
                doc.text('2. Documentar las mejores practicas del mes.', 20, y);
                y += 6;
                doc.text('3. Reconocer el esfuerzo del equipo y celebrar los logros.', 20, y);
                y += 6;
            }
            
            if (clientesMes.length < 5) {
                doc.text('4. Intensificar estrategias de captacion de nuevos clientes.', 20, y);
                y += 6;
            }
            
            // Objetivo sugerido
            y += 5;
            doc.setFont('helvetica', 'bold');
            doc.text('Objetivo para el proximo mes:', 15, y);
            y += 7;
            doc.setFont('helvetica', 'normal');
            var objetivoOps = Math.max(3, totalOps + 1);
            var objetivoClientes = Math.max(10, clientesMes.length + 5);
            doc.text('- Cerrar al menos ' + objetivoOps + ' operaciones.', 20, y);
            y += 6;
            doc.text('- Captar al menos ' + objetivoClientes + ' clientes nuevos.', 20, y);
            y += 6;
            doc.text('- Mantener un minimo de 20 llamadas semanales por agente.', 20, y);
            
            // Footer
            doc.setFillColor(210, 169, 77);
            doc.rect(0, 280, 210, 17, 'F');
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(8);
            doc.text('Gestion de Clientes - (c) 2025 Anibal Malave - Todos los derechos reservados', 105, 290, { align: 'center' });
            
            doc.save('Reporte_Mensual_' + mesActual + '_' + currentYear + '.pdf');
            alert('Reporte PDF descargado correctamente');
        }

        // ============ PAGINACION ============
        function goToPage(page) {
            currentPage = page;
            displayClients();
        }

        function nextPage() {
            currentPage++;
            displayClients();
        }

        function prevPage() {
            currentPage--;
            displayClients();
        }

        // ============ INFORMACI√ìN DE VERSI√ìN ============
        var APP_VERSION = '2.9.1';
        var APP_BUILD_DATE = '28/12/2025';
        
        function showVersionInfo() {
            alert(
                'üè¢ Gesti√≥n de Clientes\n\n' +
                'Versi√≥n: ' + APP_VERSION + '\n' +
                '√öltima actualizaci√≥n: ' + APP_BUILD_DATE + '\n\n' +
                '¬© 2025 Anibal Malave\n' +
                'Todos los derechos reservados.'
            );
        }
    </script>

    <!-- Pie de p√°gina con versi√≥n -->
    <footer style="
        text-align: center; 
        padding: 15px; 
        margin-top: 20px; 
        color: #8B7355; 
        font-size: 0.8em;
        background: rgba(255,255,255,0.3);
        border-radius: 10px;
        max-width: 1400px;
        margin-left: auto;
        margin-right: auto;
    ">
        <span onclick="showVersionInfo()" style="cursor: pointer;" title="Ver informaci√≥n de versi√≥n">
            üè¢ Gesti√≥n de Clientes | Versi√≥n: 2.9.1 | ¬© 2025 Anibal Malave
        </span>
    </footer>
</body>
</html>
